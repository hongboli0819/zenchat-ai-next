# å®ç°å®Œç¾ç»§æ‰¿åˆ°lovableå¹³å°çš„è§„èŒƒ

ä¸€ã€é¡¹ç›®æ€»ä½“ç›®æ ‡ï¼šåšä¸€ä¸ªæ ‡å‡†çš„ã€ŒLovable å‰ç«¯åº”ç”¨ã€
æ ¸å¿ƒæ€è·¯ï¼š
	â€¢	âœ… åªåš çº¯å‰ç«¯ SPAï¼ˆReact 18 + Vite + TSï¼‰
	â€¢	âœ… æ ·å¼åªç”¨ Tailwind + HSL å˜é‡
	â€¢	âœ… UI ç»„ä»¶ç»Ÿä¸€ç”¨ shadcn-ui
	â€¢	âœ… è·¯ç”±ç»Ÿä¸€ç”¨ react-router-dom
	â€¢	âœ… æ‰€æœ‰éå‰ç«¯é€»è¾‘ï¼ˆåç«¯ã€æ•°æ®åº“ï¼‰éƒ½äº¤ç»™ Lovable Cloudï¼ˆEdge Functions + PG ç­‰ï¼‰
	â€¢	âœ… ä»£ç ç»“æ„å’Œåˆ«åè¦ä¸ Lovable ä¹ æƒ¯ä¸¥æ ¼å¯¹é½

äºŒã€åˆå§‹é¡¹ç›®æ­å»ºï¼ˆæ¨èæµç¨‹ï¼‰
å¦‚æœä½ å·²ç»æœ‰é¡¹ç›®ï¼Œåªè¦ç¡®ä¿æ”¹é€ åæ»¡è¶³è¿™äº›æ¡ä»¶å³å¯ã€‚
1. ä½¿ç”¨ Vite + React + TypeScript åˆå§‹åŒ–
npm create vite@latest your-project -- --template react-ts
cd your-project
npm install
2. å®‰è£…å¿…éœ€ä¾èµ–
# è·¯ç”±
npm install react-router-dom

# Tailwind + PostCSS + Autoprefixer
npm install -D tailwindcss postcss autoprefixer
npx tailwindcss init -p

# shadcn-ui åŠå…¶ä¾èµ–ï¼ˆå¤§è‡´ç¤ºæ„ï¼Œå…·ä½“æŒ‰å®˜æ–¹è¯´æ˜æ¥ï¼‰
npm install class-variance-authority tailwind-merge lucide-react
# ç„¶åæŒ‰ç…§ shadcn-ui çš„æ–‡æ¡£ç”Ÿæˆç»„ä»¶åˆ° src/components/ui
ç›®çš„ï¼šä¿è¯æŠ€æœ¯æ ˆå®Œå…¨ç¬¦åˆ Lovable è¦æ±‚ã€‚

ä¸‰ã€ç›®å½•ç»“æ„ï¼šä¸¥æ ¼å¯¹é½ Lovable è§„èŒƒ
ä½ çš„é¡¹ç›®ç»“æ„å»ºè®®ä¿æŒï¼š
åªè¦ä½ ä¿è¯ï¼š
	â€¢	å…¥å£ï¼šmain.tsx
	â€¢	ä¸»ç»„ä»¶ï¼šApp.tsx
	â€¢	é¡µé¢ï¼šsrc/pages/**
	â€¢	UI ç»„ä»¶ï¼šsrc/components/ui/**
	â€¢	å·¥å…· & hooksï¼šsrc/lib/ã€src/hooks/
Lovable å°±èƒ½éå¸¸ç¨³å®šåœ°è¯†åˆ«å’Œè¿è¡Œã€‚

å››ã€è·¯ç”±é…ç½®ï¼šç»Ÿä¸€ä½¿ç”¨ react-router-dom
1. åœ¨ main.tsx é‡Œå¯ç”¨ BrowserRouter
// src/main.tsx
import React from "react";
import ReactDOM from "react-dom/client";
import { BrowserRouter } from "react-router-dom";
import App from "./App";
import "./index.css";

ReactDOM.createRoot(document.getElementById("root")!).render(
  <React.StrictMode>
    <BrowserRouter>
      <App />
    </BrowserRouter>
  </React.StrictMode>
);
2. åœ¨ App.tsx ä¸­å®šä¹‰è·¯ç”±
// src/App.tsx
import { Routes, Route } from "react-router-dom";
import HomePage from "@/pages/home/HomePage";
import SettingsPage from "@/pages/settings/SettingsPage";

function App() {
  return (
    <div className="min-h-screen bg-background text-foreground">
      {/* å¯ä»¥æ”¾ä¸€ä¸ªå…¨å±€å¸ƒå±€ï¼Œæ¯”å¦‚å¯¼èˆªæ  */}
      <Routes>
        <Route path="/" element={<HomePage />} />
        <Route path="/settings" element={<SettingsPage />} />
      </Routes>
    </div>
  );
}

export default App;
	â€¢	âŒ ä¸ä½¿ç”¨ Next.js pages æˆ– app è·¯ç”±
	â€¢	âœ… å…¨éƒ¨è·¯ç”±é€»è¾‘é›†ä¸­åœ¨ react-router-dom é‡Œ

äº”ã€é¢œè‰²ç³»ç»Ÿï¼šå¿…é¡» HSL + CSS å˜é‡ + Tailwind token
ç›®æ ‡ï¼šå½»åº•æœç» text-whiteã€bg-black è¿™ç±»ç¡¬ç¼–ç é¢œè‰²ã€‚
1. åœ¨ index.css ä¸­å®šä¹‰ HSL å˜é‡
/* src/index.css */
@tailwind base;
@tailwind components;
@tailwind utilities;

:root {
  --background: 0 0% 100%;
  --foreground: 222 84% 5%;

  --primary: 222 84% 56%;
  --primary-foreground: 210 40% 98%;

  --secondary: 210 40% 96%;
  --secondary-foreground: 222 47% 11%;

  --muted: 210 40% 96%;
  --muted-foreground: 215 15% 35%;

  --border: 214 32% 91%;
  --input: 214 32% 91%;
  --ring: 222 84% 56%;
}

/* æš—è‰²æ¨¡å¼ç¤ºä¾‹ */
.dark {
  --background: 222 84% 5%;
  --foreground: 210 40% 98%;

  --primary: 222 84% 56%;
  --primary-foreground: 210 40% 98%;

  --secondary: 217 33% 17%;
  --secondary-foreground: 210 40% 98%;

  --muted: 217 33% 17%;
  --muted-foreground: 215 20% 65%;

  --border: 217 33% 17%;
  --input: 217 33% 17%;
  --ring: 222 84% 56%;
}

body {
  @apply bg-background text-foreground;
}
æ³¨æ„ï¼šå˜é‡çš„å€¼æ˜¯ â€œH S Lâ€ ä¸‰ä¸ªæ•°å­—ï¼Œä¸ç”¨ hsl()ï¼Œåœ¨ Tailwind é‡Œå†åŒ…è£…ã€‚
2. åœ¨ tailwind.config.ts ä¸­æ¥å…¥è¿™äº›å˜é‡
// tailwind.config.ts
import type { Config } from "tailwindcss";

const config: Config = {
  darkMode: ["class"],
  content: ["./index.html", "./src/**/*.{ts,tsx,js,jsx}"],
  theme: {
    extend: {
      colors: {
        background: "hsl(var(--background))",
        foreground: "hsl(var(--foreground))",
        primary: {
          DEFAULT: "hsl(var(--primary))",
          foreground: "hsl(var(--primary-foreground))",
        },
        secondary: {
          DEFAULT: "hsl(var(--secondary))",
          foreground: "hsl(var(--secondary-foreground))",
        },
        muted: {
          DEFAULT: "hsl(var(--muted))",
          foreground: "hsl(var(--muted-foreground))",
        },
        border: "hsl(var(--border))",
        input: "hsl(var(--input))",
        ring: "hsl(var(--ring))",
      },
      borderRadius: {
        lg: "0.5rem",
        md: "0.375rem",
        sm: "0.25rem",
      },
    },
  },
  plugins: [],
};

export default config;
3. åœ¨ç»„ä»¶ä¸­ä½¿ç”¨ è¯­ä¹‰ç±»å è€Œä¸æ˜¯ç¡¬ç¼–ç é¢œè‰²
// âœ… æ­£ç¡®ç”¨æ³•
<button className="bg-primary text-primary-foreground rounded-md px-4 py-2">
  ä¿å­˜
</button>

// âŒ ä¸è¦è¿™æ ·
<button className="bg-blue-500 text-white">
  ä¿å­˜
</button>

å…­ã€è·¯å¾„åˆ«åï¼šç»Ÿä¸€ä½¿ç”¨ @ æŒ‡å‘ src
1. Vite é…ç½®åˆ«å
// vite.config.ts
import { defineConfig } from "vite";
import react from "@vitejs/plugin-react-swc";
import path from "node:path";

export default defineConfig({
  plugins: [react()],
  resolve: {
    alias: {
      "@": path.resolve(__dirname, "./src"),
    },
  },
});
2. TypeScript é…ç½®åˆ«åï¼ˆä¿è¯ TS ä¹Ÿè®¤è¯†ï¼‰
// tsconfig.jsonï¼ˆåªå±•ç¤ºå…³é”®éƒ¨åˆ†ï¼‰
{
  "compilerOptions": {
    "baseUrl": ".",
    "paths": {
      "@/*": ["src/*"]
    },
    // å…¶ä»–é…ç½®ç•¥...
  }
}
3. ç»„ä»¶å¯¼å…¥ç»Ÿä¸€è¿™æ ·å†™
import { Button } from "@/components/ui/button";
import HomePage from "@/pages/home/HomePage";
import { useAuth } from "@/hooks/useAuth";
import { apiClient } from "@/lib/apiClient";
â— è·¯å¾„ä¸­ç»å¯¹ä¸è¦å†å‡ºç° ../../../components/xxx è¿™ç§å†™æ³•ã€‚

ä¸ƒã€shadcn-ui çš„ä½¿ç”¨çº¦å®š
	â€¢	æ‰€æœ‰åŸºç¡€ UI ç»„ä»¶ï¼ˆButtonã€Inputã€Dialogã€Card ç­‰ï¼‰æ”¾åœ¨ src/components/ui/
	â€¢	ä¸šåŠ¡çº§ç»„ä»¶æ”¾åœ¨ src/components/ ä¸‹å…¶ä»–æ–‡ä»¶å¤¹
	â€¢	ä½¿ç”¨æ–¹å¼ï¼š
import { Button } from "@/components/ui/button";

export function SaveButton() {
  return (
    <Button variant="default" size="sm">
      ä¿å­˜
    </Button>
  );
}
è¿™æ · Lovable åœ¨æ‰«æä½ çš„é¡¹ç›®æ—¶ï¼Œä¸€çœ¼å°±èƒ½è¯†åˆ«å‡ºä½ æ˜¯æ ‡å‡†çš„ shadcn é£æ ¼é¡¹ç›®ã€‚

å…«ã€åç«¯é€»è¾‘ï¼šå…¨éƒ¨é¢å‘ Lovable Cloud è®¾è®¡
1. ä½ çš„å‰ç«¯é¡¹ç›®é‡Œ ä¸åº”è¯¥æœ‰ï¼š
	â€¢	âŒ express()ã€fastify() ç­‰ Node æœåŠ¡å™¨
	â€¢	âŒ server.js / app.js / index.js ä¹‹ç±»çš„åç«¯å…¥å£
	â€¢	âŒ Flask / Django / SpringBoot ç­‰åç«¯å·¥ç¨‹ï¼ˆå³ä½¿åœ¨åŒä»“åº“ï¼‰
å¦‚æœä½ ç°åœ¨æœ‰è¿™äº›ï¼š
	â€¢	å»ºè®®æ‹†ä»“ï¼šå‰ç«¯ä¸€ä¸ªä»“åº“ï¼ˆLovable ç”¨ï¼‰ï¼Œåç«¯å¦ä¸€ä¸ªä»“åº“ï¼ˆç‹¬ç«‹è¿è¡Œï¼‰ï¼Œâ€¨æˆ–è€…
	â€¢	å°†åç«¯é€»è¾‘è¿ç§»åˆ° Lovable çš„ Edge Functions é‡Œã€‚
2. åœ¨å‰ç«¯é‡Œï¼Œåªä¿ç•™ã€Œè°ƒç”¨ APIã€çš„å°è£…
// src/lib/apiClient.ts
export async function getUserProfile() {
  const res = await fetch("/api/profile", {
    method: "GET",
    credentials: "include",
  });

  if (!res.ok) {
    throw new Error("Failed to fetch profile");
  }

  return res.json();
}
	â€¢	/api/profile å¯¹åº”çš„å°±æ˜¯ Lovable Cloud ä¸­çš„ Edge Function
	â€¢	API å¯†é’¥ã€æ•°æ®åº“è¿æ¥å­—ç¬¦ä¸²ç­‰æ”¾åœ¨ Lovable çš„ Secrets é‡Œï¼Œè€Œä¸æ˜¯ .env æš´éœ²åˆ°å‰ç«¯

ä¹ã€Lovable è§†è§’çš„ã€Œè¿ç§»å‹å¥½å†™æ³•ã€
åœ¨æ—¥å¸¸ç¼–ç æ—¶ï¼Œä½ å¯ä»¥åˆ»æ„éµå®ˆä»¥ä¸‹æ¨¡å¼ï¼Œä¿è¯æœªæ¥è¿ç§»æˆæœ¬æœ€ä½ï¼š
	1	é¡µé¢çº§ç»„ä»¶
	â—¦	å…¨æ”¾åœ¨ src/pages/**
	â—¦	å‘½åè§„èŒƒï¼šXxxPage.tsx
	2	å¸ƒå±€ / å¸ƒå±€ç»„ä»¶
	â—¦	å¦‚ AppLayout, DashboardLayout
	â—¦	æ”¾åœ¨ src/components/layout/ æˆ– src/pages/layouts/
	3	çŠ¶æ€ç®¡ç†
	â—¦	èƒ½ç”¨ React hooks å°±ç”¨ hooksï¼ˆuseState/useReducer/useContextï¼‰
	â—¦	å…¨å±€å¤æ‚çŠ¶æ€å¯ä»¥ç”¨ Zustand / Jotai ç­‰å‰ç«¯åº“ï¼›ä¸è¦ä¾èµ– Node ç«¯ state
	4	API è°ƒç”¨
	â—¦	å°½é‡é›†ä¸­äº src/lib/apiClient.ts / src/lib/services/**
	â—¦	ä¾¿äºæœªæ¥æŠŠåç«¯è¿ç§»æˆ Edge Functions æ—¶åªä¿®æ”¹è¿™ä¸€å±‚

åã€æœ€ç»ˆã€ŒLovable-readyã€è‡ªæ£€æ¸…å•ï¼ˆå¼ºåŒ–ç‰ˆï¼‰
åœ¨ä½ æŠŠä»“åº“ç»™ Lovable ä¹‹å‰ï¼ŒæŒ‰è¿™ä¸ª checklist æ£€æŸ¥ä¸€éï¼š
âœ… æŠ€æœ¯æ ˆ
	â€¢	ä½¿ç”¨ React 18+ + Vite + TypeScript
	â€¢	æœªä½¿ç”¨ Next.js / Angular / Vue / Svelte / åŸç”Ÿç§»åŠ¨æ¡†æ¶
	â€¢	å·²å®‰è£… react-router-dom
	â€¢	å·²é›†æˆ Tailwind CSS
	â€¢	å·²é›†æˆ shadcn-uiï¼ŒUI ç»„ä»¶ä½äº src/components/ui
âœ… ç»“æ„ & è·¯ç”±
	â€¢	é¡¹ç›®ç»“æ„ä¸è§„èŒƒç¤ºä¾‹åŸºæœ¬ä¸€è‡´ï¼ˆsrc/components, pages, hooks, lib...ï¼‰
	â€¢	main.tsx ä½¿ç”¨ <BrowserRouter> åŒ…è£¹ <App />
	â€¢	App.tsx ä¸­ç”¨ <Routes><Route /></Routes> å®šä¹‰è·¯ç”±
	â€¢	æ²¡æœ‰ä½¿ç”¨ Next.js é£æ ¼çš„ /pages æˆ– app ç›®å½•è·¯ç”±
âœ… æ ·å¼ & é¢œè‰²
	â€¢	æ‰€æœ‰é¢œè‰²åœ¨ src/index.css ä¸­ä»¥ HSL CSS å˜é‡ çš„å½¢å¼å®šä¹‰
	â€¢	tailwind.config.ts ä½¿ç”¨ hsl(var(--xxx)) æ˜ å°„ä¸º Tailwind token
	â€¢	ç»„ä»¶ä¸­æœªä½¿ç”¨ text-whiteã€bg-black ç­‰ç¡¬ç¼–ç è‰²å€¼
	â€¢	ç»„ä»¶ä¼˜å…ˆä½¿ç”¨è¯­ä¹‰åŒ–ç±»åï¼šbg-backgroundã€text-foregroundã€bg-primary ç­‰
âœ… è·¯å¾„ä¸å¯¼å…¥
	â€¢	vite.config.ts é…ç½®äº† alias: { "@": "./src" }
	â€¢	tsconfig.json ä¸­é…ç½® "@/*": ["src/*"]
	â€¢	æ‰€æœ‰å†…éƒ¨å¯¼å…¥ç»Ÿä¸€ä¸º @/xxxï¼Œæ—  ../../../ å¼ç›¸å¯¹åœ°ç‹±
âœ… åç«¯ä¸ Lovable Cloud
	â€¢	ä»“åº“ä¸­æ²¡æœ‰ç›´æ¥è¿è¡Œçš„åç«¯ï¼ˆExpressã€Flaskã€Django ç­‰ï¼‰
	â€¢	æ‰€æœ‰åç«¯é€»è¾‘éƒ½å‡†å¤‡è¿ç§»åˆ° Lovable Cloud çš„ Edge Functions
	â€¢	API è°ƒç”¨å°è£…åœ¨ src/lib/ ä¸­ï¼Œåªå…³å¿ƒ HTTP æ¥å£
	â€¢	æ‰€æœ‰ API å¯†é’¥å‡†å¤‡é€šè¿‡ Lovable Secrets ç®¡ç†ï¼Œè€Œä¸æ˜¯å†™æ­»åœ¨å‰ç«¯ä»£ç ä¸­

# Unified L-Project è§„èŒƒ
ä¸€å¥—â€œé€’å½’é€šç”¨â€çš„ä»£ç è§„èŒƒï¼šä»»ä½•ä¸€ä¸ªä»“åº“ï¼Œéƒ½å¯ä»¥åŒæ—¶ï¼š
	â€¢	âœ… ä½œä¸º Lovable å¹³å°ç›´æ¥è¿è¡Œçš„å‰ç«¯åº”ç”¨ï¼ˆL-Appï¼Œå‰ç«¯å£³å­ï¼‰
	â€¢	âœ… ä½œä¸º è¢«åˆ«çš„é¡¹ç›®è°ƒç”¨çš„çº¯å‡½æ•°æ¨¡å—ï¼ˆL-Coreï¼‰
	â€¢	âœ… åœ¨ä»“åº“å†…éƒ¨çš„ packages/ ç›®å½•ä¸­ï¼Œå‡†å¤‡å¥½æŒ‚è½½å…¶å®ƒ L-Projectï¼ˆå“ªæ€•ä¸€å¼€å§‹æ˜¯ç©ºçš„ï¼‰
ç›®æ ‡ï¼š
è®©ä¸€ä¸ªä»“åº“æ—¢æ˜¯ Lovable é¡¹ç›®ï¼Œåˆæ˜¯ä¸€å—â€œå¯ç»„åˆçš„çº¯å‡½æ•°èƒ½åŠ›â€ï¼Œâ€¨æœªæ¥å¯ä»¥é€šè¿‡ packages/ ä¸‹çš„å­é¡¹ç›®ï¼Œä¸€å±‚ä¸€å±‚å¾€ä¸Šæ‹¼è£…æ›´å¤§çš„èƒ½åŠ›ã€‚

0. æ ¸å¿ƒè§’è‰²ä¸æ¦‚å¿µ
åé¢çš„æ‰€æœ‰è§„èŒƒéƒ½å›´ç»•è¿™ 3 ä¸ªè§’è‰²å±•å¼€ã€‚
1. L-Appï¼ˆLovable App Shellï¼‰
	â€¢	æ»¡è¶³ Lovable çš„å…¨éƒ¨è¦æ±‚ï¼Œå¯ä»¥ç›´æ¥åœ¨ Lovable ä¸Šè·‘ã€‚
	â€¢	æŠ€æœ¯æ ˆï¼šReact 18 + Vite + TypeScript + Tailwind + shadcn-uiâ€¨â†’ å®Œå…¨éµå®ˆå‰é¢é‚£ä»½ã€Šå®ç°å®Œç¾ç»§æ‰¿åˆ° Lovable å¹³å°çš„è§„èŒƒã€‹ã€‚
	â€¢	æ‹¥æœ‰ï¼š
	â—¦	é¡¶å±‚ BrowserRouter
	â—¦	src/index.cssï¼ˆHSL é¢œè‰²ï¼‰
	â—¦	src/App.tsx
	â—¦	src/main.tsx
	â€¢	ä¸»è¦èŒè´£ï¼š
	â—¦	æä¾›å‰ç«¯å£³å­ï¼ˆå¯¼èˆªã€å¸ƒå±€ã€ä¸»é¢˜ï¼‰
	â—¦	æä¾›ä¸€äº›é¡µé¢ï¼ˆHomeã€Playground ç­‰ï¼‰ï¼Œç”¨äºæ‰‹åŠ¨è§¦å‘å’Œå¯è§†åŒ– Core çš„çº¯å‡½æ•°èƒ½åŠ›
å¯¹ Lovable æ¥è¯´ï¼Œå®ƒåªçœ‹ L-Appï¼šè¿™æ˜¯ä¸€ä¸ªæ ‡å‡†çš„å‰ç«¯ SPAã€‚

2. L-Coreï¼ˆçº¯å‡½æ•°æ ¸å¿ƒæ¨¡å—ï¼‰
è¿™æ˜¯ã€ŒçœŸæ­£çš„é¡¹ç›®èƒ½åŠ›ã€æ‰€åœ¨ï¼Œä¹‹åæ‰€æœ‰ L-Project ä¹‹é—´çš„é“¾æ¥ï¼Œéƒ½é è°ƒç”¨å¯¹æ–¹çš„ L-Core å‡½æ•°ã€‚
ç‰¹ç‚¹ï¼š
	â€¢	å¯å½“ä½œ NPM åŒ…è¢«ä»»æ„å®¿ä¸»é›†æˆï¼ˆåŒ…æ‹¬å…¶å®ƒ L-Projectã€Edge Functionsã€è„šæœ¬ç­‰ï¼‰ã€‚
	â€¢	åªå¯¼å‡ºçº¯å‡½æ•°å½¢æ€çš„èƒ½åŠ›ï¼šâ€¨type CoreFn<I, O> = (input: I, ctx?: CoreContext) => Promise<O> | O;
	â€¢	
	â€¢	ä¸åˆ›å»º Routerã€ä¸ä¾èµ– Reactã€ä¸åšä»»ä½• UIã€‚
	â€¢	ä¸ç›´æ¥æ“ä½œå¤–éƒ¨ä¸–ç•Œï¼ˆç½‘ç»œã€æ—¥å¿—ã€å­˜å‚¨ç­‰ï¼‰ï¼Œæ‰€æœ‰å‰¯ä½œç”¨é€šè¿‡ ctx.adapters æ³¨å…¥ï¼š
	â—¦	API è°ƒç”¨ â†’ Lovable Edge Functionsï¼ˆ/api/...ï¼‰
	â—¦	æ•°æ®è®¿é—® â†’ Supabaseï¼ˆé€šè¿‡æŠ½è±¡çš„ DbClientï¼‰
	â—¦	æ—¥å¿— / åŸ‹ç‚¹
	â—¦	é‰´æƒ
	â—¦	æ—¶é—´ã€éšæœºæ•°
	â—¦	â€¦â€¦
å¯¹å¦ä¸€ä¸ªé¡¹ç›® / åç«¯ / Edge Functions / CLI æ¥è¯´ï¼Œå®ƒåªçœ‹ L-Coreï¼šâ€¨å°±æ˜¯ä¸€ç»„ runXxx(input, ctx) çš„çº¯å‡½æ•°æ¥å£ã€‚

3. L-Projectï¼ˆç»Ÿä¸€é¡¹ç›®å½¢æ€ï¼‰
	â€¢	ä¸€ä¸ª L-Project = L-App + L-Core + é¢„ç•™çš„ packages å…¥å£ã€‚
	â€¢	åŒä¸€ä¸ªä»“åº“å¯ä»¥ï¼š
	â—¦	ä½œä¸º Lovable é¡¹ç›®éƒ¨ç½²ï¼ˆè·‘ L-Appï¼‰
	â—¦	åŒæ—¶æ‰“åŒ…å‡ºä¸€ä¸ªå‡½æ•°æ¨¡å—ï¼ˆL-Coreï¼‰ï¼Œç»™åˆ«çš„ä»“åº“ / Project è°ƒç”¨ï¼š
	â–ª	åœ¨åˆ«çš„ L-Project é‡Œï¼šimport { runProject } from "@org/my-lproject";
	â–ª	åœ¨ Edge Function / Node è„šæœ¬é‡Œï¼šåŒæ · runProject(input, ctx)
	â€¢	ä»“åº“å†…éƒ¨é¢„ç•™ packages/ï¼Œä¸“é—¨æ”¾å­ L-Projectï¼ˆæœªæ¥å¯ä»¥ä¸€ç‚¹ç‚¹å¾€é‡Œå¡åº•å±‚èƒ½åŠ›ï¼‰ã€‚
å¿ƒæ™ºæ¨¡å‹ï¼š
	â€¢	æ¯ä¸ªä»“åº“éƒ½æ˜¯ä¸€ä¸ª L-Projectã€‚
	â€¢	L-Project è‡ªå¸¦ä¸¤å±‚ä¸œè¥¿ï¼š
	1	App Shellï¼šç»™ Lovable ç”¨çš„å‰ç«¯å£³å­ï¼›
	2	Coreï¼šçº¯å‡½æ•°èƒ½åŠ›ï¼ˆrunProject + ä¸€å † runTaskXï¼‰ã€‚
	â€¢	ç›®å½•é‡Œæ°¸è¿œæœ‰ packages/ï¼Œå“ªæ€•æš‚æ—¶æ²¡æœ‰å­é¡¹ç›®ï¼Œä¹Ÿæ˜¯å¯¹â€œæœªæ¥é€’å½’â€çš„ç»“æ„æ‰¿è¯ºã€‚

1. å•ä¸ª L-Project ç›®å½•ç»“æ„è§„èŒƒï¼ˆå¸¦å›ºå®š packages åˆ†æ”¯ï¼‰
ä¸€ä¸ª L-Project ä»“åº“çš„æ¨èç»“æ„ï¼š
my-lproject/
â”œâ”€ src/
â”‚  â”œâ”€ app/                        # L-Appï¼šLovable ç”¨çš„å‰ç«¯å£³å­ï¼ˆå•ç‹¬è·‘ / é¢„è§ˆæ—¶ç”¨ï¼‰
â”‚  â”‚  â”œâ”€ AppShell.tsx             # å¸ƒå±€ã€å¯¼èˆªã€ä¸»é¢˜åˆ‡æ¢ç­‰
â”‚  â”‚  â”œâ”€ routes.tsx               # App çº§è·¯ç”±é…ç½®
â”‚  â”‚  â””â”€ pages/
â”‚  â”‚      â”œâ”€ HomePage.tsx         # é¡¹ç›® Homeï¼Œä»‹ç» / æ–‡æ¡£é“¾æ¥
â”‚  â”‚      â””â”€ PlaygroundPage.tsx   # è°ƒç”¨ core.runXxx çš„å¯è§†åŒ– playground
â”‚  â”‚
â”‚  â”œâ”€ core/                       # ğŸ”´ çº¯å‡½æ•°ç¼–æ’æ ¸å¿ƒï¼ˆçœŸæ­£çš„â€œé¡¹ç›®èƒ½åŠ›â€ï¼‰
â”‚  â”‚  â”œâ”€ index.ts                 # L-Core å¯¹å¤–å¯¼å‡ºå…¥å£ï¼ˆåº“æ¨¡å¼ï¼‰
â”‚  â”‚  â”œâ”€ pipelines/               # é¡¶å±‚ç¼–æ’å‡½æ•°ï¼ˆå¤–éƒ¨é€šå¸¸ç›´æ¥è°ƒç”¨è¿™äº›ï¼‰
â”‚  â”‚  â”‚  â”œâ”€ runProject.ts         # æ•´ä¸ªé¡¹ç›®çš„ä¸»èƒ½åŠ›ï¼šrunProject(input, ctx)
â”‚  â”‚  â”‚  â”œâ”€ runTaskA.ts
â”‚  â”‚  â”‚  â””â”€ runTaskB.ts
â”‚  â”‚  â”œâ”€ steps/                   # å†…éƒ¨å°æ­¥éª¤ï¼ˆæ›´ç»†ç²’åº¦çš„çº¯å‡½æ•°ï¼‰
â”‚  â”‚  â”‚  â”œâ”€ validateInput.ts
â”‚  â”‚  â”‚  â”œâ”€ normalizeData.ts
â”‚  â”‚  â”‚  â””â”€ integrateChildProject.ts  # å°†æ¥ç”¨æ¥è°ƒç”¨ packages ä¸‹å­ Project çš„èƒ½åŠ›
â”‚  â”‚  â”œâ”€ types/                   # è¾“å…¥ / è¾“å‡º / Context / Error ç±»å‹å®šä¹‰
â”‚  â”‚  â”‚  â”œâ”€ io.ts                 # DTOï¼šRequest / Response ç±»å‹
â”‚  â”‚  â”‚  â””â”€ context.ts            # CoreContext / Adapters ç±»å‹
â”‚  â”‚  â””â”€ adapters/                # å¯¹å¤–éƒ¨ç³»ç»Ÿçš„æ¥å£ï¼šEdge Functions / Supabase / æ—¥å¿—ç­‰
â”‚  â”‚      â”œâ”€ api.ts               # åŸºäº ctx.adapters.api å°è£…è°ƒç”¨ Lovable Edge Functions
â”‚  â”‚      â””â”€ db.ts                # æŠ½è±¡â€œæ•°æ®æŸ¥è¯¢â€å±‚ï¼ˆåº•å±‚æ˜¯ Supabaseï¼Œç”±è°ƒç”¨æ–¹æ³¨å…¥ï¼‰
â”‚  â”‚
â”‚  â”œâ”€ shared/                     # App å£³å­ + core éƒ½å¯ä»¥å¤ç”¨çš„å·¥å…·
â”‚  â”‚  â”œâ”€ lib/                     # å·¥å…·å‡½æ•°ã€é€šç”¨æ ¡éªŒã€å¸¸é‡
â”‚  â”‚  â””â”€ ui/                      # åŸºäº shadcn-ui çš„äºŒæ¬¡å°è£…ç»„ä»¶ï¼ˆä»…ç»™ app ç”¨ï¼‰
â”‚  â”‚
â”‚  â”œâ”€ index.css                   # Lovable è¦æ±‚çš„å…¨å±€ HSL + Tailwind å…¥å£
â”‚  â”œâ”€ App.tsx                     # Lovable è§†è§’çš„æ ¹ç»„ä»¶ï¼šåŒ…è£… AppShell + è·¯ç”±
â”‚  â””â”€ main.tsx                    # å…¥å£ + BrowserRouter
â”‚
â”œâ”€ packages/                      # ğŸ”´ å›ºå®šå­˜åœ¨ï¼šæ”¾å­ L-Projectï¼ˆå¯ä»¥ä¸€å¼€å§‹ä¸ºç©ºï¼‰
â”‚  â”œâ”€ lproject-foo/               # å­ L-Projectï¼ˆç»“æ„å’Œæœ¬é¡¹ç›®ä¸€æ ·ï¼Œåªæ˜¯æ›´â€œåº•å±‚â€ï¼‰
â”‚  â””â”€ lproject-bar/
â”‚
â”œâ”€ public/
â”œâ”€ index.html
â”œâ”€ tailwind.config.ts
â”œâ”€ vite.config.ts
â”œâ”€ tsconfig.json
â”œâ”€ tsconfig.build.json            # åº“æ„å»ºï¼šåªç¼–è¯‘ src/core/**
â”œâ”€ package.json
â””â”€ INTEGRATION.md                 # é›†æˆæ–‡æ¡£ï¼ˆå‡½æ•°æ¨¡å—è§†è§’ + Lovable è§†è§’ï¼‰
å…³é”®ç‚¹ï¼š
	â€¢	src/ï¼šæè¿°å½“å‰è¿™ä¸ª L-Project è‡ªå·±çš„å£³å­ + æ ¸å¿ƒèƒ½åŠ›ã€‚
	â€¢	packages/ï¼šæ°¸è¿œå­˜åœ¨ï¼Œç”¨æ¥æ”¾å°†æ¥è¦ç»„åˆè¿›æ¥çš„ã€æ›´åº•å±‚çš„ L-Projectï¼š
	â—¦	å³ä½¿ä¸€å¼€å§‹æ²¡æœ‰å­é¡¹ç›®ï¼Œä¹Ÿä¿ç•™ç©ºç›®å½•ï¼›
	â—¦	ä»¥åè¦åŠ åº•å±‚èƒ½åŠ›ï¼Œå°±åœ¨ packages/ é‡Œæ–°å»ºå­ projectï¼Œå†åœ¨ src/core/steps é‡Œé€šè¿‡å‡½æ•°é›†æˆå®ƒï¼ˆè¿™ä¸ªâ€œæ€ä¹ˆé›†æˆâ€ä¼šæ”¾åœ¨ä¸‹ä¸€ç« ã€Œå¤š Unified L-Project åµŒå¥—è§„èŒƒã€é‡Œè®²ï¼‰ã€‚
	â€¢	Lovable è§†è§’å¿…çœ‹æ–‡ä»¶ï¼ˆå’Œä¹‹å‰è§„èŒƒä¿æŒä¸€è‡´ï¼‰ï¼š
	â—¦	src/index.css, src/App.tsx, src/main.tsx, tailwind.config.ts, vite.config.ts
	â€¢	å‡½æ•°æ¨¡å—å¯¹å¤–å…¥å£ï¼š
	â—¦	src/core/index.ts â†’ å¯¼å‡º runProject / å…¶å®ƒ runTaskX å‡½æ•° + å…¬å…±ç±»å‹ã€‚

2. L-App å±‚è§„èŒƒï¼ˆå£³å­ï¼‰
è¿™ä¸€èŠ‚å’Œä½ åŸæ¥çš„ã€ŒLovable å¹³å°è§„èŒƒã€å®Œå…¨å¯¹é½ï¼Œåªæ˜¯å¼ºè°ƒä¸€ä¸‹å®ƒåªæœåŠ¡äºæœ¬é¡¹ç›®è‡ªå·±çš„ä½“éªŒã€‚
2.1 main.tsx
åªåœ¨è¿™é‡Œåˆ›å»º BrowserRouterï¼Œæ»¡è¶³ Lovable å¹³å°è¦æ±‚ï¼š
// src/main.tsx
import React from "react";
import ReactDOM from "react-dom/client";
import { BrowserRouter } from "react-router-dom";
import App from "./App";
import "./index.css";

ReactDOM.createRoot(document.getElementById("root")!).render(
  <React.StrictMode>
    <BrowserRouter>
      <App />
    </BrowserRouter>
  </React.StrictMode>
);
2.2 App.tsx
åªåšä¸¤ä»¶äº‹ï¼šå£³å­å¸ƒå±€ + è‡ªå·±é¡¹ç›®çš„é¡µé¢ã€‚
// src/App.tsx
import { Routes, Route } from "react-router-dom";
import { AppShell } from "@/app/AppShell";
import { HomePage } from "@/app/pages/HomePage";
import { PlaygroundPage } from "@/app/pages/PlaygroundPage";

function App() {
  return (
    <div className="min-h-screen bg-background text-foreground">
      <AppShell>
        <Routes>
          <Route path="/" element={<HomePage />} />
          <Route path="/playground" element={<PlaygroundPage />} />
        </Routes>
      </AppShell>
    </div>
  );
}

export default App;
é‡è¦ï¼š
	â€¢	L-App çš„è·¯ç”±åªæœåŠ¡äºã€Œæœ¬é¡¹ç›®è‡ªå·±çš„å‰ç«¯ä½“éªŒã€ã€‚
	â€¢	ä¸åœ¨è¿™é‡ŒæŒ‚åˆ«çš„ L-Project çš„é¡µé¢ï¼Œè·¨é¡¹ç›®çš„è”åŠ¨éƒ½åœ¨ Core å‡½æ•°é‡Œå®Œæˆã€‚

3. L-Core å±‚è§„èŒƒï¼ˆçº¯å‡½æ•°ç¼–æ’ï¼‰
è¿™é‡Œåªè¯´â€œå½“å‰é¡¹ç›®è‡ªå·±çš„ core é•¿å•¥æ ·â€ï¼Œå…ˆä¸å±•å¼€ packages é‡Œçš„å­ project é›†æˆç»†èŠ‚ï¼ˆé‚£æ˜¯ä¸‹ä¸€ç« çš„äº‹ï¼‰ã€‚
3.1 ç±»å‹ï¼šCoreContext / CoreFn
// src/core/types/context.ts
export interface ApiClient {
  get<T>(url: string, init?: RequestInit): Promise<T>;
  post<T>(url: string, body?: unknown, init?: RequestInit): Promise<T>;
}

export interface DbClient {
  // æŠ½è±¡â€œæŸ¥è¯¢/å†™å…¥â€èƒ½åŠ›ï¼Œåº•å±‚å®ç°å¯ä»¥æ˜¯ Supabase
  query<T>(sql: string, params?: unknown[]): Promise<T>;
}

export interface Logger {
  info: (...args: unknown[]) => void;
  warn: (...args: unknown[]) => void;
  error: (...args: unknown[]) => void;
}

export interface CoreContext {
  adapters?: {
    api?: ApiClient;   // è°ƒ Lovable Edge Functions
    db?: DbClient;     // è®¿é—® Supabaseï¼ˆé€šè¿‡è°ƒç”¨æ–¹æ³¨å…¥ï¼‰
    logger?: Logger;
    auth?: {
      getToken: () => Promise<string | null>;
      hasRole?: (role: string) => boolean;
    };
    now?: () => Date;
    random?: () => number;
  };
}
// src/core/types/io.ts
export interface RunProjectInput {
  // æ•´ä¸ªé¡¹ç›®çš„ä¸»è¾“å…¥
}

export interface RunProjectOutput {
  // ä¸»è¾“å‡ºï¼ˆç»“æœ / æŠ¥å‘Š / çŠ¶æ€ç­‰ï¼‰
}
// src/core/types/functional.ts
import type { CoreContext } from "./context";

export type CoreFn<I, O> = (input: I, ctx?: CoreContext) => Promise<O> | O;
çº¦æŸï¼š
	â€¢	CoreFn ä¸ä¾èµ– React / DOMï¼Œä¸åš UIã€‚
	â€¢	ä¸ç›´æ¥ fetch / console.log / è®¿é—® localStorage ç­‰ï¼Œè€Œæ˜¯ç”¨ ctx.adaptersã€‚
	â€¢	å°½é‡åšåˆ°ï¼šç›¸åŒ input + ctx â†’ ç›¸åŒ outputï¼Œæ–¹ä¾¿æµ‹è¯•å’Œé‡æ”¾ã€‚

3.2 Pipelinesï¼šé¡¶å±‚ runProject + å­ä»»åŠ¡
// src/core/pipelines/runProject.ts
import type { CoreFn } from "@/core/types/functional";
import type { RunProjectInput, RunProjectOutput } from "@/core/types/io";
import { validateInput } from "@/core/steps/validateInput";
import { normalizeData } from "@/core/steps/normalizeData";
// integrateChildProject ç°åœ¨å¯ä»¥å…ˆä¸å®ç°ï¼Œç­‰æœ‰å­ project å†å¡«
import { integrateChildProject } from "@/core/steps/integrateChildProject";

export const runProject: CoreFn<RunProjectInput, RunProjectOutput> = async (
  input,
  ctx
) => {
  const logger = ctx?.adapters?.logger;
  logger?.info?.("runProject:start", input);

  const valid = validateInput(input);
  const normalized = normalizeData(valid);

  // å°†æ¥è¿™é‡Œå¯ä»¥è°ƒå¤–éƒ¨ Edge Functionsã€DBã€å­ project ç­‰
  const childResult = await integrateChildProject(normalized, ctx);

  const result: RunProjectOutput = {
    // æ ¹æ® normalized + childResult ç»„è£…ç»“æœ
  };

  logger?.info?.("runProject:success", result);
  return result;
};
ä½ å¯ä»¥å†æŒ‰ä¸šåŠ¡æ‹†å‡º runTaskA.ts / runTaskB.tsï¼Œä½†å®ƒä»¬çš„å½¢çŠ¶éƒ½ç±»ä¼¼ã€‚

3.3 Core å…¥å£ï¼šsrc/core/index.ts
// src/core/index.ts

// é¡¶å±‚èƒ½åŠ›ï¼ˆè‡³å°‘æœ‰ runProjectï¼‰
export { runProject } from "./pipelines/runProject";
export type { RunProjectInput, RunProjectOutput } from "./types/io";

// å¦‚æœæœ‰å…¶å®ƒå­ä»»åŠ¡
export { runTaskA } from "./pipelines/runTaskA";
export { runTaskB } from "./pipelines/runTaskB";

// ç±»å‹å¯¼å‡º
export type {
  CoreContext,
  ApiClient,
  DbClient,
  Logger,
} from "./types/context";
export type { CoreFn } from "./types/functional";
å¤–éƒ¨ä½¿ç”¨æ—¶ï¼šâ€¨import { runProject } from "@org/my-lproject";â€¨åªçœ‹è§ä¸€å † (input, ctx) => output çš„å‡½æ•°ï¼Œä¸éœ€è¦çŸ¥é“ä½ å†…éƒ¨æœ‰æ²¡æœ‰ packages å­ projectã€‚

4. æ„å»ºä¸ä¾èµ–è§„èŒƒï¼ˆApp + Core åŒçº¿ï¼‰
4.1 package.json
{
  "name": "@org/my-lproject",
  "version": "0.1.0",
  "type": "module",
  "private": false,
  "main": "dist/index.cjs",
  "module": "dist/index.mjs",
  "types": "dist/index.d.ts",
  "exports": {
    ".": {
      "types": "./dist/index.d.ts",
      "import": "./dist/index.mjs",
      "require": "./dist/index.cjs"
    }
  },
  "sideEffects": false,
  "scripts": {
    "dev": "vite",                  // L-App å¼€å‘
    "build:app": "vite build",      // æ„å»º Lovable å‰ç«¯åº”ç”¨
    "preview": "vite preview",
    "build:lib": "tsup src/core/index.ts --dts --format esm,cjs --sourcemap --clean",
    "test": "vitest run",
    "lint": "eslint ."
  },
  "dependencies": {
    "zod": "^3.23.8"
  },
  "peerDependencies": {
    "react": ">=18.2.0",
    "react-dom": ">=18.2.0"
  },
  "devDependencies": {
    "vite": "^5.x",
    "typescript": "^5.x",
    "tsup": "^8.x",
    "@types/react": "^18.x",
    "@types/react-dom": "^18.x",
    "tailwindcss": "^3.x",
    "vitest": "^2.x",
    "@testing-library/react": "^14.x"
  }
}
	â€¢	App æ¨¡å¼ï¼švite dev / vite build â†’ Lovable ç”¨è¿™å¥—ã€‚
	â€¢	Core æ¨¡å¼ï¼šbuild:lib æ‰“åŒ…å‡º dist/ï¼Œé‡Œé¢åªæœ‰ core çš„å‡½æ•°å’Œç±»å‹ã€‚
	â€¢	packages/ é‡Œçš„å­ project å°†æ¥è‡ªå·±ä¹Ÿä¼šæœ‰å„è‡ªçš„ package.jsonï¼Œä½†è¿™å±äºå¤š project åµŒå¥—è§„èŒƒçš„èŒƒç•´ï¼Œç¨åå†è®²ã€‚
4.2 tsconfig.build.json
{
  "extends": "./tsconfig.json",
  "compilerOptions": {
    "outDir": "dist",
    "rootDir": "src/core",
    "declaration": true,
    "emitDeclarationOnly": false,
    "noEmit": false,
    "module": "ESNext",
    "target": "ES2020",
    "moduleResolution": "Bundler",
    "jsx": "react-jsx",
    "isolatedModules": true,
    "skipLibCheck": true
  },
  "include": ["src/core"]
}
åªç¼–è¯‘ src/core/**ï¼Œä¸ç®¡ App å’Œ packages é‡Œçš„å…¶å®ƒä¸œè¥¿ã€‚

5. INTEGRATION.md è¦æ±‚ï¼ˆå• Project è§†è§’ï¼‰
æ¯ä¸ª L-Project æ ¹ç›®å½•å¿…é¡»æœ‰ INTEGRATION.mdï¼Œå»ºè®®åŒ…å«ï¼š
	1	åŠŸèƒ½æ¦‚è¿°
	2	ä½œä¸º Lovable é¡¹ç›®è·‘ï¼ˆL-Appï¼‰
	â—¦	npm install
	â—¦	npm run dev / npm run build:app
	â—¦	éœ€è¦çš„ç¯å¢ƒå˜é‡ï¼ˆå¦‚æœæœ‰ï¼‰
	3	ä½œä¸ºå‡½æ•°æ¨¡å—é›†æˆï¼ˆL-Coreï¼‰
	â—¦	å¦‚ä½•å®‰è£…ï¼šnpm i @org/my-lproject
	â—¦	å¯¹å¤–ä¸»å‡½æ•°ï¼šrunProject / runTaskX çš„ç­¾åä¸ç¤ºä¾‹
	â—¦	CoreContext / adapters çš„å®šä¹‰ä¸æ³¨å…¥ç¤ºä¾‹
	4	packages ç›®å½•è¯´æ˜ï¼ˆç°åœ¨å¯ä»¥ä¸ºç©ºï¼Œå°†æ¥ä¼šç”¨æ¥æŒ‚å­ Projectï¼‰
	â—¦	å½“å‰æ˜¯å¦å·²ç»æœ‰å­ project
	â—¦	å¦‚æœæœ‰ï¼Œç®€å•å†™ä¸€ä¸‹å®ƒä»¬çš„èŒè´£ï¼ˆç»†èŠ‚ç•™ç»™â€œå¤š L-Project åµŒå¥—è§„èŒƒâ€ï¼‰
	5	å¸¸è§é—®é¢˜
	â—¦	Appï¼šReact ç‰ˆæœ¬ã€Tailwind ä¸ç”Ÿæ•ˆã€CORS ç­‰
	â—¦	Coreï¼šctx æ²¡ä¼  / adapters æ²¡æ³¨å…¥æ—¶çš„æŠ¥é”™è¯´æ˜

6. é¡¹ç›®è‡ªæ£€ Checklistï¼ˆL-App + L-Core + ç»“æ„ï¼‰
A. Lovable è§†è§’è‡ªæ£€ï¼ˆAppï¼‰
	â€¢	ä½¿ç”¨ React 18 + Vite + TypeScriptã€‚
	â€¢	ä½¿ç”¨ Tailwind + HSL é¢œè‰² + shadcn-uiã€‚
	â€¢	é¡¶å±‚ main.tsx ä½¿ç”¨ <BrowserRouter><App /></BrowserRouter>ã€‚
	â€¢	index.css ä¸­å®šä¹‰ HSL é¢œè‰²å˜é‡ï¼Œå¹¶åœ¨ tailwind.config.ts ä¸­æ˜ å°„ã€‚
	â€¢	ä½¿ç”¨ @ è·¯å¾„åˆ«åï¼ˆåœ¨ vite.config.ts ä¸ tsconfig.json ä¸­é…ç½®ï¼‰ã€‚
	â€¢	æ²¡æœ‰åç«¯æœåŠ¡å™¨ä»£ç ï¼ˆExpress / Flask / Django ç­‰ï¼‰ã€‚
B. å‡½æ•°æ¨¡å—ï¼ˆCoreï¼‰è§†è§’è‡ªæ£€
	â€¢	æœ‰ src/core/index.ts ä½œä¸ºæ¨¡å—å…¥å£ã€‚
	â€¢	build:lib èƒ½äº§å‡º dist/index.mjs, dist/index.cjs, dist/index.d.tsã€‚
	â€¢	Core å†…æ²¡æœ‰ç›´æ¥ä½¿ç”¨ React / DOM / Router / Tailwindã€‚
	â€¢	Core å‡½æ•°éµå¾ª (input, ctx) => output å½¢å¼ï¼Œå‰¯ä½œç”¨ç» ctx.adapters æ³¨å…¥ã€‚
	â€¢	sideEffects: falseï¼Œæ”¯æŒ tree-shakingã€‚
C. ç»“æ„è§†è§’è‡ªæ£€
	â€¢	ä»“åº“æ ¹ç›®å½•ä¸‹å­˜åœ¨å›ºå®šçš„ packages/ ç›®å½•ï¼Œå³ä½¿æš‚æ—¶ä¸ºç©ºã€‚
	â€¢	packages/ ä¸­çš„å­ç›®å½•ï¼ˆå¦‚æœæœ‰ï¼‰å°†æ¥éƒ½ä¼šè¢«å½“æˆå®Œæ•´çš„å­ L-Project æ¥çœ‹å¾…ï¼ˆç»“æ„å’Œå½“å‰é¡¹ç›®ç±»ä¼¼ï¼‰ã€‚
	â€¢	ç›®å‰ Unified è§„èŒƒé˜¶æ®µï¼šâ€¨æ ¸å¿ƒæ˜¯ä¿è¯ä¸»é¡¹ç›®ç»“æ„ç¨³å®šï¼Œè®©åé¢â€œå¤š L-Project åµŒå¥—è§„èŒƒâ€å¯ä»¥ç›´æ¥å¾€è¿™å¥—ç»“æ„ä¸Šå åŠ ã€‚

7. å°ç»“ï¼ˆè¿™ç‰ˆ Unified L-Project åšåˆ°çš„äº‹ï¼‰
è¿™æ¬¡çš„ç‰ˆæœ¬ï¼Œä½ è¦çš„å‡ ä¸ªç‚¹å·²ç»å…¨éƒ¨é”æ­»åœ¨ç»“æ„é‡Œï¼š
	â€¢	âœ… ä¸€ä¸ªä»“åº“ = Lovable å‰ç«¯å£³å­ï¼ˆsrc/app + App.tsx + main.tsxï¼‰
	â—¦	çº¯å‡½æ•°æ ¸å¿ƒï¼ˆsrc/core/**ï¼‰ã€‚
	â€¢	âœ… å³ä½¿ç°åœ¨æ²¡æœ‰ä»»ä½•å­ projectï¼Œä¹Ÿå›ºå®šå­˜åœ¨ packages/ ç›®å½•ï¼Œä¸ºæœªæ¥é€’å½’åšå¥½ä½å­ã€‚
	â€¢	âœ… æ‰€æœ‰çœŸæ­£çš„ä¸šåŠ¡èƒ½åŠ›éƒ½æ²‰åˆ° L-Core é‡Œï¼Œç»Ÿä¸€æ˜¯ (input, ctx) => output çš„å‡½æ•°ã€‚
	â€¢	âœ… ä¸ Lovable Edge Functions / Supabase çš„å…³ç³»ï¼Œé€šè¿‡ ctx.adapters.api / ctx.adapters.db æŠ½è±¡ï¼Œä¸åœ¨ core é‡Œç»‘æ­»å®ç°ã€‚
	â€¢	âœ… ç°åœ¨è¿™ç« åªè®²â€œå•ä¸ª L-Project é•¿ä»€ä¹ˆæ ·ã€æ€ä¹ˆé•¿å¾—ç»Ÿä¸€â€ï¼Œâ€¨è‡³äºã€Œpackages é‡Œçš„å­ L-Project æ€ä¹ˆè®¾è®¡ã€æ€ä¹ˆè¢« core/steps/integrateChildProject.ts è°ƒç”¨ã€

# å¤šUnified L-Project åµŒå¥—è§„èŒƒ
my-lproject/
â”œâ”€ src/
â”‚  â”œâ”€ app/                        # L-Appï¼šLovable ç”¨çš„å‰ç«¯å£³å­ï¼ˆå•ç‹¬è·‘ / é¢„è§ˆæ—¶ç”¨ï¼‰
â”‚  â”‚  â”œâ”€ AppShell.tsx             # å¸ƒå±€ã€å¯¼èˆªã€ä¸»é¢˜åˆ‡æ¢ç­‰
â”‚  â”‚  â”œâ”€ routes.tsx               # App çº§è·¯ç”±é…ç½®
â”‚  â”‚  â””â”€ pages/
â”‚  â”‚      â”œâ”€ HomePage.tsx         # é¡¹ç›® Homeï¼Œä»‹ç» / æ–‡æ¡£é“¾æ¥
â”‚  â”‚      â””â”€ PlaygroundPage.tsx   # è°ƒç”¨ core.runXxx çš„å¯è§†åŒ– playground
â”‚  â”‚
â”‚  â”œâ”€ core/                       # ğŸ”´ çº¯å‡½æ•°ç¼–æ’æ ¸å¿ƒï¼ˆçœŸæ­£çš„â€œé¡¹ç›®èƒ½åŠ›â€ï¼‰
â”‚  â”‚  â”œâ”€ index.ts                 # L-Core å¯¹å¤–å¯¼å‡ºå…¥å£ï¼ˆåº“æ¨¡å¼ï¼‰
â”‚  â”‚  â”œâ”€ pipelines/               # é¡¶å±‚ç¼–æ’å‡½æ•°ï¼ˆå¤–éƒ¨é€šå¸¸ç›´æ¥è°ƒç”¨è¿™äº›ï¼‰
â”‚  â”‚  â”‚  â”œâ”€ runProject.ts         # æ•´ä¸ªé¡¹ç›®çš„ä¸»èƒ½åŠ›ï¼šrunProject(input, ctx)
â”‚  â”‚  â”‚  â”œâ”€ runTaskA.ts
â”‚  â”‚  â”‚  â””â”€ runTaskB.ts
â”‚  â”‚  â”œâ”€ steps/                   # å†…éƒ¨å°æ­¥éª¤ï¼ˆæ›´ç»†ç²’åº¦çš„çº¯å‡½æ•°ï¼‰
â”‚  â”‚  â”‚  â”œâ”€ validateInput.ts
â”‚  â”‚  â”‚  â”œâ”€ normalizeData.ts
â”‚  â”‚  â”‚  â””â”€ integrateChildProject.ts  # å°†æ¥ç”¨æ¥è°ƒç”¨ packages ä¸‹å­ Project çš„èƒ½åŠ›
â”‚  â”‚  â”œâ”€ types/                   # è¾“å…¥ / è¾“å‡º / Context / Error ç±»å‹å®šä¹‰
â”‚  â”‚  â”‚  â”œâ”€ io.ts                 # DTOï¼šRequest / Response ç±»å‹
â”‚  â”‚  â”‚  â””â”€ context.ts            # CoreContext / Adapters ç±»å‹
â”‚  â”‚  â””â”€ adapters/                # å¯¹å¤–éƒ¨ç³»ç»Ÿçš„æ¥å£ï¼šEdge Functions / Supabase / æ—¥å¿—ç­‰
â”‚  â”‚      â”œâ”€ api.ts               # åŸºäº ctx.adapters.api å°è£…è°ƒç”¨ Lovable Edge Functions
â”‚  â”‚      â””â”€ db.ts                # æŠ½è±¡â€œæ•°æ®æŸ¥è¯¢â€å±‚ï¼ˆåº•å±‚æ˜¯ Supabaseï¼Œç”±è°ƒç”¨æ–¹æ³¨å…¥ï¼‰
â”‚  â”‚
â”‚  â”œâ”€ shared/                     # App å£³å­ + core éƒ½å¯ä»¥å¤ç”¨çš„å·¥å…·
â”‚  â”‚  â”œâ”€ lib/                     # å·¥å…·å‡½æ•°ã€é€šç”¨æ ¡éªŒã€å¸¸é‡
â”‚  â”‚  â””â”€ ui/                      # åŸºäº shadcn-ui çš„äºŒæ¬¡å°è£…ç»„ä»¶ï¼ˆä»…ç»™ app ç”¨ï¼‰
â”‚  â”‚
â”‚  â”œâ”€ index.css                   # Lovable è¦æ±‚çš„å…¨å±€ HSL + Tailwind å…¥å£
â”‚  â”œâ”€ App.tsx                     # Lovable è§†è§’çš„æ ¹ç»„ä»¶ï¼šåŒ…è£… AppShell + è·¯ç”±
â”‚  â””â”€ main.tsx                    # å…¥å£ + BrowserRouter
â”‚
â”œâ”€ packages/                      # ğŸ”´ å›ºå®šå­˜åœ¨ï¼šæ”¾å­ L-Projectï¼ˆå¯ä»¥ä¸€å¼€å§‹ä¸ºç©ºï¼‰
â”‚  â”œâ”€ lproject-foo/               # å­ L-Projectï¼ˆç»“æ„å’Œæœ¬é¡¹ç›®ä¸€æ ·ï¼Œåªæ˜¯æ›´â€œåº•å±‚â€ï¼‰
â”‚  â””â”€ lproject-bar/
â”‚
â”œâ”€ public/
â”œâ”€ index.html
â”œâ”€ tailwind.config.ts
â”œâ”€ vite.config.ts
â”œâ”€ tsconfig.json
â”œâ”€ tsconfig.build.json            # åº“æ„å»ºï¼šåªç¼–è¯‘ src/core/**
â”œâ”€ package.json
â””â”€ INTEGRATION.md                 # é›†æˆæ–‡æ¡£ï¼ˆå‡½æ•°æ¨¡å—è§†è§’ + Lovable è§†è§’ï¼‰

å¤š L-Project é€’å½’åµŒå¥—è§„èŒƒ
1. è§’è‰²å…³ç³»å…ˆè¯´æ¸…æ¥š
åœ¨è¿™æ£µæ ‘é‡Œï¼Œæœ‰ä¸‰ç§â€œå±‚çº§â€ï¼š
	1	é¡¶å±‚ L-Projectï¼ˆå½“å‰è¿™ä¸ª my-lprojectï¼‰
	â—¦	è‡ªå·±æœ‰ src/appï¼ˆå£³å­ï¼‰+ src/coreï¼ˆä¸»èƒ½åŠ›ï¼‰ã€‚
	â—¦	å¯¹å¤–ï¼šæš´éœ² src/core/index.ts é‡Œçš„ runProject ç­‰ã€‚
	2	å­ L-Projectï¼ˆpackages/ ä¸‹çš„æ¯ä¸€ä¸ªï¼‰*
	â—¦	ä¹Ÿæ˜¯å®Œæ•´çš„ L-Projectï¼Œåªæ˜¯è¢«å½“å‰ project å½“ä½œâ€œä¸‹æ¸¸èƒ½åŠ›å—â€ã€‚
	â—¦	æ¯ä¸ªå­é¡¹ç›®å†…éƒ¨ä¹Ÿé•¿è¿™æ ·ï¼ˆç®€åŒ–ç‰ˆï¼‰ï¼šâ€¨my-lproject/
	â—¦	â””â”€ packages/
	â—¦	   â””â”€ lproject-foo/
	â—¦	      â”œâ”€ src/
	â—¦	      â”‚  â”œâ”€ app/        # å¯æœ‰å¯æ— ï¼Œä¸»è¦æ˜¯è‡ªå·±å•ç‹¬åœ¨ Lovable è·‘æ—¶ç”¨
	â—¦	      â”‚  â”œâ”€ core/       # å…³é”®ï¼šè‡ªå·±é‚£ä¸€å±‚çš„çº¯å‡½æ•°èƒ½åŠ›
	â—¦	      â”‚  â””â”€ shared/
	â—¦	      â”œâ”€ package.json
	â—¦	      â””â”€ INTEGRATION.md
	â—¦	
	3	é€’å½’å­ L-Project
	â—¦	å­é¡¹ç›®è‡ªå·±ä¹Ÿå¯ä»¥å†æœ‰ packages/ï¼Œè§„åˆ™ä¸€æ¨¡ä¸€æ ·ï¼Œå¾€ä¸‹æ— é™å¥—ï¼šâ€¨packages/
	â—¦	  lproject-foo/
	â—¦	    packages/
	â—¦	      lproject-foo-detail/
	â—¦	      lproject-foo-metrics/
	â—¦	
å¿ƒæ™ºæ¨¡å‹ï¼šâ€¨ä»»æ„ä¸€ä¸ªç›®å½•ï¼Œåªè¦æœ‰ src/core + src/app + packagesï¼Œå®ƒå°±æ˜¯ä¸€ä¸ª L-Projectã€‚â€¨ä¸Šä¸€å±‚æŠŠå®ƒå½“â€œèƒ½åŠ›å—â€ï¼Œè¿™ä¸€å±‚å†å»ç»„è£…æ›´åº•å±‚çš„èƒ½åŠ›å—ã€‚

2. å­ L-Project çš„â€œèº«ä»½â€å’Œâ€œåå­—â€æ€ä¹ˆåŒºåˆ†ï¼Ÿ
æ¯ä¸ª packages/xxx å­é¡¹ç›®æœ‰ä¸¤ä¸ªå…³é”®æ ‡è¯†ï¼š
	1	åŒ…åï¼ˆpackage.json çš„ nameï¼‰â€¨ç”¨æ¥åœ¨ä»£ç é‡Œ import å®ƒï¼ˆçˆ¶ core è°ƒå­ coreï¼‰ï¼šâ€¨// my-lproject/packages/lproject-foo/package.json
	2	{
	3	  "name": "@internal/lproject-foo",
	4	  "version": "0.0.1",
	5	  "private": true,
	6	  // ...ï¼ˆå®ƒè‡ªå·±ä¹Ÿå¯ä»¥æœ‰ build:libï¼ŒæŠŠ src/core æ‰“åŒ…ï¼‰
	7	}
	8	
	9	é€»è¾‘ä¸Šçš„ projectIdï¼ˆå¯é€‰ä½†å¼ºçƒˆæ¨èï¼‰â€¨ç”¨æ¥ç»™ã€Œè„šæœ¬ã€æˆ–ã€Œè°ƒåº¦å™¨ã€è¯†åˆ«å“ªä¸ª projectï¼Œæ¯”å¦‚ï¼šâ€¨// packages/lproject-foo/src/core/manifest.ts
	10	export const projectId = "lproject-foo";
	11	export const projectName = "Foo èƒ½åŠ›å—";
	12	â€¨ç„¶ååœ¨é¡¶å±‚ my-lproject çš„ src/core é‡Œå¯ä»¥ç»´æŠ¤ä¸€ä¸ªç®€å•çš„ registryï¼ˆåé¢ç¬¬ 5 ç‚¹ä¼šå†™ï¼‰ã€‚
æ€»ç»“ï¼š
	â€¢	ä»£ç å±‚é¢ç”¨åŒ…åï¼ˆ@internal/lproject-fooï¼‰åŒºåˆ†æ˜¯è°
	â€¢	ä¸šåŠ¡ / è°ƒåº¦å±‚é¢ç”¨ projectId åŒºåˆ†æ˜¯è°

3. çˆ¶ Project å¦‚ä½•è°ƒç”¨ packages ä¸‹å­ Project çš„ Coreï¼Ÿ
æ‰€æœ‰è·¨ Project çš„è°ƒç”¨ï¼Œéƒ½åªå‘ç”Ÿåœ¨ çˆ¶é¡¹ç›®è‡ªå·±çš„ src/core é‡Œï¼Œç‰¹åˆ«æ˜¯ steps/integrateChildProject.ts å’Œå„ä¸ª pipelines/runXxx.ts ä¸­ã€‚
3.1 ä»çˆ¶ Core é‡Œ import å­ Core
ä¾‹å­ï¼šåœ¨çˆ¶çš„ integrateChildProject.ts é‡Œè°ƒç”¨ lproject-foo çš„ runProjectï¼š
// src/core/steps/integrateChildProject.ts
import type { CoreContext } from "@/core/types/context";

// å…³é”®ï¼šè¿™é‡Œç”¨çš„æ˜¯å­é¡¹ç›® package.json é‡Œé¢çš„ name
import {
  runProject as runFooProject,
  type RunProjectInput as FooInput,
  type RunProjectOutput as FooOutput,
} from "@internal/lproject-foo";

export async function integrateChildProject(
  normalized: unknown,
  ctx?: CoreContext
): Promise<FooOutput> {
  // 1. æŠŠå½“å‰é¡¹ç›®çš„æ•°æ®ï¼Œæ˜ å°„æˆå­é¡¹ç›®éœ€è¦çš„è¾“å…¥
  const fooInput: FooInput = {
    // ...æ ¹æ® normalized ç»„è£…
  };

  // 2. æŠŠ ctx ç›´æ¥é€ä¼ ä¸‹å»ï¼ˆæˆ–è€…åœ¨è¿™é‡Œåšä¸€å±‚è£å‰ªï¼‰
  const fooOutput = await runFooProject(fooInput, ctx);

  // 3. æŠŠå­é¡¹ç›®çš„è¾“å‡ºè¿”å›ï¼Œæˆ–è€…åœ¨è¿™é‡Œåšä¸€å±‚è½¬æ¢å†è¿”å›
  return fooOutput;
}
ä½ å¯ä»¥å†åœ¨ src/core/pipelines/runProject.ts é‡Œç»„åˆè¿™ä¸ªæ­¥éª¤ï¼š
// src/core/pipelines/runProject.ts
import type { CoreFn } from "@/core/types/functional";
import type { RunProjectInput, RunProjectOutput } from "@/core/types/io";
import { validateInput } from "@/core/steps/validateInput";
import { normalizeData } from "@/core/steps/normalizeData";
import { integrateChildProject } from "@/core/steps/integrateChildProject";

export const runProject: CoreFn<RunProjectInput, RunProjectOutput> = async (
  input,
  ctx
) => {
  const valid = validateInput(input);
  const normalized = normalizeData(valid);

  const childResult = await integrateChildProject(normalized, ctx);

  const result: RunProjectOutput = {
    // ç»„åˆ normalized + childResult
  };

  return result;
};
é‡ç‚¹ï¼š
	â€¢	çˆ¶åªè®¤è¯†â€œå­é¡¹ç›®çš„çº¯å‡½æ•°èƒ½åŠ›â€ï¼ˆå®ƒåªå…³å¿ƒ runProject çš„è¾“å…¥è¾“å‡ºï¼‰ã€‚
	â€¢	å­é¡¹ç›®çš„ UI / App / è·¯ç”±ï¼Œä¸€æ¦‚å’Œçˆ¶æ— å…³ã€‚

4. packages é‡Œçš„å­ Project ä¹‹é—´æ€ä¹ˆäº’ç›¸è°ƒç”¨ï¼Ÿ
è§„åˆ™å’Œâ€œçˆ¶è°ƒå­â€æ˜¯å®Œå…¨ä¸€æ ·çš„ï¼Œåªæ˜¯å±‚çº§å˜äº†ã€‚
ä¾‹å¦‚ï¼š
my-lproject/
â””â”€ packages/
   â”œâ”€ lproject-foo/
   â””â”€ lproject-bar/
å¦‚æœ lproject-bar æƒ³ç”¨ lproject-fooï¼š
	1	åœ¨ lproject-bar è‡ªå·±çš„ package.json é‡Œï¼ŒæŠŠ @internal/lproject-foo å½“ä¾èµ–ï¼ˆæˆ–è€… workspace å†…éƒ¨ä¾èµ–ï¼‰ã€‚
	2	åœ¨ packages/lproject-bar/src/core/steps/integrateFoo.ts é‡Œè¿™æ ·å†™ï¼š
// packages/lproject-bar/src/core/steps/integrateFoo.ts
import {
  runProject as runFooProject,
  type RunProjectInput as FooInput,
  type RunProjectOutput as FooOutput,
} from "@internal/lproject-foo";

export async function integrateFoo(
  input: FooInput,
  ctx?: CoreContext
): Promise<FooOutput> {
  return runFooProject(input, ctx);
}
æ ‡å‡†åŒ–æè¿°ä¸€å¥è¯ï¼š
	â€¢	ä»»ä½•ä¸€å±‚ï¼Œåªè¦æƒ³ç”¨å¦ä¸€å±‚ï¼Œåšæ³•æ°¸è¿œæ˜¯ï¼šåœ¨è‡ªå·±è¿™å±‚çš„ core é‡Œ import å¯¹æ–¹çš„ core å‡½æ•°ï¼Œç„¶ååœ¨ pipelines/steps é‡Œç¼–æ’ã€‚

5. ä¸ºâ€œæ‰§è¡Œè„šæœ¬ / è°ƒåº¦å™¨â€å‡†å¤‡ä¸€ä¸ªç»Ÿä¸€çš„ registry
ä½ ä¹‹å‰æè¿‡ä¸€ä¸ªæ„¿æœ›ï¼š
ã€Œæœªæ¥æˆ‘å¯èƒ½å†™ä¸€ä¸ªæ‰§è¡Œè„šæœ¬ï¼Œç„¶ååªéœ€è¦è¾“å…¥ä¸€ä¸ª project å¯¹åº”çš„ç¼–å·å’Œå˜é‡è¾“å…¥å°±å¯ä»¥è°ƒç”¨è¿™ä¸ª project çš„åŠŸèƒ½ã€‚ã€
åœ¨è¿™å¥—ç»“æ„ä¸‹å¾ˆå®¹æ˜“åšåˆ°ï¼Œåªéœ€è¦åœ¨ é¡¶å±‚ my-lproject è‡ªå·±çš„ src/core é‡Œç»´æŠ¤ä¸€ä¸ªâ€œé¡¹ç›®æ³¨å†Œè¡¨â€ã€‚
5.1 æ¯ä¸ª Project æš´éœ²è‡ªå·±çš„ projectId å’Œ main å‡½æ•°
çº¦å®šï¼šæ¯ä¸ª L-Project çš„ src/core/index.ts è‡³å°‘å¯¼å‡ºï¼š
// é¡¶å±‚ my-lproject çš„ src/core/index.ts
export const projectId = "my-lproject";
export { runProject } from "./pipelines/runProject";

// å­é¡¹ç›® packages/lproject-foo/src/core/index.ts
export const projectId = "lproject-foo";
export { runProject } from "./pipelines/runProject";

// å­é¡¹ç›® packages/lproject-bar/src/core/index.ts
export const projectId = "lproject-bar";
export { runProject } from "./pipelines/runProject";
5.2 é¡¶å±‚åšä¸€ä¸ª â€œå¤š Project è·¯ç”±å™¨â€
åœ¨é¡¶å±‚ my-lproject é‡Œåšä¸€ä¸ªå°æ–‡ä»¶ï¼Œä¾‹å¦‚ï¼š
// src/core/registry.ts
import type { CoreContext } from "@/core/types/context";

// é¡¶å±‚è‡ªå·±
import {
  projectId as rootProjectId,
  runProject as runRootProject,
} from "@/core";

// å­é¡¹ç›®
import {
  projectId as fooProjectId,
  runProject as runFooProject,
} from "@internal/lproject-foo";

import {
  projectId as barProjectId,
  runProject as runBarProject,
} from "@internal/lproject-bar";

type AnyInput = unknown;
type AnyOutput = unknown;

type Runner = (input: AnyInput, ctx?: CoreContext) => Promise<AnyOutput>;

export const projectRegistry: Record<string, Runner> = {
  [rootProjectId]: runRootProject as Runner,
  [fooProjectId]: runFooProject as Runner,
  [barProjectId]: runBarProject as Runner,
};
ç„¶åæš´éœ²ä¸€ä¸ªç»Ÿä¸€å…¥å£ï¼š
// src/core/pipelines/runByProjectId.ts
import type { CoreFn } from "@/core/types/functional";
import type { CoreContext } from "@/core/types/context";
import { projectRegistry } from "@/core/registry";

export interface RunByProjectIdInput {
  projectId: string;
  payload: unknown;
}

export type RunByProjectIdOutput = unknown;

export const runByProjectId: CoreFn<
  RunByProjectIdInput,
  RunByProjectIdOutput
> = async (input, ctx) => {
  const runner = projectRegistry[input.projectId];
  if (!runner) {
    throw new Error(`Unknown projectId: ${input.projectId}`);
  }
  return runner(input.payload, ctx);
};
è¿™æ ·ä½ æœªæ¥å†™è„šæœ¬å°±å¯ä»¥ï¼š
import { runByProjectId } from "./src/core/pipelines/runByProjectId";

await runByProjectId(
  {
    projectId: "lproject-foo",
    payload: { /* è¿™ä¸ªå­ project çš„è¾“å…¥ */ },
  },
  ctx
);
è¿™å°±æ˜¯â€œä¸€ä¸ªæ‰§è¡Œè„šæœ¬ + project ç¼–å· + è¾“å…¥ â†’ è°ƒä»»ä½•ä¸€ä¸ª projectâ€çš„æ ‡å‡†å½¢æ€ã€‚

6. é€’å½’åµŒå¥—æ—¶çš„å‡ ä¸ªç¡¬è§„åˆ™
	1	ä¾èµ–æ–¹å‘ï¼šæ°¸è¿œå¾€â€œæ›´åº•å±‚â€ä¾èµ–ï¼Œä¸èƒ½æˆç¯
	â—¦	src/core å¯ä»¥ä¾èµ– packages/*/src/coreã€‚
	â—¦	æŸä¸ª packages/lproject-foo/src/core å¯ä»¥ä¾èµ–è‡ªå·± packages/lproject-foo/packages/*/src/coreã€‚
	â—¦	âŒ ä¸å…è®¸åº•å±‚é¡¹ç›®åå‘ import ä¸Šå±‚é¡¹ç›®çš„ coreï¼Œå¦åˆ™é€’å½’å°±å˜æˆå¾ªç¯å›¾ã€‚
	2	è·¯ç”± / UI æ°¸è¿œä¸å‚ä¸åµŒå¥—
	â—¦	ä»»ä½•ä¸€å±‚çš„ src/app éƒ½åªæœåŠ¡äºè‡ªå·±çš„ Playground / Demoã€‚
	â—¦	äº’ç›¸é›†æˆå…¨å‘ç”Ÿåœ¨ core é‡Œï¼ŒUI åªæ˜¯æ¯ä¸ª project è‡ªå·±çš„å¯è§†åŒ–å£³å­ã€‚
	3	Edge Functions / Supabase çš„ä½¿ç”¨ç»Ÿä¸€èµ° adapters
	â—¦	å“ªä¸€å±‚éœ€è¦è®¿é—®åç«¯ï¼Œéƒ½åªç”¨ ctx.adapters.api / ctx.adapters.dbã€‚
	â—¦	åŒä¸€ä¸ªè°ƒç”¨é“¾é‡Œï¼Œå¯ä»¥ä¸€è·¯æŠŠåŒä¸€ä¸ª ctx å¾€ä¸‹ä¼ ï¼Œè¿™æ ·æ•´ä¸ªç³»ç»Ÿå…±äº«ä¸€å¥—åç«¯é…ç½® & æƒé™ã€‚
	4	packages ç›®å½•å¿…é¡»å­˜åœ¨ï¼Œå³ä½¿æš‚æ—¶ä¸ºç©º
	â—¦	è¿™æ ·ä½ çš„ã€Œé¡¹ç›®éª¨æ¶ã€æ˜¯ç¨³å®šçš„ï¼šä»¥åè¦åŠ å­é¡¹ç›®ï¼Œåªæ˜¯å¾€ packages/ é‡Œå¡æ–°ç›®å½•ã€‚
	â—¦	src/core/steps/integrateChildProject.ts å¯ä»¥å…ˆç•™ä¸€ä¸ªç©ºå®ç°ï¼Œå°†æ¥å†é€æ­¥æŠŠçœŸæ­£çš„å­é¡¹ç›®æ‹¼è¿›å»ã€‚

7. ä¸€å¥è¯æ€»ç»“è¿™ç‰ˆâ€œé€’å½’åµŒå¥—è§„èŒƒâ€
	â€¢	é¡¶å±‚ my-lproject æœ‰å›ºå®šç»“æ„ + å›ºå®šå­˜åœ¨çš„ packages/ã€‚
	â€¢	æ¯ä¸ª packages/* ç›®å½•æœ¬èº«åˆæ˜¯ä¸€ä¸ªå®Œæ•´çš„ L-Projectï¼ˆæœ‰è‡ªå·±çš„ coreï¼‰ã€‚
	â€¢	æ‰€æœ‰å±‚çº§ä¹‹é—´åªæœ‰ä¸€ç§è¿æ¥æ–¹å¼ï¼šâ€¨åœ¨ä¸Šä¸€å±‚çš„ src/core é‡Œ import ä¸‹ä¸€å±‚çš„ src/core å¯¼å‡ºçš„çº¯å‡½æ•°ï¼Œç„¶ååœ¨ steps/ å’Œ pipelines/ é‡Œç¼–æ’ã€‚


8. å¤š L-Project åµŒå¥—æ—¶çš„ä¾èµ–ä¸ UI ç»„ä»¶è§„èŒƒ

> âš ï¸ **é‡è¦æç¤º**ï¼šè¿™æ˜¯å¤š L-Project æ¶æ„ä¸­æœ€å®¹æ˜“å‡ºé—®é¢˜çš„éƒ¨åˆ†ã€‚è¯·åŠ¡å¿…å®Œæ•´é˜…è¯»å¹¶ç†è§£ä¸¤ç§è¿è¡Œæ¨¡å¼çš„åŒºåˆ«ã€‚

## 8.1 æ ¸å¿ƒæ¦‚å¿µï¼šä¸¤ç§è¿è¡Œæ¨¡å¼

æ¯ä¸ª L-Project éƒ½æ”¯æŒä¸¤ç§è¿è¡Œæ¨¡å¼ï¼Œå®ƒä»¬çš„ä¾èµ–è§£ææ–¹å¼å®Œå…¨ä¸åŒï¼š

| æ¨¡å¼ | æè¿° | å…¥å£å‘½ä»¤ | ä¾èµ–æ¥æº |
|------|------|---------|---------|
| **å¼€å‘æ¨¡å¼** | ä»çˆ¶é¡¹ç›®è¿è¡Œï¼Œå­é¡¹ç›®æºç è¢«ç›´æ¥å¼•ç”¨ | çˆ¶é¡¹ç›®çš„ `npm run dev` | **çˆ¶é¡¹ç›®çš„** `node_modules` |
| **ç‹¬ç«‹éƒ¨ç½²æ¨¡å¼** | å­é¡¹ç›®ä½œä¸ºç‹¬ç«‹åº”ç”¨è¿è¡Œ | å­é¡¹ç›®çš„ `npm run dev` | **å­é¡¹ç›®çš„** `node_modules` |

### ä¸ºä»€ä¹ˆä¼šæœ‰å¤šå®ä¾‹é—®é¢˜ï¼Ÿ

ä¸¾ä¾‹ï¼š
```
muse-chat-pad/                          â† çˆ¶é¡¹ç›®
â”œâ”€ node_modules/
â”‚  â””â”€ react@19.2.0                      â† çˆ¶é¡¹ç›®çš„ React
â”‚  â””â”€ @radix-ui/react-dialog@1.1.15     â† çˆ¶é¡¹ç›®çš„ Radix UI
â””â”€ packages/
   â””â”€ workflow-ai-designer/             â† å­é¡¹ç›®
      â”œâ”€ node_modules/
      â”‚  â””â”€ react@18.2.0                â† å­é¡¹ç›®çš„ Reactï¼ˆç‰ˆæœ¬ä¸åŒï¼ï¼‰
      â”‚  â””â”€ @radix-ui/react-dialog@1.0.5 â† å­é¡¹ç›®çš„ Radix UI
      â””â”€ packages/
         â””â”€ html-overlay-module/        â† åµŒå¥—å­é¡¹ç›®
            â””â”€ node_modules/
               â””â”€ react@18.2.0          â† åˆä¸€ä¸ª React å®ä¾‹ï¼
```

**é—®é¢˜æœ¬è´¨**ï¼š
- å¼€å‘æ¨¡å¼ä¸‹ï¼ŒVite å¯èƒ½ä»å­é¡¹ç›®çš„ `node_modules` åŠ è½½ä¾èµ–
- React Context æ— æ³•è·¨å®ä¾‹å…±äº«
- Dialogã€Portalã€Popover ç­‰ç»„ä»¶å¤±æ•ˆ

**è§£å†³æ–¹æ¡ˆçš„å…³é”®**ï¼š
- âŒ **ä¸æ˜¯åˆ é™¤å­é¡¹ç›®çš„ä¾èµ–**ï¼ˆè¿™ä¼šç ´åç‹¬ç«‹éƒ¨ç½²èƒ½åŠ›ï¼‰
- âœ… è€Œæ˜¯åœ¨**å¼€å‘æ¨¡å¼ä¸‹**é€šè¿‡ Vite åˆ«åå¼ºåˆ¶ä½¿ç”¨çˆ¶é¡¹ç›®çš„ä¾èµ–

---

## 8.2 å­é¡¹ç›®çš„ package.json è§„èŒƒï¼ˆæ”¯æŒä¸¤ç§æ¨¡å¼ï¼‰

```jsonc
// packages/child-project/package.json
{
  "name": "@org/child-project",
  "version": "0.1.0",
  "private": true,
  
  // âœ… peerDependenciesï¼šå£°æ˜"æˆ‘éœ€è¦è¿™äº›åŒ…ï¼Œä½†å¯ç”±å®¿ä¸»æä¾›"
  // è¿™æ˜¯ç»™ npm/yarn çš„æç¤ºï¼Œç”¨äºç‰ˆæœ¬å…¼å®¹æ€§æ£€æŸ¥
  "peerDependencies": {
    "react": ">=18.2.0",
    "react-dom": ">=18.2.0",
    "@radix-ui/react-dialog": ">=1.0.0"
  },
  
  // âœ… devDependenciesï¼šä¿ç•™æ ¸å¿ƒä¾èµ–ï¼Œç”¨äºç‹¬ç«‹å¼€å‘å’Œæµ‹è¯•
  // è¿™ç¡®ä¿å­é¡¹ç›®å¯ä»¥ç‹¬ç«‹è¿è¡Œï¼ˆnpm run devï¼‰
  "devDependencies": {
    "react": "^18.2.0",
    "react-dom": "^18.2.0",
    "@radix-ui/react-dialog": "^1.1.15",
    "@types/react": "^18.2.66",
    "@types/react-dom": "^18.2.22",
    "typescript": "^5.4.0",
    "vite": "^5.1.0"
  },
  
  // âœ… dependenciesï¼šä¸šåŠ¡ä¾èµ–å’Œçº¯å‡½æ•°ä¾èµ–
  "dependencies": {
    "zod": "^3.23.8",
    "clsx": "^2.1.1"
  }
}
```

**å…³é”®ç‚¹**ï¼š
- `peerDependencies` å’Œ `devDependencies` ä¸­**åŒæ—¶å£°æ˜** React å’Œ UI åº“
- `peerDependencies` ç”¨äºç‰ˆæœ¬å…¼å®¹æ€§æ£€æŸ¥å’Œ npm æç¤º
- `devDependencies` ç¡®ä¿å­é¡¹ç›®å¯ä»¥ç‹¬ç«‹è¿è¡Œ

---

## 8.3 çˆ¶é¡¹ç›®çš„ Vite é…ç½®è§„èŒƒï¼ˆè§£å†³å¼€å‘æ¨¡å¼å¤šå®ä¾‹ï¼‰

> âš ï¸ **è¿™æ˜¯è§£å†³å¤šå®ä¾‹é—®é¢˜çš„æ ¸å¿ƒé…ç½®ï¼**

### A. å­é¡¹ç›®å…¥å£åˆ«åï¼ˆå¿…é¡»é…ç½®ï¼Œå®¹æ˜“é—æ¼ï¼ï¼‰

æ¯ä¸ªå­é¡¹ç›®ï¼ˆåŒ…æ‹¬åµŒå¥—å­é¡¹ç›®ï¼‰éƒ½éœ€è¦é…ç½®å…¥å£åˆ«åï¼š

```typescript
// çˆ¶é¡¹ç›® vite.config.ts
resolve: {
  alias: {
    // âœ… æ‰€æœ‰å­é¡¹ç›®çš„å…¥å£åˆ«åï¼ˆæŒ‡å‘æºç ï¼Œè€Œé distï¼‰
    "@org/workflow-ai-designer": path.resolve(__dirname, 
      "./packages/workflow-ai-designer/src/core/index.ts"),
    "@org/html-overlay-module": path.resolve(__dirname, 
      "./packages/workflow-ai-designer/packages/html-overlay-module/src/index.ts"),
    "@org/image-feather-module": path.resolve(__dirname, 
      "./packages/workflow-ai-designer/packages/image-feather-module/src/index.ts"),
    
    // âœ… åµŒå¥—å­é¡¹ç›®ä¹Ÿéœ€è¦é…ç½®ï¼ˆè¿™æ˜¯æœ€å®¹æ˜“é—æ¼çš„ï¼ï¼‰
    "@html-overlay-module/html-fixer": path.resolve(__dirname, 
      "./packages/workflow-ai-designer/packages/html-overlay-module/packages/html-fixer/src/core/index.ts"),
  },
}
```

**ä¸ºä»€ä¹ˆå…¥å£åˆ«åæŒ‡å‘æºç è€Œé distï¼Ÿ**
- å¼€å‘æ¨¡å¼ä¸‹ä¸éœ€è¦æ„å»ºå­é¡¹ç›®
- ä¿®æ”¹å­é¡¹ç›®ä»£ç åç«‹å³ç”Ÿæ•ˆï¼ˆçƒ­æ›´æ–°ï¼‰
- é¿å… dist ä¸å­˜åœ¨æˆ–è¿‡æœŸå¯¼è‡´çš„é”™è¯¯

### B. æ ¸å¿ƒä¾èµ–åˆ«åï¼ˆå¼ºåˆ¶ç»Ÿä¸€ç‰ˆæœ¬ï¼‰

```typescript
// çˆ¶é¡¹ç›® vite.config.ts
resolve: {
  alias: {
    // ... å­é¡¹ç›®å…¥å£åˆ«åï¼ˆè§ä¸Šæ–¹ï¼‰...
    
    // âœ… React ç”Ÿæ€ï¼ˆå¿…é¡»é…ç½®ï¼‰
    "react": path.resolve(__dirname, "./node_modules/react"),
    "react-dom": path.resolve(__dirname, "./node_modules/react-dom"),
    "react/jsx-runtime": path.resolve(__dirname, "./node_modules/react/jsx-runtime"),
    "react/jsx-dev-runtime": path.resolve(__dirname, "./node_modules/react/jsx-dev-runtime"),
    
    // âœ… æ‰€æœ‰ä½¿ç”¨åˆ°çš„ Radix UI åŒ…ï¼ˆæ ¹æ®å®é™…ä½¿ç”¨æƒ…å†µé…ç½®ï¼‰
    "@radix-ui/react-accordion": path.resolve(__dirname, "./node_modules/@radix-ui/react-accordion"),
    "@radix-ui/react-alert-dialog": path.resolve(__dirname, "./node_modules/@radix-ui/react-alert-dialog"),
    "@radix-ui/react-avatar": path.resolve(__dirname, "./node_modules/@radix-ui/react-avatar"),
    "@radix-ui/react-checkbox": path.resolve(__dirname, "./node_modules/@radix-ui/react-checkbox"),
    "@radix-ui/react-collapsible": path.resolve(__dirname, "./node_modules/@radix-ui/react-collapsible"),
    "@radix-ui/react-context": path.resolve(__dirname, "./node_modules/@radix-ui/react-context"),
    "@radix-ui/react-dialog": path.resolve(__dirname, "./node_modules/@radix-ui/react-dialog"),
    "@radix-ui/react-dropdown-menu": path.resolve(__dirname, "./node_modules/@radix-ui/react-dropdown-menu"),
    "@radix-ui/react-label": path.resolve(__dirname, "./node_modules/@radix-ui/react-label"),
    "@radix-ui/react-popover": path.resolve(__dirname, "./node_modules/@radix-ui/react-popover"),
    "@radix-ui/react-portal": path.resolve(__dirname, "./node_modules/@radix-ui/react-portal"),
    "@radix-ui/react-primitive": path.resolve(__dirname, "./node_modules/@radix-ui/react-primitive"),
    "@radix-ui/react-scroll-area": path.resolve(__dirname, "./node_modules/@radix-ui/react-scroll-area"),
    "@radix-ui/react-select": path.resolve(__dirname, "./node_modules/@radix-ui/react-select"),
    "@radix-ui/react-separator": path.resolve(__dirname, "./node_modules/@radix-ui/react-separator"),
    "@radix-ui/react-slider": path.resolve(__dirname, "./node_modules/@radix-ui/react-slider"),
    "@radix-ui/react-slot": path.resolve(__dirname, "./node_modules/@radix-ui/react-slot"),
    "@radix-ui/react-switch": path.resolve(__dirname, "./node_modules/@radix-ui/react-switch"),
    "@radix-ui/react-tabs": path.resolve(__dirname, "./node_modules/@radix-ui/react-tabs"),
    "@radix-ui/react-toast": path.resolve(__dirname, "./node_modules/@radix-ui/react-toast"),
    "@radix-ui/react-toggle": path.resolve(__dirname, "./node_modules/@radix-ui/react-toggle"),
    "@radix-ui/react-toggle-group": path.resolve(__dirname, "./node_modules/@radix-ui/react-toggle-group"),
    "@radix-ui/react-tooltip": path.resolve(__dirname, "./node_modules/@radix-ui/react-tooltip"),
  },
},
optimizeDeps: {
  include: [
    'react',
    'react-dom',
    'react/jsx-runtime',
    '@radix-ui/react-dialog',
    '@radix-ui/react-portal',
    // ... å…¶ä»–å…³é”® Radix UI åŒ…
  ],
},
```

---

## 8.4 å­é¡¹ç›®çš„ Vite é…ç½®è§„èŒƒï¼ˆæ”¯æŒç‹¬ç«‹è¿è¡Œï¼‰

æ¯ä¸ªå­é¡¹ç›®éœ€è¦è‡ªå·±çš„ `vite.config.ts`ï¼Œç”¨äºç‹¬ç«‹è¿è¡Œæ—¶ï¼š

```typescript
// packages/workflow-ai-designer/vite.config.ts
import { defineConfig } from "vite";
import react from "@vitejs/plugin-react-swc";
import path from "node:path";

export default defineConfig({
  plugins: [react()],
  resolve: {
    alias: {
      // âœ… å­é¡¹ç›®è‡ªå·±çš„ @ åˆ«å
      "@": path.resolve(__dirname, "./src"),
      
      // âœ… å¦‚æœæœ‰åµŒå¥—å­é¡¹ç›®ï¼Œä¹Ÿé…ç½®å…¥å£åˆ«å
      "@org/html-overlay-module": path.resolve(__dirname, 
        "./packages/html-overlay-module/src/index.ts"),
    },
  },
  server: {
    port: 8082,  // âœ… ä½¿ç”¨ä¸åŒçš„ç«¯å£ï¼Œé¿å…å†²çª
  },
});
```

---

## 8.5 tsup æ„å»ºè§„èŒƒï¼ˆåº“æ¨¡å¼æ„å»ºï¼‰

å­é¡¹ç›®çš„ `build:lib` æ„å»ºæ—¶ï¼Œéœ€è¦å°†æ ¸å¿ƒä¾èµ–æ ‡è®°ä¸º externalï¼š

```bash
# package.json scripts
"build:lib": "tsup src/core/index.ts --dts --format esm,cjs --sourcemap --clean --external react,react-dom,react/jsx-runtime,@radix-ui/react-dialog,@radix-ui/react-portal,..."
```

**ä¸ºä»€ä¹ˆéœ€è¦ externalï¼Ÿ**
- æ„å»ºäº§ç‰©ä¸åŒ…å«è¿™äº›ä¾èµ–
- è¿è¡Œæ—¶ç”±å®¿ä¸»ç¯å¢ƒæä¾›
- é¿å…æ‰“åŒ…åçš„ä»£ç ä»ç„¶æœ‰å¤šå®ä¾‹é—®é¢˜

---

## 8.6 å¸¸è§é”™è¯¯ä¸ä¿®å¤

### é”™è¯¯ 1ï¼šFailed to resolve entry for package "xxx"

```
[plugin:vite:import-analysis] Failed to resolve entry for package "@html-overlay-module/html-fixer". 
The package may have incorrect main/module/exports specified in its package.json.
```

**åŸå› **ï¼šå­é¡¹ç›®çš„ `package.json` æŒ‡å‘ `dist/`ï¼Œä½†å¼€å‘æ¨¡å¼ä¸‹ `dist/` ä¸å­˜åœ¨ã€‚

**ä¿®å¤**ï¼šåœ¨çˆ¶é¡¹ç›®çš„ `vite.config.ts` ä¸­æ·»åŠ è¯¥å­é¡¹ç›®çš„å…¥å£åˆ«åï¼š

```typescript
"@html-overlay-module/html-fixer": path.resolve(__dirname, 
  "./packages/.../html-fixer/src/core/index.ts"),
```

### é”™è¯¯ 2ï¼šDialog/Popover ä¸æ¸²æŸ“

**åŸå› **ï¼šReact Context å¤šå®ä¾‹é—®é¢˜ï¼ŒRadix UI çš„ Portal æ— æ³•æ‰¾åˆ°æ­£ç¡®çš„ Contextã€‚

**è¯Šæ–­**ï¼š
```javascript
// åœ¨æµè§ˆå™¨æ§åˆ¶å°æ‰§è¡Œ
document.querySelectorAll('[data-radix-portal]').length
// å¦‚æœå¤§äºé¢„æœŸæ•°é‡ï¼Œè¯´æ˜æœ‰å¤šå®ä¾‹
```

**ä¿®å¤**ï¼šæ£€æŸ¥çˆ¶é¡¹ç›®çš„ `vite.config.ts` æ˜¯å¦é…ç½®äº†æ‰€æœ‰ Radix UI åŒ…çš„åˆ«åã€‚

### é”™è¯¯ 3ï¼šå­é¡¹ç›®ç‹¬ç«‹è¿è¡Œå¤±è´¥

**åŸå› **ï¼šè¯¯åˆ äº†å­é¡¹ç›®çš„ `node_modules` ä¸­çš„ä¾èµ–ã€‚

**ä¿®å¤**ï¼š
1. åœ¨å­é¡¹ç›®ç›®å½•æ‰§è¡Œ `npm install`
2. ç¡®ä¿ `devDependencies` ä¸­åŒ…å« react å’Œ react-dom

---

## 8.7 ä¸¤ç§è¿è¡Œæ¨¡å¼å¯¹æ¯”

| é…ç½®é¡¹ | å¼€å‘æ¨¡å¼ï¼ˆä»çˆ¶é¡¹ç›®è¿è¡Œï¼‰ | ç‹¬ç«‹éƒ¨ç½²æ¨¡å¼ï¼ˆå­é¡¹ç›®å•ç‹¬è¿è¡Œï¼‰ |
|--------|------------------------|------------------------------|
| ä½¿ç”¨çš„ vite.config | çˆ¶é¡¹ç›®çš„ | å­é¡¹ç›®çš„ |
| ä¾èµ–æ¥æº | çˆ¶é¡¹ç›® node_modules | å­é¡¹ç›® node_modules |
| React ç‰ˆæœ¬ | ç»Ÿä¸€ï¼ˆçˆ¶é¡¹ç›®ç‰ˆæœ¬ï¼‰ | å­é¡¹ç›® devDependencies ç‰ˆæœ¬ |
| ç«¯å£ | çˆ¶é¡¹ç›®ç«¯å£ï¼ˆå¦‚ 8083ï¼‰ | å­é¡¹ç›®ç«¯å£ï¼ˆå¦‚ 8082ï¼‰ |
| çƒ­æ›´æ–° | ä¿®æ”¹å­é¡¹ç›®æºç ç«‹å³ç”Ÿæ•ˆ | ä¿®æ”¹å­é¡¹ç›®æºç ç«‹å³ç”Ÿæ•ˆ |
| å¤šå®ä¾‹é—®é¢˜ | é€šè¿‡åˆ«åé…ç½®è§£å†³ | æ— æ­¤é—®é¢˜ï¼ˆå•é¡¹ç›®è¿è¡Œï¼‰ |

---

## 8.8 å®Œæ•´é…ç½®æ£€æŸ¥æ¸…å•

### A. å­é¡¹ç›® package.json æ£€æŸ¥

- [ ] `peerDependencies` å£°æ˜äº† React å’Œä½¿ç”¨çš„ UI åº“
- [ ] `devDependencies` **ä¹Ÿ**åŒ…å« React å’Œä½¿ç”¨çš„ UI åº“ï¼ˆç”¨äºç‹¬ç«‹è¿è¡Œï¼‰
- [ ] `dependencies` åªåŒ…å«ä¸šåŠ¡ä¾èµ–å’Œçº¯å‡½æ•°ä¾èµ–

### B. å­é¡¹ç›® tsup/build æ£€æŸ¥

- [ ] `build:lib` å‘½ä»¤ä¸­ `--external` åŒ…å«æ‰€æœ‰æ ¸å¿ƒä¾èµ–
- [ ] æ ¸å¿ƒä¾èµ–ä¸ä¼šè¢«æ‰“åŒ…è¿› dist

### C. çˆ¶é¡¹ç›® vite.config.ts æ£€æŸ¥ï¼ˆæœ€é‡è¦ï¼ï¼‰

- [ ] é…ç½®äº†**æ‰€æœ‰**å­é¡¹ç›®çš„å…¥å£åˆ«åï¼ˆåŒ…æ‹¬åµŒå¥—å­é¡¹ç›®ï¼‰
- [ ] å…¥å£åˆ«åæŒ‡å‘**æºç **ï¼ˆ`src/core/index.ts`ï¼‰ï¼Œè€Œé `dist`
- [ ] é…ç½®äº† React ç”Ÿæ€çš„åˆ«åï¼ˆreact, react-dom, jsx-runtime, jsx-dev-runtimeï¼‰
- [ ] é…ç½®äº†**æ‰€æœ‰ä½¿ç”¨åˆ°çš„** Radix UI åŒ…çš„åˆ«å
- [ ] `optimizeDeps.include` åŒ…å«å…³é”® UI åº“

### D. å­é¡¹ç›® vite.config.ts æ£€æŸ¥ï¼ˆç”¨äºç‹¬ç«‹è¿è¡Œï¼‰

- [ ] æœ‰è‡ªå·±çš„ Vite é…ç½®æ–‡ä»¶
- [ ] ä½¿ç”¨ä¸åŒçš„ç«¯å£ï¼ˆå¦‚ 8082, 8081 ç­‰ï¼‰
- [ ] é…ç½®äº†è‡ªå·±çš„ `@/` åˆ«å
- [ ] å¦‚æœæœ‰åµŒå¥—å­é¡¹ç›®ï¼Œä¹Ÿé…ç½®äº†å…¥å£åˆ«å

### E. å­é¡¹ç›® L-Core è·¯å¾„æ£€æŸ¥ï¼ˆé‡è¦ï¼ï¼‰

- [ ] `src/core/` ç›®å½•ä¸‹çš„æ–‡ä»¶ä½¿ç”¨**ç›¸å¯¹è·¯å¾„**å¯¼å…¥åŒçº§æ¨¡å—
- [ ] `src/app/` ç›®å½•ä¸‹çš„æ–‡ä»¶å¯ä»¥ç»§ç»­ä½¿ç”¨ `@/` åˆ«å
- [ ] é¿å…åœ¨ L-Core ä¸­ä½¿ç”¨ `@/` åˆ«åï¼ˆä¼šä¸çˆ¶é¡¹ç›®å†²çªï¼‰

---

## 8.9 æœ€ä½³å®è·µæ€»ç»“

1. **ä¸è¦åˆ é™¤å­é¡¹ç›®çš„ä¾èµ–**ï¼šè¿™ä¼šç ´åç‹¬ç«‹éƒ¨ç½²èƒ½åŠ›
2. **åˆ«åé…ç½®æ˜¯å…³é”®**ï¼šçˆ¶é¡¹ç›®çš„ `vite.config.ts` æ˜¯è§£å†³å¤šå®ä¾‹çš„æ ¸å¿ƒ
3. **å…¥å£åˆ«åå®¹æ˜“é—æ¼**ï¼šæ–°å¢å­é¡¹ç›®æ—¶ï¼Œè®°å¾—åœ¨çˆ¶é¡¹ç›®ä¸­æ·»åŠ å…¥å£åˆ«å
4. **Radix UI åŒ…è¦é…ç½®å®Œæ•´**ï¼šç¼ºå°‘ä»»ä½•ä¸€ä¸ªéƒ½å¯èƒ½å¯¼è‡´é—®é¢˜
5. **ä¸¤ç§æ¨¡å¼å…±å­˜**ï¼šè®¾è®¡æ—¶è€ƒè™‘å­é¡¹ç›®æ—¢èƒ½è¢«å¼•ç”¨ï¼Œä¹Ÿèƒ½ç‹¬ç«‹è¿è¡Œ
6. **L-Core ä½¿ç”¨ç›¸å¯¹è·¯å¾„**ï¼š`src/core/` ç›®å½•å†…ä½¿ç”¨ç›¸å¯¹è·¯å¾„ï¼Œé¿å… `@/` åˆ«åå†²çª

---

## 8.10 åŸç”Ÿæ›¿ä»£æ–¹æ¡ˆï¼ˆå¤‡ç”¨ï¼‰

å½“ Radix UI ç»„ä»¶ç¡®å®æ— æ³•å·¥ä½œæ—¶ï¼Œå¯ä»¥åˆ›å»ºåŸç”Ÿ HTML5 æ›¿ä»£ç»„ä»¶ï¼š

**åŸç”Ÿæ›¿ä»£ç»„ä»¶çš„å‘½åè§„èŒƒ**ï¼š
- æ–‡ä»¶åï¼š`native-{component}.tsx`
- ç»„ä»¶åï¼š`Native{Component}`
- å¿…é¡»åœ¨æ–‡ä»¶é¡¶éƒ¨æ·»åŠ è¯´æ˜æ³¨é‡Š
- ä½¿ç”¨ Tailwind CSS + HSL é¢œè‰²å˜é‡
- å¯¼å‡ºä¸ shadcn-ui ç›¸åŒçš„ API

è¿™æ˜¯æœ€åçš„å¤‡ç”¨æ–¹æ¡ˆï¼Œä¼˜å…ˆä½¿ç”¨åˆ«åé…ç½®è§£å†³é—®é¢˜ã€‚

---

## 8.11 å­é¡¹ç›® L-Core ç›®å½•çš„è·¯å¾„åˆ«åè§„èŒƒï¼ˆé‡è¦ï¼ï¼‰

> âš ï¸ **è¿™æ˜¯å¤š L-Project æ¶æ„ä¸­å¦ä¸€ä¸ªå¸¸è§é—®é¢˜**ï¼šå­é¡¹ç›®çš„ `@/` è·¯å¾„åˆ«åä¼šä¸çˆ¶é¡¹ç›®å†²çªã€‚

### é—®é¢˜æè¿°

å½“çˆ¶é¡¹ç›®é€šè¿‡åˆ«åå¼•ç”¨å­é¡¹ç›®çš„æºç æ—¶ï¼š

```typescript
// çˆ¶é¡¹ç›® vite.config.ts
"@org/child-project": path.resolve(__dirname, 
  "./packages/child-project/src/core/index.ts"),
```

å­é¡¹ç›®å†…éƒ¨çš„ `@/` åˆ«åä¼šè¢«çˆ¶é¡¹ç›®çš„ Vite è§£æï¼Œå¯¼è‡´è·¯å¾„é”™è¯¯ï¼š

```typescript
// å­é¡¹ç›® src/core/pipelines/runProject.ts
import { someStep } from "@/core/steps/someStep";
// âŒ çˆ¶é¡¹ç›®çš„ Vite ä¼šå°† @/ è§£æä¸ºçˆ¶é¡¹ç›®çš„ src/
// âŒ å®é™…è§£æä¸º: çˆ¶é¡¹ç›®/src/core/steps/someStepï¼ˆä¸å­˜åœ¨ï¼ï¼‰
```

### è§£å†³æ–¹æ¡ˆï¼šL-Core å†…éƒ¨ä½¿ç”¨ç›¸å¯¹è·¯å¾„

**è§„åˆ™**ï¼š`src/core/` ç›®å½•ä¸‹çš„æ‰€æœ‰æ–‡ä»¶ï¼Œåœ¨å¯¼å…¥åŒçº§æˆ–å­çº§æ¨¡å—æ—¶ï¼Œä½¿ç”¨**ç›¸å¯¹è·¯å¾„**è€Œä¸æ˜¯ `@/` åˆ«åã€‚

```
src/
â”œâ”€â”€ app/           â† ä½¿ç”¨ @/ åˆ«åï¼ˆL-Appï¼Œä¸è¢«çˆ¶é¡¹ç›®å¼•ç”¨ï¼‰
â”‚   â”œâ”€â”€ pages/
â”‚   â”‚   â””â”€â”€ Page.tsx     â†’ import { runProject } from "@/core";
â”‚   â””â”€â”€ AppShell.tsx
â”‚
â”œâ”€â”€ core/          â† ä½¿ç”¨ç›¸å¯¹è·¯å¾„ï¼ˆL-Coreï¼Œä¼šè¢«çˆ¶é¡¹ç›®å¼•ç”¨ï¼‰
â”‚   â”œâ”€â”€ index.ts         â†’ export { runProject } from "./pipelines/runProject";
â”‚   â”œâ”€â”€ pipelines/
â”‚   â”‚   â””â”€â”€ runProject.ts â†’ import { someStep } from "../steps/someStep";
â”‚   â”œâ”€â”€ steps/
â”‚   â”‚   â””â”€â”€ someStep.ts   â†’ import type { SomeType } from "../types/io";
â”‚   â””â”€â”€ types/
â”‚       â””â”€â”€ io.ts
â”‚
â””â”€â”€ shared/        â† ä½¿ç”¨ @/ åˆ«åï¼ˆä»…ä¾›æœ¬é¡¹ç›® app ä½¿ç”¨ï¼‰
```

### ä»£ç ç¤ºä¾‹

**âŒ é”™è¯¯å†™æ³•**ï¼ˆä¼šè¢«çˆ¶é¡¹ç›®å¼•ç”¨æ—¶å‡ºé”™ï¼‰ï¼š

```typescript
// src/core/pipelines/runProject.ts
import type { CoreFn } from "@/core/types/functional";
import { someStep } from "@/core/steps/someStep";
```

**âœ… æ­£ç¡®å†™æ³•**ï¼š

```typescript
// src/core/pipelines/runProject.ts
// ä½¿ç”¨ç›¸å¯¹è·¯å¾„ï¼Œé¿å…è¢«çˆ¶é¡¹ç›®å¼•ç”¨æ—¶è·¯å¾„åˆ«åå†²çª
import type { CoreFn } from "../types/functional";
import { someStep } from "../steps/someStep";
```

### ä¸ºä»€ä¹ˆè¿™æ ·åšæ˜¯ç¬¦åˆè§„èŒƒçš„ï¼Ÿ

1. **é¿å…æ·±å±‚åµŒå¥—**ï¼š`src/core/` å†…éƒ¨å±‚çº§è¾ƒæµ…ï¼ˆé€šå¸¸åªéœ€ `../`ï¼‰ï¼Œä¸ä¼šå‡ºç° `../../../` çš„æƒ…å†µ

2. **æ‰“åŒ…å…¼å®¹**ï¼š`build:lib` ä½¿ç”¨ tsup æ‰“åŒ…æ—¶ï¼Œç›¸å¯¹è·¯å¾„ä¼šè¢«æ­£ç¡®è§£æ

3. **Lovable å…¼å®¹**ï¼šéƒ¨ç½²æ—¶åªç¼–è¯‘ L-App éƒ¨åˆ†ï¼ŒL-Core è¢«æ­£å¸¸å¯¼å…¥ï¼Œä¸å½±å“éƒ¨ç½²

4. **npm åŒ…è§„èŒƒ**ï¼šå‘å¸ƒä¸º npm åŒ…æ—¶ï¼Œç›¸å¯¹è·¯å¾„æ˜¯æ ‡å‡†åšæ³•

### æ£€æŸ¥æ¸…å•

- [ ] `src/core/` ç›®å½•ä¸‹çš„æ‰€æœ‰æ–‡ä»¶ä½¿ç”¨ç›¸å¯¹è·¯å¾„å¯¼å…¥åŒçº§æ¨¡å—
- [ ] `src/app/` ç›®å½•ä¸‹çš„æ–‡ä»¶å¯ä»¥ç»§ç»­ä½¿ç”¨ `@/` åˆ«å
- [ ] å­é¡¹ç›®ç‹¬ç«‹è¿è¡Œæ—¶ï¼Œ`@/` åˆ«åä»ç„¶æœ‰æ•ˆï¼ˆæŒ‡å‘å­é¡¹ç›®çš„ `src/`ï¼‰
- [ ] ä»çˆ¶é¡¹ç›®è¿è¡Œæ—¶ï¼Œç›¸å¯¹è·¯å¾„è¢«æ­£ç¡®è§£æ

---

# æ™ºèƒ½ç¼“å­˜ç³»ç»Ÿè§„èŒƒï¼ˆTanStack Queryï¼‰

> æœ¬ç« èŠ‚è¯¦ç»†ä»‹ç»å¦‚ä½•åœ¨ L-Project ä¸­å®ç°ä¸“ä¸šçº§çš„æ•°æ®ç¼“å­˜ç³»ç»Ÿã€‚é€‚ç”¨äºä»»ä½•ä½¿ç”¨è¿œç¨‹æ•°æ®æºï¼ˆå¦‚ Supabaseã€Firebaseã€REST APIã€GraphQLï¼‰çš„ React åº”ç”¨ã€‚

---

## 9.1 ç¼“å­˜ç­–ç•¥è®¾è®¡åŸåˆ™

### ä¸ºä»€ä¹ˆéœ€è¦å‰ç«¯ç¼“å­˜ï¼Ÿ

| é—®é¢˜ | å½±å“ | ç¼“å­˜è§£å†³æ–¹æ¡ˆ |
|------|------|-------------|
| ç½‘ç»œå»¶è¿Ÿ | é¡µé¢åŠ è½½æ…¢ï¼Œç”¨æˆ·ä½“éªŒå·® | ç¼“å­˜åç¬æ—¶å“åº” |
| é‡å¤è¯·æ±‚ | æµªè´¹å¸¦å®½å’ŒæœåŠ¡å™¨èµ„æº | ç›¸åŒè¯·æ±‚è‡ªåŠ¨å»é‡ |
| é¡µé¢åˆ‡æ¢ | æ¯æ¬¡åˆ‡æ¢éƒ½é‡æ–°åŠ è½½ | ç¼“å­˜å¤ç”¨ï¼Œæ— æ„Ÿåˆ‡æ¢ |
| åˆ·æ–°ä¸¢å¤± | é¡µé¢åˆ·æ–°åé‡æ–°åŠ è½½ | æŒä¹…åŒ–åˆ° localStorage |
| æ•°æ®è¿‡æœŸ | ç”¨æˆ·çœ‹åˆ°æ—§æ•°æ® | æ™ºèƒ½è¿‡æœŸ + åå°åˆ·æ–° |

### ç¼“å­˜ç­–ç•¥ç±»å‹

| ç­–ç•¥ | é€‚ç”¨åœºæ™¯ | staleTime | gcTime | ç¤ºä¾‹ |
|------|---------|-----------|--------|------|
| **æ¿€è¿›ç¼“å­˜** | å‡ ä¹ä¸å˜çš„æ•°æ® | 30+ åˆ†é’Ÿ | 1+ å°æ—¶ | ç³»ç»Ÿé…ç½®ã€æšä¸¾å€¼ |
| **æ ‡å‡†ç¼“å­˜** | ä½é¢‘å˜åŒ–æ•°æ® | 5-10 åˆ†é’Ÿ | 30 åˆ†é’Ÿ | ç”¨æˆ·åˆ—è¡¨ã€å•†å“ç›®å½• |
| **ä¿å®ˆç¼“å­˜** | ä¸­é¢‘å˜åŒ–æ•°æ® | 1-3 åˆ†é’Ÿ | 10 åˆ†é’Ÿ | è®¢å•åˆ—è¡¨ã€æ¶ˆæ¯åˆ—è¡¨ |
| **å®æ—¶æ•°æ®** | é«˜é¢‘å˜åŒ–æ•°æ® | 0-30 ç§’ | 5 åˆ†é’Ÿ | åœ¨çº¿çŠ¶æ€ã€å®æ—¶è®¡æ•° |

### Stale-While-Revalidateï¼ˆSWRï¼‰æ¨¡å¼

TanStack Query é‡‡ç”¨çš„æ ¸å¿ƒç­–ç•¥ï¼š

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Stale-While-Revalidate æ—¶é—´çº¿                     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                      â”‚
â”‚  â”‚  Fresh   â”‚    â”‚  Stale   â”‚    â”‚  Garbage â”‚                      â”‚
â”‚  â”‚  æ–°é²œæœŸ  â”‚â”€â”€â”€â†’â”‚  è¿‡æœŸæœŸ  â”‚â”€â”€â”€â†’â”‚  å›æ”¶æœŸ  â”‚                      â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                      â”‚
â”‚       â”‚               â”‚               â”‚                            â”‚
â”‚       â–¼               â–¼               â–¼                            â”‚
â”‚  ç›´æ¥ä½¿ç”¨ç¼“å­˜    ä½¿ç”¨ç¼“å­˜ +       ç¼“å­˜è¢«æ¸…é™¤                        â”‚
â”‚  ä¸å‘è¯·æ±‚        åå°åˆ·æ–°         éœ€é‡æ–°è·å–                        â”‚
â”‚                                                                     â”‚
â”‚  â—€â”€ staleTime â”€â–¶â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€ gcTime â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶                       â”‚
â”‚                                                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**å…³é”®æ¦‚å¿µ**ï¼š
- `staleTime`ï¼šæ•°æ®"æ–°é²œ"çš„æ—¶é—´ã€‚åœ¨æ­¤æœŸé—´ï¼Œ`useQuery` ç›´æ¥è¿”å›ç¼“å­˜ï¼Œä¸å‘è¯·æ±‚
- `gcTime`ï¼šæ•°æ®åœ¨å†…å­˜ä¸­ä¿ç•™çš„æ—¶é—´ã€‚è¶…è¿‡åè¢«åƒåœ¾å›æ”¶

### é€‰æ‹© TanStack Query çš„ç†ç”±

| å¯¹æ¯”ç»´åº¦ | TanStack Query | SWR | æ‰‹åŠ¨å®ç° |
|---------|----------------|-----|---------|
| å­¦ä¹ æˆæœ¬ | ä¸­ç­‰ | ä½ | é«˜ |
| åŠŸèƒ½å®Œæ•´æ€§ | â˜…â˜…â˜…â˜…â˜… | â˜…â˜…â˜…â˜†â˜† | â˜…â˜…â˜…â˜…â˜…ï¼ˆè‡ªå®šä¹‰ï¼‰ |
| DevTools | âœ… å†…ç½® | âŒ éœ€ç¬¬ä¸‰æ–¹ | âŒ æ—  |
| ç¼“å­˜æŒä¹…åŒ– | âœ… å®˜æ–¹æ”¯æŒ | âš ï¸ éœ€é¢å¤–é…ç½® | âœ… è‡ªå®šä¹‰ |
| Mutation æ”¯æŒ | âœ… å®Œå–„ | âš ï¸ åŸºç¡€ | âœ… è‡ªå®šä¹‰ |
| TypeScript | âœ… å®Œç¾ | âœ… è‰¯å¥½ | âœ… è‡ªå®šä¹‰ |
| ç¤¾åŒºç”Ÿæ€ | â˜…â˜…â˜…â˜…â˜… | â˜…â˜…â˜…â˜…â˜† | - |

---

---

## 9.2 æ¶æ„è®¾è®¡

### æ•´ä½“æ¶æ„å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                           åº”ç”¨å…¥å£ (main.tsx)                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚                    QueryProvider                               â”‚  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚  â”‚
â”‚  â”‚  â”‚                   QueryClient                            â”‚  â”‚  â”‚
â”‚  â”‚  â”‚                                                          â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  â”‚ staleTime   â”‚ â”‚ gcTime      â”‚ â”‚ retry       â”‚        â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  â”‚ æ•°æ®æ–°é²œæœŸ  â”‚ â”‚ å†…å­˜ä¿ç•™æœŸ  â”‚ â”‚ é‡è¯•ç­–ç•¥    â”‚        â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â”‚  â”‚  â”‚
â”‚  â”‚  â”‚                                                          â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  â”‚           Query Cache (å†…å­˜ç¼“å­˜)                 â”‚    â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  â”‚   users â”€â”€â”€ posts â”€â”€â”€ orders â”€â”€â”€ stats          â”‚    â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚  â”‚  â”‚
â”‚  â”‚  â”‚                        â†• åŒå‘åŒæ­¥                        â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  â”‚           localStorage (æŒä¹…åŒ–ç¼“å­˜)              â”‚    â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚  â”‚  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚  â”‚
â”‚  â”‚                                                               â”‚  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚  â”‚
â”‚  â”‚  â”‚            DataManager (é¢„åŠ è½½ + Realtime)              â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  prefetch() â”€â”€â”€ useRealtimeSubscription()               â”‚  â”‚  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                               â†“ æä¾› Context                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚                         App ç»„ä»¶æ ‘                            â”‚  â”‚
â”‚  â”‚     useUsers()    usePosts()    useOrders()    useStats()     â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                â†• æ•°æ®äº¤äº’
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        è¿œç¨‹æ•°æ®æº                                    â”‚
â”‚   Supabase / Firebase / REST API / GraphQL / WebSocket             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### æ¨èæ–‡ä»¶ç»“æ„

```
src/shared/lib/
â”œâ”€â”€ queryClient.ts           # QueryClient é…ç½®ã€ç¼“å­˜ç­–ç•¥ã€æŒä¹…åŒ–é€»è¾‘
â”œâ”€â”€ queries.ts               # æ‰€æœ‰æ•°æ®æŸ¥è¯¢ Hooks å°è£…
â”œâ”€â”€ QueryProvider.tsx        # React Provider + é¢„åŠ è½½ + Realtime
â”œâ”€â”€ realtimeSubscription.ts  # æ•°æ®åº“å®æ—¶è®¢é˜…ï¼ˆå¯é€‰ï¼Œç”¨äº Supabase/Firebaseï¼‰
â””â”€â”€ api.ts                   # æ•°æ®æºå®¢æˆ·ç«¯ï¼ˆSupabase/Axios/Fetchï¼‰
```

### æ ¸å¿ƒç»„ä»¶èŒè´£

| æ–‡ä»¶ | èŒè´£ | æ˜¯å¦å¿…éœ€ |
|------|------|---------|
| `queryClient.ts` | é…ç½®ç¼“å­˜ç­–ç•¥ã€è¿‡æœŸæ—¶é—´ã€é‡è¯•é€»è¾‘ã€æŒä¹…åŒ– | âœ… å¿…éœ€ |
| `queries.ts` | å°è£…æ‰€æœ‰ `useQuery` / `useMutation` hooks | âœ… å¿…éœ€ |
| `QueryProvider.tsx` | åŒ…è£¹åº”ç”¨ï¼Œæä¾› Contextï¼Œå¯åŠ¨é¢„åŠ è½½å’Œè®¢é˜… | âœ… å¿…éœ€ |
| `realtimeSubscription.ts` | ç›‘å¬æ•°æ®åº“å˜åŒ–ï¼Œè‡ªåŠ¨åˆ·æ–°ç¼“å­˜ | âš ï¸ å¯é€‰ |

---

---

## 9.3 å®‰è£…ä¸åŸºç¡€é…ç½®

### 1. å®‰è£…ä¾èµ–

```bash
npm install @tanstack/react-query @tanstack/react-query-devtools
```

### 2. åˆ›å»º QueryClient é…ç½®

```typescript
// src/shared/lib/queryClient.ts

import { QueryClient } from "@tanstack/react-query";

// ============ æ—¶é—´å¸¸é‡ï¼ˆä¾¿äºç»Ÿä¸€ç®¡ç†ï¼‰============
const MINUTE = 60 * 1000;
const HOUR = 60 * MINUTE;

// ============ ç¼“å­˜æ—¶é—´é…ç½® ============
/**
 * æŒ‰ä¸šåŠ¡é¢†åŸŸåˆ’åˆ†ç¼“å­˜ç­–ç•¥
 * 
 * staleTime: æ•°æ®"æ–°é²œ"æ—¶é—´ï¼ŒæœŸé—´ä¸å‘è¯·æ±‚
 * gcTime: æ•°æ®ä¿ç•™æ—¶é—´ï¼Œè¶…è¿‡åä»å†…å­˜åˆ é™¤
 * 
 * åŸåˆ™ï¼š
 * - gcTime >= staleTimeï¼ˆå¦åˆ™æ•°æ®è¿‡æœŸå‰å°±è¢«åˆ äº†ï¼‰
 * - å˜åŒ–é¢‘ç‡é«˜ â†’ staleTime çŸ­
 * - é‡è¦æ€§é«˜ â†’ gcTime é•¿
 */
export const CACHE_TIMES = {
  // é™æ€/é…ç½®ç±»æ•°æ®ï¼šé•¿ç¼“å­˜
  CONFIG: { staleTime: 30 * MINUTE, gcTime: 2 * HOUR },
  
  // åˆ—è¡¨ç±»æ•°æ®ï¼šæ ‡å‡†ç¼“å­˜
  LIST: { staleTime: 5 * MINUTE, gcTime: 30 * MINUTE },
  
  // è¯¦æƒ…ç±»æ•°æ®ï¼šæ ‡å‡†ç¼“å­˜
  DETAIL: { staleTime: 5 * MINUTE, gcTime: 30 * MINUTE },
  
  // çŠ¶æ€ç±»æ•°æ®ï¼šçŸ­ç¼“å­˜ï¼ˆå¦‚ä»»åŠ¡è¿›åº¦ã€è®¢å•çŠ¶æ€ï¼‰
  STATUS: { staleTime: 1 * MINUTE, gcTime: 10 * MINUTE },
  
  // ç»Ÿè®¡ç±»æ•°æ®ï¼šæ ‡å‡†ç¼“å­˜
  STATS: { staleTime: 5 * MINUTE, gcTime: 30 * MINUTE },
  
  // å®æ—¶ç±»æ•°æ®ï¼šæçŸ­ç¼“å­˜æˆ–ä¸ç¼“å­˜
  REALTIME: { staleTime: 10 * 1000, gcTime: 1 * MINUTE },
} as const;

// ============ ç¼“å­˜ç»“æ„ç‰ˆæœ¬ç®¡ç† ============
/**
 * âš ï¸ é‡è¦ï¼šå½“ä¿®æ”¹ queryKeys ç»“æ„æ—¶ï¼Œå¿…é¡»æ›´æ–°æ­¤ç‰ˆæœ¬å·ï¼
 * 
 * è¿™å¯ä»¥ç¡®ä¿ï¼š
 * 1. æ—§çš„ localStorage ç¼“å­˜è¢«è‡ªåŠ¨æ¸…é™¤
 * 2. é¿å…å› ç¼“å­˜é”®ä¸åŒ¹é…å¯¼è‡´çš„æ•°æ®åŠ è½½å¤±è´¥
 * 3. ç”¨æˆ·æ— éœ€æ‰‹åŠ¨æ¸…é™¤æµè§ˆå™¨ç¼“å­˜
 * 
 * ç‰ˆæœ¬æ›´æ–°æ—¶æœºï¼š
 * - æ·»åŠ æ–°çš„ queryKey å‚æ•°
 * - ä¿®æ”¹ queryKey ç»“æ„
 * - ä¿®æ”¹ filters å‚æ•°çš„ç±»å‹
 */
export const CACHE_SCHEMA_VERSION = 1;

// ============ Query Keys å·¥å‚å‡½æ•° ============
/**
 * ä½¿ç”¨å·¥å‚å‡½æ•°ç®¡ç† queryKey çš„ä¼˜åŠ¿ï¼š
 * 1. ç±»å‹å®‰å…¨ï¼ŒIDE è‡ªåŠ¨è¡¥å…¨
 * 2. ç»Ÿä¸€ç®¡ç†ï¼Œé¿å…å­—ç¬¦ä¸²ç¡¬ç¼–ç 
 * 3. æ”¯æŒå±‚çº§å¤±æ•ˆï¼ˆinvalidate users.all ä¼šå¤±æ•ˆæ‰€æœ‰ users ç›¸å…³ç¼“å­˜ï¼‰
 * 
 * âš ï¸ ä¿®æ”¹æ­¤ç»“æ„åï¼Œå¿…é¡»åŒæ—¶æ›´æ–° CACHE_SCHEMA_VERSIONï¼
 */
export const queryKeys = {
  // ç”¨æˆ·ç›¸å…³
  users: {
    all: ["users"] as const,
    list: (filters?: Record<string, unknown>) => 
      [...queryKeys.users.all, "list", filters] as const,
    detail: (id: string) => 
      [...queryKeys.users.all, "detail", id] as const,
  },
  
  // æ–‡ç« /å†…å®¹ç›¸å…³
  posts: {
    all: ["posts"] as const,
    list: (filters?: Record<string, unknown>) => 
      [...queryKeys.posts.all, "list", filters] as const,
    detail: (id: string) => 
      [...queryKeys.posts.all, "detail", id] as const,
    byAuthor: (authorId: string) => 
      [...queryKeys.posts.all, "author", authorId] as const,
  },
  
  // è®¢å•/ä»»åŠ¡ç›¸å…³
  orders: {
    all: ["orders"] as const,
    list: (filters?: Record<string, unknown>) => 
      [...queryKeys.orders.all, "list", filters] as const,
    detail: (id: string) => 
      [...queryKeys.orders.all, "detail", id] as const,
  },
  
  // ç»Ÿè®¡æ•°æ®
  stats: {
    all: ["stats"] as const,
    dashboard: () => [...queryKeys.stats.all, "dashboard"] as const,
    report: (type: string) => [...queryKeys.stats.all, "report", type] as const,
  },
} as const;

// ============ åˆ›å»º QueryClient ============
export function createQueryClient(): QueryClient {
  return new QueryClient({
    defaultOptions: {
      queries: {
        // é»˜è®¤ç¼“å­˜ç­–ç•¥
        staleTime: 5 * MINUTE,
        gcTime: 30 * MINUTE,
        
        // æ™ºèƒ½é‡è¯•ç­–ç•¥
        retry: (failureCount, error) => {
          // æœ€å¤šé‡è¯• 3 æ¬¡
          if (failureCount >= 3) return false;
          
          // å®¢æˆ·ç«¯é”™è¯¯ä¸é‡è¯•ï¼ˆå¦‚ 401ã€403ã€404ï¼‰
          if (error && typeof error === "object" && "status" in error) {
            const status = (error as { status: number }).status;
            if (status >= 400 && status < 500) return false;
          }
          
          return true;
        },
        
        // æŒ‡æ•°é€€é¿é‡è¯•å»¶è¿Ÿï¼š1s â†’ 2s â†’ 4sï¼ˆæœ€å¤§ 30sï¼‰
        retryDelay: (attemptIndex) => 
          Math.min(1000 * 2 ** attemptIndex, 30000),
        
        // ç”¨æˆ·è¡Œä¸ºè§¦å‘åˆ·æ–°
        refetchOnWindowFocus: true,   // åˆ‡æ¢æ ‡ç­¾é¡µå›æ¥æ—¶
        refetchOnReconnect: true,     // ç½‘ç»œæ¢å¤æ—¶
        refetchOnMount: true,         // ç»„ä»¶æŒ‚è½½æ—¶ï¼ˆå¦‚æœ staleï¼‰
      },
      
      mutations: {
        // Mutation ä¹Ÿå¯ä»¥é…ç½®é‡è¯•
        retry: 1,
      },
    },
  });
}
```

### Query Keys è®¾è®¡æ¨¡å¼

```typescript
// âœ… æ¨èï¼šä½¿ç”¨å·¥å‚å‡½æ•°
queryKeys.posts.list({ status: "published" })  // ["posts", "list", { status: "published" }]
queryKeys.posts.detail("123")                   // ["posts", "detail", "123"]

// âŒ é¿å…ï¼šç¡¬ç¼–ç å­—ç¬¦ä¸²
["posts", "list", { status: "published" }]  // å®¹æ˜“æ‹¼å†™é”™è¯¯ï¼Œéš¾ä»¥ç»´æŠ¤

// å±‚çº§å¤±æ•ˆç¤ºä¾‹
queryClient.invalidateQueries({ queryKey: queryKeys.posts.all });
// è¿™ä¼šå¤±æ•ˆæ‰€æœ‰ä»¥ ["posts"] å¼€å¤´çš„æŸ¥è¯¢ï¼ŒåŒ…æ‹¬ list å’Œ detail
```

### 3. åˆ›å»º Provider

```typescript
// src/shared/lib/QueryProvider.tsx

import React, { useEffect, useState } from "react";
import { QueryClientProvider } from "@tanstack/react-query";
import { ReactQueryDevtools } from "@tanstack/react-query-devtools";
import { createQueryClient } from "./queryClient";
import { usePrefetchCoreData } from "./queries";
import { useRealtimeSubscription } from "./realtimeSubscription"; // å¯é€‰

// å•ä¾‹æ¨¡å¼ï¼šç¡®ä¿æ•´ä¸ªåº”ç”¨åªæœ‰ä¸€ä¸ª QueryClient
const queryClient = createQueryClient();

/**
 * æ•°æ®ç®¡ç†å™¨ï¼šè´Ÿè´£é¢„åŠ è½½å’Œå®æ—¶è®¢é˜…
 * ä½¿ç”¨å†…éƒ¨ç»„ä»¶æ¨¡å¼ï¼Œç¡®ä¿åœ¨ QueryClientProvider å†…éƒ¨æ‰§è¡Œ
 */
function DataManager() {
  const prefetch = usePrefetchCoreData();
  
  useEffect(() => {
    // åº”ç”¨å¯åŠ¨æ—¶é¢„åŠ è½½æ ¸å¿ƒæ•°æ®
    prefetch();
  }, [prefetch]);
  
  // å¯é€‰ï¼šè®¢é˜…æ•°æ®åº“å˜åŒ–ï¼Œè‡ªåŠ¨åˆ·æ–°ç¼“å­˜
  useRealtimeSubscription();
  
  return null;
}

interface QueryProviderProps {
  children: React.ReactNode;
}

export function QueryProvider({ children }: QueryProviderProps) {
  const [showDevtools, setShowDevtools] = useState(false);
  
  // å¼€å‘ç¯å¢ƒå¿«æ·é”®åˆ‡æ¢ DevToolsï¼ˆCtrl+Shift+Dï¼‰
  useEffect(() => {
    if (!import.meta.env.DEV) return;
    
    const handleKeyDown = (e: KeyboardEvent) => {
      if (e.ctrlKey && e.shiftKey && e.key === "D") {
        setShowDevtools((prev) => !prev);
      }
    };
    
    window.addEventListener("keydown", handleKeyDown);
    return () => window.removeEventListener("keydown", handleKeyDown);
  }, []);
  
  return (
    <QueryClientProvider client={queryClient}>
      <DataManager />
      {children}
      {import.meta.env.DEV && showDevtools && (
        <ReactQueryDevtools initialIsOpen={false} position="bottom" />
      )}
    </QueryClientProvider>
  );
}

// å¯¼å‡º queryClient ä¾›é React ä»£ç ä½¿ç”¨
export { queryClient };
```

### 4. åœ¨åº”ç”¨å…¥å£ä½¿ç”¨

```typescript
// src/main.tsx
import React from "react";
import ReactDOM from "react-dom/client";
import { BrowserRouter } from "react-router-dom";
import App from "./App";
import { QueryProvider } from "@/shared/lib/QueryProvider";
import "./index.css";

ReactDOM.createRoot(document.getElementById("root")!).render(
  <React.StrictMode>
    <QueryProvider>
      <BrowserRouter>
        <App />
      </BrowserRouter>
    </QueryProvider>
  </React.StrictMode>
);
```

**æ³¨æ„**ï¼š`QueryProvider` åº”è¯¥åŒ…è£¹åœ¨ `BrowserRouter` å¤–å±‚æˆ–åŒçº§ï¼Œç¡®ä¿æ‰€æœ‰è·¯ç”±éƒ½èƒ½è®¿é—®ç¼“å­˜ã€‚

---

---

## 9.4 åˆ›å»ºæ•°æ®æŸ¥è¯¢ Hooks

### åŸºæœ¬æŸ¥è¯¢ Hook

```typescript
// src/shared/lib/queries.ts

import { useQuery, useMutation, useQueryClient, useCallback } from "@tanstack/react-query";
import { api } from "./api";  // ä½ çš„æ•°æ®æºå®¢æˆ·ç«¯
import { queryKeys, CACHE_TIMES } from "./queryClient";

// ============ ç±»å‹å®šä¹‰ ============
export interface User {
  id: string;
  name: string;
  email: string;
  avatar?: string;
  createdAt: string;
}

export interface Post {
  id: string;
  title: string;
  content: string;
  authorId: string;
  status: "draft" | "published" | "archived";
  createdAt: string;
}

// ============ åˆ—è¡¨æŸ¥è¯¢ Hook ============

/**
 * è·å–ç”¨æˆ·åˆ—è¡¨
 * 
 * ç‰¹ç‚¹ï¼š
 * - æ”¯æŒè¿‡æ»¤æ¡ä»¶
 * - è‡ªåŠ¨ç¼“å­˜
 * - æ”¯æŒæ¡ä»¶ç¦ç”¨
 */
export function useUsers(options?: { 
  role?: string;
  enabled?: boolean;
}) {
  const { role, enabled = true } = options || {};
  
  return useQuery({
    queryKey: queryKeys.users.list({ role }),
    queryFn: async (): Promise<User[]> => {
      const response = await api.get("/users", { params: { role } });
      return response.data;
    },
    enabled,  // å¯ä»¥åŠ¨æ€æ§åˆ¶æ˜¯å¦æ‰§è¡ŒæŸ¥è¯¢
    ...CACHE_TIMES.LIST,
  });
}

/**
 * è·å–æ–‡ç« åˆ—è¡¨
 * 
 * æ”¯æŒå¤æ‚è¿‡æ»¤æ¡ä»¶
 */
export function usePosts(options?: { 
  status?: string;
  authorId?: string;
  search?: string;
}) {
  const { status, authorId, search } = options || {};
  
  return useQuery({
    queryKey: queryKeys.posts.list({ status, authorId, search }),
    queryFn: async (): Promise<Post[]> => {
      let query = api.from("posts").select("*");
      
      if (status) query = query.eq("status", status);
      if (authorId) query = query.eq("author_id", authorId);
      if (search) query = query.ilike("title", `%${search}%`);
      
      const { data, error } = await query.order("created_at", { ascending: false });
      if (error) throw error;
      return data || [];
    },
    ...CACHE_TIMES.LIST,
  });
}

// ============ è¯¦æƒ…æŸ¥è¯¢ Hook ============

/**
 * è·å–å•ä¸ªèµ„æº
 * 
 * ç‰¹ç‚¹ï¼š
 * - ä½¿ç”¨ enabled é˜²æ­¢æ— æ•ˆè¯·æ±‚
 * - è‡ªåŠ¨åˆ©ç”¨åˆ—è¡¨ç¼“å­˜ï¼ˆå¯é€‰ï¼‰
 */
export function usePost(postId: string | undefined) {
  return useQuery({
    queryKey: queryKeys.posts.detail(postId || ""),
    queryFn: async () => {
      if (!postId) return null;
      
      const { data, error } = await api
        .from("posts")
        .select("*")
        .eq("id", postId)
        .single();
      
      if (error) throw error;
      return data;
    },
    enabled: !!postId,  // åªæœ‰ id å­˜åœ¨æ—¶æ‰æ‰§è¡Œ
    ...CACHE_TIMES.DETAIL,
  });
}

// ============ ç»Ÿè®¡æŸ¥è¯¢ Hook ============

/**
 * è·å–ä»ªè¡¨ç›˜ç»Ÿè®¡æ•°æ®
 */
export function useDashboardStats() {
  return useQuery({
    queryKey: queryKeys.stats.dashboard(),
    queryFn: async () => {
      const { data, error } = await api.rpc("get_dashboard_stats");
      if (error) throw error;
      return data;
    },
    ...CACHE_TIMES.STATS,
  });
}
```

### å˜æ›´æ“ä½œ Hookï¼ˆMutationï¼‰

```typescript
// ============ åˆ›å»ºæ“ä½œ ============

/**
 * åˆ›å»ºæ–‡ç« 
 */
export function useCreatePost() {
  const queryClient = useQueryClient();
  
  return useMutation({
    mutationFn: async (newPost: Omit<Post, "id" | "createdAt">) => {
      const { data, error } = await api
        .from("posts")
        .insert(newPost)
        .select()
        .single();
      
      if (error) throw error;
      return data;
    },
    onSuccess: (newPost) => {
      // âœ… ä½¿åˆ—è¡¨ç¼“å­˜å¤±æ•ˆ
      queryClient.invalidateQueries({ queryKey: queryKeys.posts.all });
      
      // âœ… å¯é€‰ï¼šç›´æ¥æ›´æ–°åˆ—è¡¨ç¼“å­˜ï¼ˆä¹è§‚æ›´æ–°ï¼‰
      // queryClient.setQueryData(queryKeys.posts.list(), (old: Post[]) => 
      //   old ? [newPost, ...old] : [newPost]
      // );
    },
  });
}

// ============ æ›´æ–°æ“ä½œ ============

/**
 * æ›´æ–°æ–‡ç« 
 */
export function useUpdatePost() {
  const queryClient = useQueryClient();
  
  return useMutation({
    mutationFn: async ({ id, ...updates }: Partial<Post> & { id: string }) => {
      const { data, error } = await api
        .from("posts")
        .update(updates)
        .eq("id", id)
        .select()
        .single();
      
      if (error) throw error;
      return data;
    },
    onSuccess: (updatedPost) => {
      // âœ… ä½¿è¯¦æƒ…ç¼“å­˜å¤±æ•ˆ
      queryClient.invalidateQueries({ 
        queryKey: queryKeys.posts.detail(updatedPost.id) 
      });
      // âœ… ä½¿åˆ—è¡¨ç¼“å­˜å¤±æ•ˆ
      queryClient.invalidateQueries({ queryKey: queryKeys.posts.all });
    },
  });
}

// ============ åˆ é™¤æ“ä½œ ============

/**
 * åˆ é™¤æ–‡ç« 
 */
export function useDeletePost() {
  const queryClient = useQueryClient();
  
  return useMutation({
    mutationFn: async (postId: string) => {
      const { error } = await api
        .from("posts")
        .delete()
        .eq("id", postId);
      
      if (error) throw error;
      return postId;
    },
    onSuccess: (deletedId) => {
      // âœ… ä½¿æ‰€æœ‰æ–‡ç« ç›¸å…³ç¼“å­˜å¤±æ•ˆ
      queryClient.invalidateQueries({ queryKey: queryKeys.posts.all });
      
      // âœ… ç§»é™¤è¯¦æƒ…ç¼“å­˜
      queryClient.removeQueries({ 
        queryKey: queryKeys.posts.detail(deletedId) 
      });
    },
  });
}
```

### Mutation æœ€ä½³å®è·µ

| æ¨¡å¼ | è¯´æ˜ | ä½¿ç”¨åœºæ™¯ |
|------|------|---------|
| **invalidateQueries** | ä½¿ç¼“å­˜å¤±æ•ˆï¼Œä¸‹æ¬¡è®¿é—®æ—¶é‡æ–°è·å– | æœ€å¸¸ç”¨ï¼Œä¿è¯æ•°æ®ä¸€è‡´æ€§ |
| **setQueryData** | ç›´æ¥æ›´æ–°ç¼“å­˜æ•°æ® | ä¹è§‚æ›´æ–°ï¼Œæå‡å“åº”é€Ÿåº¦ |
| **removeQueries** | ä»ç¼“å­˜ä¸­ç§»é™¤æ•°æ® | åˆ é™¤æ“ä½œåæ¸…ç† |

---

## 9.5 ç¼“å­˜æŒä¹…åŒ–

### æŒä¹…åŒ–åˆ° localStorage

```typescript
// src/shared/lib/queryClient.tsï¼ˆè¡¥å……ï¼‰

const PERSISTER_KEY = "app_query_cache";

/**
 * ä¿å­˜ç¼“å­˜åˆ° localStorage
 * 
 * æ³¨æ„ï¼šä½¿ç”¨ CACHE_SCHEMA_VERSION ç¡®ä¿ç¼“å­˜ç»“æ„å˜æ›´æ—¶è‡ªåŠ¨æ¸…é™¤æ—§æ•°æ®
 */
function persistQueryCache(queryClient: QueryClient): void {
  try {
    const cache = queryClient.getQueryCache();
    const queries = cache.getAll();
    
    // åªæŒä¹…åŒ–æˆåŠŸçš„æŸ¥è¯¢
    const persistableQueries = queries
      .filter(query => query.state.status === "success" && query.state.data)
      .map(query => ({
        queryKey: query.queryKey,
        data: query.state.data,
        dataUpdatedAt: query.state.dataUpdatedAt,
      }));
    
    localStorage.setItem(PERSISTER_KEY, JSON.stringify({
      version: CACHE_SCHEMA_VERSION,  // âš ï¸ ä½¿ç”¨ç‰ˆæœ¬å¸¸é‡
      timestamp: Date.now(),
      queries: persistableQueries,
    }));
  } catch (error) {
    console.warn("[Cache] æŒä¹…åŒ–å¤±è´¥:", error);
  }
}

/**
 * ä» localStorage æ¢å¤ç¼“å­˜
 * 
 * ç‰ˆæœ¬ä¸åŒ¹é…æ—¶è‡ªåŠ¨æ¸…é™¤ï¼Œé¿å…å›  queryKey ç»“æ„å˜åŒ–å¯¼è‡´çš„é—®é¢˜
 */
function hydrateQueryCache(queryClient: QueryClient): void {
  try {
    const stored = localStorage.getItem(PERSISTER_KEY);
    if (!stored) return;
    
    const { version, timestamp, queries } = JSON.parse(stored);
    
    // âš ï¸ ç‰ˆæœ¬æ£€æŸ¥ï¼šqueryKey ç»“æ„å˜åŒ–æ—¶ï¼Œæ—§ç¼“å­˜ä¼šè¢«è‡ªåŠ¨æ¸…é™¤
    if (version !== CACHE_SCHEMA_VERSION) {
      console.log(`[Cache] ç‰ˆæœ¬ä¸åŒ¹é… (ç¼“å­˜: v${version}, å½“å‰: v${CACHE_SCHEMA_VERSION})ï¼Œæ¸…é™¤æ—§ç¼“å­˜`);
      localStorage.removeItem(PERSISTER_KEY);
      return;
    }
    
    // è¿‡æœŸæ£€æŸ¥ï¼ˆ24å°æ—¶ï¼‰
    if (Date.now() - timestamp > 24 * 60 * 60 * 1000) {
      console.log("[Cache] ç¼“å­˜å·²è¿‡æœŸï¼Œæ¸…é™¤");
      localStorage.removeItem(PERSISTER_KEY);
      return;
    }
    
    // æ¢å¤æ•°æ®
    for (const { queryKey, data, dataUpdatedAt } of queries) {
      queryClient.setQueryData(queryKey, data, { updatedAt: dataUpdatedAt });
    }
    
    console.log(`[Cache] å·²æ¢å¤ ${queries.length} ä¸ªæŸ¥è¯¢`);
  } catch (error) {
    console.warn("[Cache] æ¢å¤å¤±è´¥ï¼Œæ¸…é™¤ç¼“å­˜:", error);
    localStorage.removeItem(PERSISTER_KEY);
  }
}
```

### âš ï¸ é‡è¦ï¼šç¼“å­˜ç‰ˆæœ¬ç®¡ç†è§„åˆ™

å½“ä¿®æ”¹ `queryKeys` ç»“æ„æ—¶ï¼Œ**å¿…é¡»**åŒæ—¶æ›´æ–° `CACHE_SCHEMA_VERSION`ï¼š

```typescript
// éœ€è¦æ›´æ–°ç‰ˆæœ¬çš„æƒ…å†µï¼š
// 1. æ·»åŠ æ–°çš„ queryKey å‚æ•°
queryKeys.posts.list({ withImages: true, withFirstImage: true })  // æ–°å¢ withFirstImage

// 2. ä¿®æ”¹ queryKey ç»“æ„
queryKeys.posts.detail(id)  // å˜æ›´ä¸º queryKeys.posts.byId(id)

// 3. ä¿®æ”¹ filters å‚æ•°ç±»å‹
queryKeys.users.list({ role: "admin" })  // role ç±»å‹ä» string å˜ä¸º enum
```

**ç‰ˆæœ¬æ›´æ–°æµç¨‹ï¼š**

1. ä¿®æ”¹ `queryKeys` ç»“æ„
2. æ›´æ–° `CACHE_SCHEMA_VERSION`ï¼ˆ+1ï¼‰
3. åœ¨ç‰ˆæœ¬å†å²æ³¨é‡Šä¸­è®°å½•å˜æ›´

```typescript
/**
 * ç¼“å­˜ç»“æ„ç‰ˆæœ¬å·
 * 
 * ç‰ˆæœ¬å†å²ï¼š
 * - v1: åˆå§‹ç‰ˆæœ¬
 * - v2: posts.list æ·»åŠ  withFirstImage å‚æ•°
 * - v3: users.list æ·»åŠ  role è¿‡æ»¤
 */
export const CACHE_SCHEMA_VERSION = 3;
```

### åœ¨ QueryClient åˆ›å»ºæ—¶é›†æˆ

```typescript
export function createQueryClient(): QueryClient {
  const queryClient = new QueryClient({ /* ... */ });
  
  // æ¢å¤æŒä¹…åŒ–ç¼“å­˜
  hydrateQueryCache(queryClient);
  
  // å®šæœŸæŒä¹…åŒ–ï¼ˆæ¯ 30 ç§’ï¼‰
  setInterval(() => persistQueryCache(queryClient), 30 * 1000);
  
  // é¡µé¢å…³é—­å‰æŒä¹…åŒ–
  window.addEventListener("beforeunload", () => {
    persistQueryCache(queryClient);
  });
  
  // é¡µé¢éšè—æ—¶æŒä¹…åŒ–
  document.addEventListener("visibilitychange", () => {
    if (document.visibilityState === "hidden") {
      persistQueryCache(queryClient);
    }
  });
  
  return queryClient;
}
```

---

---

## 9.6 ç¼“å­˜åŒæ­¥ç­–ç•¥

### é—®é¢˜ï¼šæ“ä½œåæ•°æ®ä¸åŒæ­¥

å½“ç”¨æˆ·æ‰§è¡Œå†™æ“ä½œåï¼Œå¦‚æœä¸åˆ·æ–°ç¼“å­˜ï¼ŒUI ä¼šæ˜¾ç¤ºæ—§æ•°æ®ã€‚

### ä¸‰ç§åŒæ­¥æ–¹æ¡ˆå¯¹æ¯”

| æ–¹æ¡ˆ | åŸç† | ä¼˜ç‚¹ | ç¼ºç‚¹ | é€‚ç”¨åœºæ™¯ |
|------|------|------|------|---------|
| **Mutation å›è°ƒ** | æ“ä½œæˆåŠŸåæ‰‹åŠ¨åˆ·æ–° | ç®€å•å¯é  | éœ€è¦æ‰‹åŠ¨ç»´æŠ¤ | å•ç”¨æˆ·æ“ä½œ |
| **Realtime è®¢é˜…** | ç›‘å¬æ•°æ®åº“å˜åŒ–è‡ªåŠ¨åˆ·æ–° | è‡ªåŠ¨ã€æ”¯æŒå¤šç«¯åŒæ­¥ | éœ€è¦æ•°æ®åº“æ”¯æŒ | å¤šç«¯åä½œ |
| **è½®è¯¢** | å®šæ—¶åˆ·æ–° | ç®€å•ï¼Œä¸ä¾èµ–ç‰¹æ®ŠåŠŸèƒ½ | æœ‰å»¶è¿Ÿï¼Œæµªè´¹èµ„æº | å…œåº•æ–¹æ¡ˆ |

### æ–¹æ¡ˆ 1ï¼šMutation å›è°ƒï¼ˆåŸºç¡€æ–¹æ¡ˆï¼‰

```typescript
export function useDeleteItem() {
  const queryClient = useQueryClient();
  
  return useMutation({
    mutationFn: deleteItem,
    onSuccess: () => {
      // âœ… ä½¿æ‰€æœ‰ç›¸å…³ç¼“å­˜å¤±æ•ˆ
      queryClient.invalidateQueries({ queryKey: queryKeys.items.all });
      queryClient.invalidateQueries({ queryKey: queryKeys.stats.all });
    },
    onError: (error) => {
      console.error("åˆ é™¤å¤±è´¥:", error);
    },
  });
}
```

### æ–¹æ¡ˆ 2ï¼šRealtime è®¢é˜…ï¼ˆæ¨èæ–¹æ¡ˆï¼‰

**é€‚ç”¨äº**ï¼šSupabaseã€Firebaseã€Hasura ç­‰æ”¯æŒ Realtime çš„æ•°æ®åº“ã€‚

**æ ¸å¿ƒæ€è·¯**ï¼šè®¢é˜…æ•°æ®åº“è¡¨å˜åŒ– â†’ è§¦å‘ç¼“å­˜åˆ·æ–° â†’ UI è‡ªåŠ¨æ›´æ–°

```typescript
// src/shared/lib/realtimeSubscription.ts

import { useEffect, useRef } from "react";
import type { RealtimeChannel } from "@supabase/supabase-js";

const DEBOUNCE_DELAY = 1000; // é˜²æŠ–å»¶è¿Ÿï¼ˆæ¯«ç§’ï¼‰

/**
 * æ•°æ®åº“å®æ—¶è®¢é˜… Hook
 * 
 * åŠŸèƒ½ï¼š
 * 1. ç›‘å¬æŒ‡å®šè¡¨çš„ INSERT/UPDATE/DELETE äº‹ä»¶
 * 2. ä½¿ç”¨é˜²æŠ–é¿å…é¢‘ç¹åˆ·æ–°
 * 3. æ ¹æ®è¡¨åæ˜ å°„åˆ°å¯¹åº”çš„ç¼“å­˜åˆ†ç±»
 * 4. ç»„ä»¶å¸è½½æ—¶è‡ªåŠ¨æ¸…ç†è®¢é˜…
 */
export function useRealtimeSubscription() {
  const channelRef = useRef<RealtimeChannel | null>(null);
  const debounceTimers = useRef<Record<string, NodeJS.Timeout>>({});

  useEffect(() => {
    // é˜²æŠ–åˆ·æ–°å‡½æ•°
    const debouncedRefresh = (cacheType: string) => {
      if (debounceTimers.current[cacheType]) {
        clearTimeout(debounceTimers.current[cacheType]);
      }
      
      debounceTimers.current[cacheType] = setTimeout(async () => {
        console.log(`[Realtime] æ£€æµ‹åˆ° ${cacheType} å˜åŒ–ï¼Œåˆ·æ–°ç¼“å­˜...`);
        await invalidateData(cacheType);
      }, DEBOUNCE_DELAY);
    };

    // è¡¨å â†’ ç¼“å­˜ç±»å‹ æ˜ å°„é…ç½®
    const tableMapping: Record<string, string> = {
      users: "users",
      posts: "posts", 
      comments: "posts",     // è¯„è®ºå˜åŒ–ä¹Ÿåˆ·æ–°å¸–å­
      orders: "orders",
      order_items: "orders", // è®¢å•é¡¹å˜åŒ–ä¹Ÿåˆ·æ–°è®¢å•
    };

    // åˆ›å»ºè®¢é˜…é¢‘é“
    const channel = database.channel("db-changes");
    
    // ä¸ºæ¯ä¸ªè¡¨æ·»åŠ ç›‘å¬
    Object.entries(tableMapping).forEach(([table, cacheType]) => {
      channel.on("postgres_changes", {
        event: "*",  // INSERT, UPDATE, DELETE
        schema: "public",
        table,
      }, (payload) => {
        console.log(`[Realtime] ${table} ${payload.eventType}`);
        debouncedRefresh(cacheType);
        
        // ç‰¹æ®Šé€»è¾‘ï¼šæŸäº›æ“ä½œå®Œæˆæ—¶åˆ·æ–°æ‰€æœ‰ç¼“å­˜
        if (payload.eventType === "UPDATE" && table === "tasks") {
          const newRecord = payload.new as { status?: string };
          if (newRecord.status === "completed") {
            debouncedRefresh("all");
          }
        }
      });
    });

    // å¯åŠ¨è®¢é˜…
    channel.subscribe((status) => {
      if (status === "SUBSCRIBED") {
        console.log("[Realtime] âœ… å·²è®¢é˜…æ•°æ®åº“å˜åŒ–");
      } else if (status === "CHANNEL_ERROR") {
        console.warn("[Realtime] âŒ è®¢é˜…å¤±è´¥");
      }
    });

    channelRef.current = channel;

    // æ¸…ç†å‡½æ•°
    return () => {
      Object.values(debounceTimers.current).forEach(clearTimeout);
      debounceTimers.current = {};
      
      if (channelRef.current) {
        database.removeChannel(channelRef.current);
        channelRef.current = null;
      }
    };
  }, []);
}
```

**å·¥ä½œæµç¨‹å›¾**ï¼š

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     Realtime ç¼“å­˜åŒæ­¥æµç¨‹                            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                     â”‚
â”‚  æ•°æ®åº“å˜åŒ–                                                          â”‚
â”‚      â”‚                                                              â”‚
â”‚      â–¼                                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                                â”‚
â”‚  â”‚ Realtime æ¨é€   â”‚  WebSocket å®æ—¶é€šçŸ¥                            â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                                â”‚
â”‚           â”‚                                                         â”‚
â”‚           â–¼                                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                                â”‚
â”‚  â”‚ é˜²æŠ–å¤„ç†        â”‚  1 ç§’å†…çš„å¤šæ¬¡å˜åŒ–åˆå¹¶ä¸ºä¸€æ¬¡åˆ·æ–°                  â”‚
â”‚  â”‚ (1000ms)        â”‚                                                â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                                â”‚
â”‚           â”‚                                                         â”‚
â”‚           â–¼                                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                                â”‚
â”‚  â”‚ è¡¨ â†’ ç¼“å­˜æ˜ å°„   â”‚  posts è¡¨ â†’ posts ç¼“å­˜                         â”‚
â”‚  â”‚                 â”‚  order_items è¡¨ â†’ orders ç¼“å­˜                  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                                â”‚
â”‚           â”‚                                                         â”‚
â”‚           â–¼                                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                                â”‚
â”‚  â”‚ invalidateData  â”‚  æ ‡è®°ç¼“å­˜ä¸º stale                              â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                                â”‚
â”‚           â”‚                                                         â”‚
â”‚           â–¼                                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                                â”‚
â”‚  â”‚ React Query     â”‚  åå°é‡æ–°è·å–æ•°æ®                               â”‚
â”‚  â”‚ è‡ªåŠ¨ refetch    â”‚                                                â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                                â”‚
â”‚           â”‚                                                         â”‚
â”‚           â–¼                                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                                â”‚
â”‚  â”‚ UI è‡ªåŠ¨æ›´æ–°     â”‚  ç»„ä»¶å“åº”å¼æ¸²æŸ“æ–°æ•°æ®                           â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                                â”‚
â”‚                                                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**è¡¨ä¸ç¼“å­˜æ˜ å°„è®¾è®¡åŸåˆ™**ï¼š

| æ˜ å°„ç­–ç•¥ | è¯´æ˜ | ç¤ºä¾‹ |
|---------|------|------|
| **ä¸€å¯¹ä¸€** | è¡¨ç›´æ¥å¯¹åº”ç¼“å­˜ | `users` â†’ `users` |
| **å¤šå¯¹ä¸€** | å¤šä¸ªè¡¨å…±äº«ä¸€ä¸ªç¼“å­˜ | `comments`, `likes` â†’ `posts` |
| **è§¦å‘å…¨é‡** | ç‰¹å®šæ“ä½œåˆ·æ–°æ‰€æœ‰ç¼“å­˜ | ä»»åŠ¡å®Œæˆ â†’ `all` |

### æ–¹æ¡ˆ 3ï¼šé React ä»£ç è§¦å‘åˆ·æ–°

```typescript
// src/shared/lib/queries.ts

/**
 * å…¨å±€ç¼“å­˜åˆ·æ–°å‡½æ•°
 * 
 * é€‚ç”¨åœºæ™¯ï¼š
 * - åœ¨ service å±‚å¤„ç†å®Œå¤æ‚æ“ä½œå
 * - åœ¨ Web Worker ä¸­å®Œæˆä»»åŠ¡å
 * - åœ¨å®šæ—¶ä»»åŠ¡å®Œæˆå
 */
export async function invalidateAllData(): Promise<void> {
  const { queryClient } = await import("./QueryProvider");
  
  await Promise.all([
    queryClient.invalidateQueries({ queryKey: queryKeys.users.all }),
    queryClient.invalidateQueries({ queryKey: queryKeys.posts.all }),
    queryClient.invalidateQueries({ queryKey: queryKeys.orders.all }),
    queryClient.invalidateQueries({ queryKey: queryKeys.stats.all }),
  ]);
  
  console.log("[Cache] å…¨å±€ç¼“å­˜åˆ·æ–°å®Œæˆ");
}

/**
 * æŒ‰ç±»å‹åˆ·æ–°ç¼“å­˜
 */
export async function invalidateData(type: string): Promise<void> {
  const { queryClient } = await import("./QueryProvider");
  
  if (type === "all") {
    return invalidateAllData();
  }
  
  const keyMap: Record<string, readonly string[]> = {
    users: queryKeys.users.all,
    posts: queryKeys.posts.all,
    orders: queryKeys.orders.all,
    stats: queryKeys.stats.all,
  };
  
  const key = keyMap[type];
  if (key) {
    await queryClient.invalidateQueries({ queryKey: key });
    console.log(`[Cache] å·²åˆ·æ–° ${type} ç¼“å­˜`);
  }
}
```

**åœ¨ Service å±‚è°ƒç”¨**ï¼š

```typescript
// src/core/services/orderService.ts

export async function processLargeOrder(orderId: string) {
  // ... å¤æ‚çš„ä¸šåŠ¡å¤„ç† ...
  
  // âœ… å¤„ç†å®Œæˆåè§¦å‘ç¼“å­˜åˆ·æ–°
  if (typeof window !== "undefined") {
    const { invalidateAllData } = await import("@/shared/lib/queries");
    await invalidateAllData();
  }
}
```

---

## 9.7 åœ¨é¡µé¢ç»„ä»¶ä¸­ä½¿ç”¨

### åŸºæœ¬ä½¿ç”¨æ¨¡å¼

```typescript
// src/app/pages/PostListPage.tsx

import { usePosts } from "@/shared/lib/queries";
import { useState } from "react";

export const PostListPage: React.FC = () => {
  const [status, setStatus] = useState<string>("published");
  
  const { 
    data: posts = [],     // æ•°æ®ï¼Œå¸¦é»˜è®¤å€¼
    isLoading,            // é¦–æ¬¡åŠ è½½ä¸­
    isFetching,           // ä»»ä½•è·å–ä¸­ï¼ˆåŒ…æ‹¬åå°åˆ·æ–°ï¼‰
    isError,              // æ˜¯å¦å‡ºé”™
    error,                // é”™è¯¯å¯¹è±¡
    dataUpdatedAt,        // æ•°æ®æœ€åæ›´æ–°æ—¶é—´æˆ³
    refetch,              // æ‰‹åŠ¨åˆ·æ–°å‡½æ•°
  } = usePosts({ status });
  
  // æ ¼å¼åŒ–æœ€åæ›´æ–°æ—¶é—´
  const formatLastUpdated = () => {
    if (!dataUpdatedAt) return "";
    const seconds = Math.floor((Date.now() - dataUpdatedAt) / 1000);
    if (seconds < 60) return `${seconds}ç§’å‰æ›´æ–°`;
    const minutes = Math.floor(seconds / 60);
    if (minutes < 60) return `${minutes}åˆ†é’Ÿå‰æ›´æ–°`;
    return `${Math.floor(minutes / 60)}å°æ—¶å‰æ›´æ–°`;
  };

  // åŠ è½½çŠ¶æ€
  if (isLoading) {
    return <LoadingSpinner />;
  }

  // é”™è¯¯çŠ¶æ€
  if (isError) {
    return (
      <div className="error">
        <p>åŠ è½½å¤±è´¥ï¼š{error?.message}</p>
        <button onClick={() => refetch()}>é‡è¯•</button>
      </div>
    );
  }

  return (
    <div>
      {/* çŠ¶æ€æ ï¼šæ˜¾ç¤ºç¼“å­˜çŠ¶æ€ + åˆ·æ–°æŒ‰é’® */}
      <div className="toolbar">
        <span className="text-muted">{formatLastUpdated()}</span>
        <button onClick={() => refetch()} disabled={isFetching}>
          {isFetching ? "åˆ·æ–°ä¸­..." : "ğŸ”„ åˆ·æ–°"}
        </button>
      </div>
      
      {/* è¿‡æ»¤å™¨ */}
      <select value={status} onChange={(e) => setStatus(e.target.value)}>
        <option value="published">å·²å‘å¸ƒ</option>
        <option value="draft">è‰ç¨¿</option>
        <option value="archived">å·²å½’æ¡£</option>
      </select>
      
      {/* æ•°æ®å±•ç¤º */}
      <div className="post-grid">
        {posts.map(post => <PostCard key={post.id} post={post} />)}
      </div>
      
      {/* ç©ºçŠ¶æ€ */}
      {posts.length === 0 && (
        <EmptyState message="æš‚æ— æ•°æ®" />
      )}
    </div>
  );
};
```

### è¯¦æƒ…é¡µä½¿ç”¨æ¨¡å¼

```typescript
// src/app/pages/PostDetailPage.tsx

import { useParams, useNavigate } from "react-router-dom";
import { usePost, useDeletePost } from "@/shared/lib/queries";

export const PostDetailPage: React.FC = () => {
  const { postId } = useParams<{ postId: string }>();
  const navigate = useNavigate();
  
  const { data: post, isLoading } = usePost(postId);
  const deletePost = useDeletePost();

  const handleDelete = async () => {
    if (!postId || !confirm("ç¡®å®šåˆ é™¤ï¼Ÿ")) return;
    
    try {
      await deletePost.mutateAsync(postId);
      navigate("/posts");  // åˆ é™¤æˆåŠŸåè¿”å›åˆ—è¡¨
    } catch (error) {
      console.error("åˆ é™¤å¤±è´¥:", error);
    }
  };

  if (isLoading) return <LoadingSpinner />;
  if (!post) return <NotFound />;

  return (
    <article>
      <h1>{post.title}</h1>
      <p>{post.content}</p>
      <button onClick={handleDelete} disabled={deletePost.isPending}>
        {deletePost.isPending ? "åˆ é™¤ä¸­..." : "åˆ é™¤"}
      </button>
    </article>
  );
};
```

---

## 9.8 ç¼“å­˜æ—¶é—´ç­–ç•¥æŒ‡å—

### æŒ‰ä¸šåŠ¡åœºæ™¯é€‰æ‹©ç­–ç•¥

| ä¸šåŠ¡åœºæ™¯ | staleTime | gcTime | è¯´æ˜ |
|---------|-----------|--------|------|
| **ç³»ç»Ÿé…ç½®** | 30 åˆ†é’Ÿ | 2 å°æ—¶ | å‡ ä¹ä¸å˜ï¼Œå¯é•¿æ—¶é—´ç¼“å­˜ |
| **ç”¨æˆ·ä¿¡æ¯** | 10 åˆ†é’Ÿ | 1 å°æ—¶ | ä½é¢‘å˜åŒ– |
| **å†…å®¹åˆ—è¡¨** | 5 åˆ†é’Ÿ | 30 åˆ†é’Ÿ | ä¸­é¢‘å˜åŒ–ï¼Œç”¨æˆ·æœŸæœ›çœ‹åˆ°è¾ƒæ–°å†…å®¹ |
| **è®¢å•/ä»»åŠ¡çŠ¶æ€** | 1 åˆ†é’Ÿ | 10 åˆ†é’Ÿ | é«˜é¢‘å˜åŒ–ï¼Œéœ€è¦åŠæ—¶æ›´æ–° |
| **å®æ—¶æ•°æ®** | 10 ç§’ | 1 åˆ†é’Ÿ | å¦‚åœ¨çº¿çŠ¶æ€ã€å®æ—¶è®¡æ•° |
| **æœç´¢ç»“æœ** | 0 | 5 åˆ†é’Ÿ | æ¯æ¬¡æœç´¢éƒ½åº”è¯¥è·å–æœ€æ–°ç»“æœ |

### æ—¶é—´é…ç½®å†³ç­–æ ‘

```
æ•°æ®å¤šä¹…å˜åŒ–ä¸€æ¬¡ï¼Ÿ
    â”‚
    â”œâ”€â”€ å‡ ä¹ä¸å˜ï¼ˆå¤©/å‘¨çº§åˆ«ï¼‰
    â”‚   â””â”€â”€ staleTime: 30+ åˆ†é’Ÿ
    â”‚
    â”œâ”€â”€ ä½é¢‘ï¼ˆå°æ—¶çº§åˆ«ï¼‰
    â”‚   â””â”€â”€ staleTime: 10-30 åˆ†é’Ÿ
    â”‚
    â”œâ”€â”€ ä¸­é¢‘ï¼ˆåˆ†é’Ÿçº§åˆ«ï¼‰
    â”‚   â””â”€â”€ staleTime: 3-5 åˆ†é’Ÿ
    â”‚
    â”œâ”€â”€ é«˜é¢‘ï¼ˆç§’çº§åˆ«ï¼‰
    â”‚   â””â”€â”€ staleTime: 30 ç§’ - 1 åˆ†é’Ÿ
    â”‚
    â””â”€â”€ å®æ—¶
        â””â”€â”€ staleTime: 0 æˆ–ä½¿ç”¨ WebSocket
```

### é…ç½®åŸåˆ™

1. **`gcTime` â‰¥ `staleTime Ã— 3`**ï¼šç¡®ä¿è¿‡æœŸæ•°æ®æœ‰è¶³å¤Ÿæ—¶é—´ç”¨äºåå°åˆ·æ–°
2. **ç”¨æˆ·æ„ŸçŸ¥ä¼˜å…ˆ**ï¼šç”¨æˆ·èƒ½æ„ŸçŸ¥å˜åŒ–çš„æ•°æ®è¦çŸ­ä¸€äº›
3. **æˆæœ¬è€ƒè™‘**ï¼šæ•°æ®é‡å¤§ã€æŸ¥è¯¢æ…¢çš„æ¥å£ï¼Œ`staleTime` é€‚å½“å»¶é•¿
4. **é…åˆ Realtime**ï¼šå¦‚æœæœ‰ Realtime è®¢é˜…ï¼Œ`staleTime` å¯ä»¥è®¾é•¿ä¸€äº›

---

## 9.9 è°ƒè¯•ä¸é—®é¢˜æ’æŸ¥

### å¼€å¯ DevTools

åœ¨å¼€å‘ç¯å¢ƒï¼ŒæŒ‰ `Ctrl+Shift+D` åˆ‡æ¢ React Query DevToolsï¼š

```typescript
// QueryProvider.tsx
{import.meta.env.DEV && showDevtools && (
  <ReactQueryDevtools initialIsOpen={false} position="bottom" />
)}
```

### å¸¸è§é—®é¢˜

**Q1: æ•°æ®ä¸æ›´æ–°ï¼Ÿ**

æ£€æŸ¥ï¼š
1. æ“ä½œåæ˜¯å¦è°ƒç”¨äº† `invalidateQueries`
2. `queryKey` æ˜¯å¦ä¸€è‡´
3. æ§åˆ¶å°æ˜¯å¦æœ‰ `[Cache] ç¼“å­˜åˆ·æ–°å®Œæˆ` æ—¥å¿—

**Q2: é¡µé¢åˆ·æ–°åç¼“å­˜ä¸¢å¤±ï¼Ÿ**

æ£€æŸ¥ï¼š
1. localStorage ä¸­æ˜¯å¦æœ‰ `app_query_cache`
2. ç¼“å­˜ç‰ˆæœ¬å·æ˜¯å¦åŒ¹é…
3. ç¼“å­˜æ˜¯å¦è¶…è¿‡ 24 å°æ—¶

**Q3: é¦–æ¬¡åŠ è½½ä»ç„¶æ…¢ï¼Ÿ**

è¿™æ˜¯æ­£å¸¸çš„ï¼Œç¼“å­˜åªèƒ½åŠ é€Ÿ**åç»­è®¿é—®**ã€‚é¦–æ¬¡è®¿é—®éœ€è¦ä»æœåŠ¡å™¨è·å–ã€‚

å¯é€šè¿‡ä»¥ä¸‹æ–¹å¼ä¼˜åŒ–é¦–æ¬¡åŠ è½½ï¼š
1. ä½¿ç”¨ `prefetchQuery` é¢„åŠ è½½
2. åœ¨åº”ç”¨å¯åŠ¨æ—¶ç«‹å³è§¦å‘æ ¸å¿ƒæ•°æ®åŠ è½½

---

---

## 9.10 å®Œæ•´æ£€æŸ¥æ¸…å•

### åŸºç¡€é…ç½®

- [ ] å®‰è£… `@tanstack/react-query` å’Œ `@tanstack/react-query-devtools`
- [ ] åˆ›å»º `queryClient.ts`ï¼šé…ç½®ç¼“å­˜ç­–ç•¥ã€é‡è¯•é€»è¾‘ã€queryKeys å·¥å‚
- [ ] åˆ›å»º `queries.ts`ï¼šå°è£…æ‰€æœ‰ useQuery / useMutation hooks
- [ ] åˆ›å»º `QueryProvider.tsx`ï¼šåŒ…è£¹åº”ç”¨ï¼Œæä¾› Context
- [ ] åœ¨åº”ç”¨å…¥å£ `main.tsx` ä¸­ä½¿ç”¨ `QueryProvider`

### ç¼“å­˜ç­–ç•¥é…ç½®

- [ ] æŒ‰ä¸šåŠ¡é¢†åŸŸå®šä¹‰ `CACHE_TIMES` å¸¸é‡
- [ ] ä½¿ç”¨ `queryKeys` å·¥å‚å‡½æ•°ï¼Œé¿å…ç¡¬ç¼–ç å­—ç¬¦ä¸²
- [ ] é«˜é¢‘å˜åŒ–æ•°æ®é…ç½®çŸ­ `staleTime`ï¼ˆ1-3 åˆ†é’Ÿï¼‰
- [ ] é™æ€æ•°æ®é…ç½®é•¿ `staleTime`ï¼ˆ30+ åˆ†é’Ÿï¼‰
- [ ] ç¡®ä¿ `gcTime >= staleTime`

### æ•°æ®åŒæ­¥æœºåˆ¶

- [ ] æ‰€æœ‰ Mutation çš„ `onSuccess` ä¸­è°ƒç”¨ `invalidateQueries`
- [ ] é React ä»£ç ä¸­ä½¿ç”¨ `invalidateAllData` è§¦å‘åˆ·æ–°
- [ ] å®šä¹‰æ¸…æ™°çš„ç¼“å­˜å¤±æ•ˆç­–ç•¥ï¼ˆå“ªäº›æ“ä½œå½±å“å“ªäº›ç¼“å­˜ï¼‰

### Realtime è®¢é˜…ï¼ˆå¯é€‰ï¼‰

- [ ] åˆ›å»º `realtimeSubscription.ts`
- [ ] å®šä¹‰è¡¨å â†’ ç¼“å­˜ç±»å‹çš„æ˜ å°„å…³ç³»
- [ ] å®ç°é˜²æŠ–é€»è¾‘ï¼ˆæ¨è 500ms - 1000msï¼‰
- [ ] åœ¨ `QueryProvider` çš„ `DataManager` ä¸­å¯ç”¨
- [ ] å¤„ç†è®¢é˜…é”™è¯¯å’Œé‡è¿é€»è¾‘

### æŒä¹…åŒ–å­˜å‚¨ï¼ˆå¯é€‰ï¼‰

- [ ] å®ç° `persistQueryCache` ä¿å­˜åˆ° localStorage
- [ ] å®ç° `hydrateQueryCache` ä» localStorage æ¢å¤
- [ ] æ·»åŠ ç‰ˆæœ¬å·ï¼Œæ”¯æŒæœªæ¥å‡çº§
- [ ] æ·»åŠ è¿‡æœŸæ£€æŸ¥ï¼ˆæ¨è 24 å°æ—¶ï¼‰
- [ ] å¤„ç† `beforeunload` å’Œ `visibilitychange` äº‹ä»¶

### UI é›†æˆ

- [ ] æ˜¾ç¤ºåŠ è½½çŠ¶æ€ï¼ˆ`isLoading`ï¼‰
- [ ] æ˜¾ç¤ºåå°åˆ·æ–°çŠ¶æ€ï¼ˆ`isFetching`ï¼‰
- [ ] æ˜¾ç¤ºæœ€åæ›´æ–°æ—¶é—´ï¼ˆ`dataUpdatedAt`ï¼‰
- [ ] æä¾›æ‰‹åŠ¨åˆ·æ–°æŒ‰é’®ï¼ˆ`refetch`ï¼‰
- [ ] å¤„ç†é”™è¯¯çŠ¶æ€ï¼ˆ`isError` / `error`ï¼‰
- [ ] ç©ºçŠ¶æ€å¤„ç†

---

## 9.11 æœ€ä½³å®è·µæ€»ç»“

### æ¶æ„åŸåˆ™

1. **å•ä¸€æ•°æ®æº**ï¼šæ‰€æœ‰è¿œç¨‹æ•°æ®é€šè¿‡ TanStack Query è·å–ï¼Œé¿å…ç›´æ¥è°ƒç”¨ API

2. **ç»Ÿä¸€ queryKeys**ï¼šä½¿ç”¨å·¥å‚å‡½æ•°ï¼Œç¡®ä¿ç±»å‹å®‰å…¨å’Œä¸€è‡´æ€§

3. **åˆ†å±‚ç¼“å­˜ç­–ç•¥**ï¼šæŒ‰ä¸šåŠ¡é¢†åŸŸé…ç½®ä¸åŒçš„ç¼“å­˜æ—¶é—´

### æ•°æ®åŒæ­¥åŸåˆ™

4. **å†™æ“ä½œåå¿…åˆ·æ–°**ï¼šä»»ä½•ä¿®æ”¹æ•°æ®çš„æ“ä½œï¼Œéƒ½è¦ä½¿ç›¸å…³ç¼“å­˜å¤±æ•ˆ

5. **ä¼˜å…ˆ Realtime**ï¼šå¦‚æœæ•°æ®åº“æ”¯æŒï¼Œä½¿ç”¨ Realtime è®¢é˜…å®ç°è‡ªåŠ¨åŒæ­¥

6. **é˜²æŠ–æ‰¹é‡å˜åŒ–**ï¼šæ‰¹é‡æ“ä½œæ—¶ä½¿ç”¨é˜²æŠ–ï¼Œé¿å…é¢‘ç¹åˆ·æ–°

### ç”¨æˆ·ä½“éªŒåŸåˆ™

7. **ç»™ç”¨æˆ·æ§åˆ¶æƒ**ï¼šæä¾›æ‰‹åŠ¨åˆ·æ–°æŒ‰é’®å’Œæœ€åæ›´æ–°æ—¶é—´

8. **ä¼˜é›…é™çº§**ï¼šç¼“å­˜å¤±è´¥æ—¶é™é»˜å¤„ç†ï¼Œä¸å½±å“æ ¸å¿ƒåŠŸèƒ½

9. **é¦–å±é¢„åŠ è½½**ï¼šåº”ç”¨å¯åŠ¨æ—¶é¢„åŠ è½½æ ¸å¿ƒæ•°æ®

### å¼€å‘åŸåˆ™

10. **ä½¿ç”¨ DevTools**ï¼šå¼€å‘æ—¶åˆ©ç”¨ React Query DevTools è°ƒè¯•

11. **ç‰ˆæœ¬ç®¡ç†**ï¼šæŒä¹…åŒ–ç¼“å­˜å¸¦ç‰ˆæœ¬å·ï¼Œä¾¿äºå‡çº§

12. **è¡¨æ˜ å°„æ–‡æ¡£åŒ–**ï¼šRealtime è®¢é˜…çš„è¡¨â†’ç¼“å­˜æ˜ å°„å…³ç³»è¦æ¸…æ™°æ–‡æ¡£åŒ–

---

## 9.12 å¸¸è§åæ¨¡å¼

### âŒ åæ¨¡å¼ 1ï¼šç¡¬ç¼–ç  queryKey

```typescript
// âŒ ä¸æ¨è
useQuery({ queryKey: ["posts", "list", { status: "published" }] });

// âœ… æ¨è
useQuery({ queryKey: queryKeys.posts.list({ status: "published" }) });
```

### âŒ åæ¨¡å¼ 2ï¼šå¿˜è®°åœ¨ Mutation ååˆ·æ–°ç¼“å­˜

```typescript
// âŒ ä¸æ¨èï¼šåˆ é™¤åä¸åˆ·æ–°ç¼“å­˜
useMutation({
  mutationFn: deletePost,
  // æ²¡æœ‰ onSuccessï¼
});

// âœ… æ¨è
useMutation({
  mutationFn: deletePost,
  onSuccess: () => {
    queryClient.invalidateQueries({ queryKey: queryKeys.posts.all });
  },
});
```

### âŒ åæ¨¡å¼ 3ï¼šåœ¨ç»„ä»¶å†…åˆ›å»º QueryClient

```typescript
// âŒ ä¸æ¨èï¼šæ¯æ¬¡æ¸²æŸ“éƒ½åˆ›å»ºæ–°å®ä¾‹
function App() {
  const queryClient = new QueryClient(); // é”™è¯¯ï¼
  return <QueryClientProvider client={queryClient}>...</QueryClientProvider>;
}

// âœ… æ¨èï¼šæ¨¡å—çº§åˆ«å•ä¾‹
const queryClient = createQueryClient();
function App() {
  return <QueryClientProvider client={queryClient}>...</QueryClientProvider>;
}
```

### âŒ åæ¨¡å¼ 4ï¼šä¿®æ”¹ queryKeys ä½†ä¸æ›´æ–°ç‰ˆæœ¬å·

```typescript
// âŒ å±é™©ï¼šä¿®æ”¹äº† queryKey ç»“æ„ä½†æ²¡æœ‰æ›´æ–°ç‰ˆæœ¬
queryKeys.posts.list = (filters?: { 
  withImages?: boolean; 
  search?: string;
  withFirstImage?: boolean;  // æ–°å¢å‚æ•°
}) => [...queryKeys.posts.all, "list", filters];

// CACHE_SCHEMA_VERSION ä»ç„¶æ˜¯æ—§ç‰ˆæœ¬ï¼
// ç»“æœï¼šç”¨æˆ·çš„ localStorage ä¸­ç¼“å­˜çš„æ—§æ•°æ®æ— æ³•æ­£ç¡®åŒ¹é…æ–°çš„ queryKey

// âœ… æ¨èï¼šåŒæ—¶æ›´æ–°ç‰ˆæœ¬å·
export const CACHE_SCHEMA_VERSION = 2; // ä» 1 æ›´æ–°åˆ° 2
```

**åæœ**ï¼šç”¨æˆ·æµè§ˆå™¨ä¸­çš„æ—§ç¼“å­˜æ•°æ®ä½¿ç”¨äº†æ—§çš„ queryKey ç»“æ„ï¼Œå¯¼è‡´æ•°æ®åŠ è½½å¤±è´¥æˆ–æ˜¾ç¤ºç©ºç™½ã€‚

### âŒ åæ¨¡å¼ 5ï¼šstaleTime è®¾ä¸º Infinity

```typescript
// âŒ ä¸æ¨èï¼šæ•°æ®æ°¸ä¸è¿‡æœŸ
useQuery({
  queryKey: ["users"],
  staleTime: Infinity, // å±é™©ï¼æ•°æ®æ°¸è¿œä¸ä¼šè‡ªåŠ¨åˆ·æ–°
});

// âœ… æ¨èï¼šå³ä½¿å¾ˆå°‘å˜åŒ–ä¹Ÿè®¾ç½®ä¸€ä¸ªåˆç†çš„ä¸Šé™
useQuery({
  queryKey: ["users"],
  staleTime: 30 * 60 * 1000, // 30 åˆ†é’Ÿ
});
```

### âŒ åæ¨¡å¼ 5ï¼šåœ¨ queryFn ä¸­ä¿®æ”¹æ•°æ®

```typescript
// âŒ ä¸æ¨èï¼šæŸ¥è¯¢å‡½æ•°æœ‰å‰¯ä½œç”¨
queryFn: async () => {
  const data = await fetchPosts();
  await logUserActivity(); // å‰¯ä½œç”¨ï¼
  return data;
};

// âœ… æ¨èï¼šæŸ¥è¯¢å‡½æ•°ä¿æŒçº¯å‡€
queryFn: async () => {
  return await fetchPosts();
};
```

---

# å‰ç«¯ä¸ Supabase Edge Function å¼‚æ­¥åè°ƒè§„èŒƒ

æœ¬è§„èŒƒå®šä¹‰äº†å‰ç«¯åº”ç”¨ä¸ Supabase Edge Function ä¹‹é—´å¤„ç†é•¿æ—¶é—´è¿è¡Œä»»åŠ¡çš„æ ‡å‡†æ¨¡å¼ï¼Œè§£å†³è¶…æ—¶ã€ç½‘ç»œä¸ç¨³å®šã€é‡å¤å¤„ç†ç­‰é—®é¢˜ã€‚

## 10.1 æ ¸å¿ƒè®¾è®¡åŸåˆ™

### é—®é¢˜èƒŒæ™¯

Supabase Edge Function æœ‰æ‰§è¡Œæ—¶é—´é™åˆ¶ï¼š
- **å…è´¹è´¦æˆ·**ï¼šæœ€é•¿ 150 ç§’
- **Pro è´¦æˆ·**ï¼šæœ€é•¿ 150 ç§’ï¼ˆå¯é…ç½®ï¼‰

å½“ä»»åŠ¡å¯èƒ½è¶…è¿‡æ­¤é™åˆ¶æ—¶ï¼ˆå¦‚è°ƒç”¨å¤–éƒ¨ AI APIã€å¤„ç†å¤§æ–‡ä»¶ç­‰ï¼‰ï¼Œä¼ ç»Ÿçš„åŒæ­¥è¯·æ±‚-å“åº”æ¨¡å¼ä¼šå¤±è´¥ã€‚

### è§£å†³æ–¹æ¡ˆï¼šå¼‚æ­¥ä»»åŠ¡æ¨¡å¼

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                           å¼‚æ­¥ä»»åŠ¡å¤„ç†æ¶æ„                                    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                             â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚   â”‚  å‰ç«¯   â”‚â”€â”€â”€â”€â”€â”€â–¶â”‚  submit-task â”‚â”€â”€â”€â”€â”€â”€â–¶â”‚     Supabase Database       â”‚ â”‚
â”‚   â”‚         â”‚       â”‚              â”‚       â”‚   (async_tasks è¡¨)          â”‚ â”‚
â”‚   â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜       â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚        â”‚                   â”‚                           â–²                    â”‚
â”‚        â”‚            â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”                   â”‚                    â”‚
â”‚        â”‚            â”‚ process-task â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                    â”‚
â”‚        â”‚            â”‚  (åå°æ‰§è¡Œ)   â”‚    æ›´æ–°çŠ¶æ€/ç»“æœ    â”‚                    â”‚
â”‚        â”‚            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                   â”‚                    â”‚
â”‚        â”‚                                               â”‚                    â”‚
â”‚        â”‚  è½®è¯¢      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                   â”‚                    â”‚
â”‚        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚  check-task  â”‚â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                    â”‚
â”‚                     â”‚  (çŠ¶æ€æŸ¥è¯¢)   â”‚       è¯»å–çŠ¶æ€                          â”‚
â”‚                     â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜                                        â”‚
â”‚                            â”‚                                                â”‚
â”‚                     â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”                                        â”‚
â”‚                     â”‚retrigger-taskâ”‚  (è¶…æ—¶/å¤±è´¥æ—¶é‡è¯•)                       â”‚
â”‚                     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                        â”‚
â”‚                                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### æ ¸å¿ƒåŸåˆ™

1. **å³æ—¶å“åº”**ï¼šä»»åŠ¡æäº¤åç«‹å³è¿”å› taskIdï¼Œä¸é˜»å¡ç”¨æˆ·
2. **çŠ¶æ€æŒä¹…åŒ–**ï¼šæ‰€æœ‰ä»»åŠ¡çŠ¶æ€ä¿å­˜åœ¨æ•°æ®åº“ï¼Œä»»ä½•ç»„ä»¶éƒ½èƒ½æŸ¥è¯¢
3. **æ™ºèƒ½è½®è¯¢**ï¼šå‰ç«¯å®šæœŸæ£€æŸ¥ä»»åŠ¡çŠ¶æ€ï¼Œç›´åˆ°ä»»åŠ¡å®Œæˆæˆ–å¤±è´¥
4. **ä¹è§‚é”ä¿æŠ¤**ï¼šä½¿ç”¨ `trigger_id` é˜²æ­¢åˆ†å¸ƒå¼ç¯å¢ƒä¸­çš„é‡å¤å¤„ç†
5. **è‡ªåŠ¨æ¢å¤**ï¼šæ£€æµ‹åˆ°ä»»åŠ¡å¡ä½æ—¶è‡ªåŠ¨é‡è¯•ï¼Œæ— éœ€ç”¨æˆ·å¹²é¢„
6. **æ— é™è½®è¯¢**ï¼šè½®è¯¢æ—¶é—´ä¸è®¾é™ï¼Œä»¥ä»»åŠ¡å®Œæˆæˆ–è¶…å‡ºæœ€å¤§é‡è¯•æ¬¡æ•°ä¸ºç»ˆæ­¢æ¡ä»¶

---

## 10.2 é€‚ç”¨åœºæ™¯

### âœ… é€‚ç”¨

| åœºæ™¯ | è¯´æ˜ | å…¸å‹è€—æ—¶ |
|------|------|----------|
| AI API è°ƒç”¨ | OpenAIã€Claudeã€Dify ç­‰ | 10-120ç§’ |
| æ–‡ä»¶å¤„ç† | PDF è§£æã€å›¾ç‰‡åˆ†æã€è§†é¢‘è½¬ç  | 30-300ç§’ |
| æ‰¹é‡æ“ä½œ | æ‰¹é‡å‘é€é‚®ä»¶ã€æ‰¹é‡æ•°æ®å¯¼å…¥ | ä¸ç¡®å®š |
| å¤–éƒ¨ API èšåˆ | è°ƒç”¨å¤šä¸ªç¬¬ä¸‰æ–¹æœåŠ¡å¹¶èšåˆç»“æœ | ä¸ç¡®å®š |
| å¤æ‚è®¡ç®— | æ•°æ®åˆ†æã€æŠ¥è¡¨ç”Ÿæˆ | 30-180ç§’ |

### âŒ ä¸é€‚ç”¨

| åœºæ™¯ | è¯´æ˜ | æ¨èæ–¹æ¡ˆ |
|------|------|----------|
| ç®€å• CRUD | æ•°æ®åº“å¢åˆ æ”¹æŸ¥ | ç›´æ¥åŒæ­¥è°ƒç”¨ |
| å¿«é€Ÿå“åº” | < 5ç§’å®Œæˆçš„æ“ä½œ | ç›´æ¥åŒæ­¥è°ƒç”¨ |
| å®æ—¶äº¤äº’ | éœ€è¦å³æ—¶åé¦ˆçš„æ“ä½œ | WebSocket / Realtime |

---

## 10.3 æ•°æ®åº“è®¾è®¡

### ä»»åŠ¡è¡¨ç»“æ„

```sql
-- åˆ›å»ºå¼‚æ­¥ä»»åŠ¡è¡¨
CREATE TABLE async_tasks (
  -- ä¸»é”®
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  
  -- ä»»åŠ¡ç±»å‹ï¼ˆç”¨äºåŒºåˆ†ä¸åŒä¸šåŠ¡ï¼‰
  task_type TEXT NOT NULL,
  
  -- ä»»åŠ¡çŠ¶æ€ï¼špendingï¼ˆç­‰å¾…ï¼‰, processingï¼ˆå¤„ç†ä¸­ï¼‰, doneï¼ˆå®Œæˆï¼‰, failedï¼ˆå¤±è´¥ï¼‰
  status TEXT NOT NULL DEFAULT 'pending' CHECK (status IN ('pending', 'processing', 'done', 'failed')),
  
  -- ä¹è§‚é”IDï¼šæ¯æ¬¡è§¦å‘ç”Ÿæˆæ–°çš„ï¼Œç¡®ä¿åªæœ‰ä¸€ä¸ªå®ä¾‹å¤„ç†
  trigger_id UUID NOT NULL,
  
  -- ä»»åŠ¡è¾“å…¥å‚æ•°ï¼ˆJSONæ ¼å¼å­˜å‚¨ä»»æ„ç»“æ„ï¼‰
  input_data JSONB NOT NULL DEFAULT '{}',
  
  -- ä»»åŠ¡è¾“å‡ºç»“æœ
  result_data JSONB,
  
  -- é”™è¯¯ä¿¡æ¯
  error_message TEXT,
  
  -- é‡è¯•è®¡æ•°
  retry_count INTEGER DEFAULT 0,
  
  -- æ—¶é—´æˆ³
  created_at TIMESTAMPTZ DEFAULT NOW(),
  last_triggered_at TIMESTAMPTZ DEFAULT NOW(),
  started_at TIMESTAMPTZ,
  finished_at TIMESTAMPTZ,
  
  -- å…³è”å­—æ®µï¼ˆæ ¹æ®ä¸šåŠ¡éœ€è¦æ·»åŠ ï¼‰
  user_id UUID REFERENCES auth.users(id),
  material_id UUID,
  
  -- ç´¢å¼•ä¼˜åŒ–
  CONSTRAINT valid_status CHECK (status IN ('pending', 'processing', 'done', 'failed'))
);

-- åˆ›å»ºç´¢å¼•
CREATE INDEX idx_async_tasks_status ON async_tasks(status);
CREATE INDEX idx_async_tasks_user_id ON async_tasks(user_id);
CREATE INDEX idx_async_tasks_task_type ON async_tasks(task_type);
CREATE INDEX idx_async_tasks_trigger_id ON async_tasks(trigger_id);
CREATE INDEX idx_async_tasks_created_at ON async_tasks(created_at DESC);

-- å¤åˆç´¢å¼•ï¼šç”¨äºè½®è¯¢æŸ¥è¯¢
CREATE INDEX idx_async_tasks_status_created ON async_tasks(status, created_at DESC);
```

### å­—æ®µè¯´æ˜

| å­—æ®µ | ç±»å‹ | è¯´æ˜ |
|------|------|------|
| `id` | UUID | ä»»åŠ¡å”¯ä¸€æ ‡è¯†ï¼Œæäº¤åè¿”å›ç»™å‰ç«¯ç”¨äºè½®è¯¢ |
| `task_type` | TEXT | ä»»åŠ¡ç±»å‹ï¼Œå¦‚ 'analyze', 'enhance', 'export' |
| `status` | TEXT | çŠ¶æ€æœºï¼špending â†’ processing â†’ done/failed |
| `trigger_id` | UUID | **æ ¸å¿ƒå­—æ®µ**ï¼šä¹è§‚é”ï¼Œæ¯æ¬¡è§¦å‘ç”Ÿæˆæ–°å€¼ |
| `input_data` | JSONB | ä»»åŠ¡è¾“å…¥å‚æ•°ï¼Œçµæ´»å­˜å‚¨ä»»æ„ç»“æ„ |
| `result_data` | JSONB | ä»»åŠ¡ç»“æœï¼Œå®Œæˆåå†™å…¥ |
| `error_message` | TEXT | å¤±è´¥æ—¶çš„é”™è¯¯ä¿¡æ¯ |
| `retry_count` | INTEGER | å·²é‡è¯•æ¬¡æ•°ï¼Œè¾¾åˆ°ä¸Šé™åæ ‡è®°å¤±è´¥ |
| `created_at` | TIMESTAMPTZ | ä»»åŠ¡åˆ›å»ºæ—¶é—´ |
| `last_triggered_at` | TIMESTAMPTZ | æœ€åä¸€æ¬¡è§¦å‘æ—¶é—´ï¼Œç”¨äºæ£€æµ‹å¡ä½ |
| `started_at` | TIMESTAMPTZ | å¼€å§‹å¤„ç†æ—¶é—´ |
| `finished_at` | TIMESTAMPTZ | å®Œæˆæ—¶é—´ï¼ˆæˆåŠŸæˆ–å¤±è´¥ï¼‰ |

### çŠ¶æ€æœºè®¾è®¡

```
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚                                         â”‚
                    â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”                           â”‚
                    â”‚   â”‚ pending â”‚â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
                    â”‚   â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜                       â”‚   â”‚
                    â”‚        â”‚                            â”‚   â”‚
                    â”‚        â”‚ process-task å¼€å§‹å¤„ç†       â”‚   â”‚
                    â”‚        â–¼                            â”‚   â”‚
                    â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                    â”‚   â”‚
        æˆåŠŸ        â”‚   â”‚ processing â”‚                    â”‚   â”‚  é‡è¯•
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤   â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜                    â”‚   â”‚  (retrigger)
    â”‚               â”‚         â”‚                           â”‚   â”‚
    â–¼               â”‚         â”‚                           â”‚   â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”            â”‚         â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚ done â”‚            â”‚         â”‚  è¶…æ—¶/ä¸´æ—¶å¤±è´¥ï¼ˆæœªè¾¾é‡è¯•ä¸Šé™ï¼‰    â”‚
â””â”€â”€â”€â”€â”€â”€â”˜            â”‚         â”‚                               â”‚
                    â”‚         â”‚  å¤„ç†å¤±è´¥/é‡è¯•æ¬¡æ•°è¾¾ä¸Šé™          â”‚
                    â”‚         â–¼                               â”‚
                    â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”                            â”‚
                    â”‚   â”‚ failed â”‚                            â”‚
                    â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜                            â”‚
                    â”‚                                         â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 10.4 é…ç½®å¸¸é‡è§„èŒƒ

### é…ç½®è¡¨ï¼ˆæ ¸å¿ƒé…ç½®ï¼‰

```typescript
/**
 * å¼‚æ­¥ä»»åŠ¡é…ç½®å¸¸é‡
 * 
 * è®¾è®¡åŸåˆ™ï¼š
 * 1. è½®è¯¢æ—¶é—´ä¸è®¾é™ - ä»¥ä»»åŠ¡å®Œæˆæˆ–è¶…å‡ºæœ€å¤§é‡è¯•æ¬¡æ•°ä¸ºç»ˆæ­¢æ¡ä»¶
 * 2. æ‰€æœ‰è¶…æ—¶å€¼åŸºäº Supabase Edge Function çš„æ‰§è¡Œé™åˆ¶ï¼ˆPro: 150sï¼‰
 * 3. ç»™å¤–éƒ¨ API ç•™è¶³å¤Ÿçš„å¤„ç†æ—¶é—´ï¼ŒåŒæ—¶ç¡®ä¿èƒ½æ£€æµ‹åˆ°çœŸæ­£å¡ä½çš„ä»»åŠ¡
 */

// ==================== è½®è¯¢é…ç½® ====================

/** è½®è¯¢é—´éš”ï¼ˆæ¯«ç§’ï¼‰- æ¯éš”å¤šä¹…æ£€æŸ¥ä¸€æ¬¡ä»»åŠ¡çŠ¶æ€ */
export const POLL_INTERVAL = 3000; // 3ç§’

/** 
 * æœ€å¤§è½®è¯¢æ—¶é—´ - ä¸è®¾é™
 * è½®è¯¢å°†æŒç»­è¿›è¡Œï¼Œç›´åˆ°æ‰€æœ‰ä»»åŠ¡å®Œæˆæˆ–å¤±è´¥
 * è¿™é‡Œè®¾ä¸º Infinity è¡¨ç¤ºæ— é™åˆ¶
 */
export const MAX_POLL_TIME = Infinity;

// ==================== è¶…æ—¶æ£€æµ‹é…ç½® ====================

/**
 * Pending çŠ¶æ€è¶…æ—¶ï¼ˆæ¯«ç§’ï¼‰
 * 
 * å«ä¹‰ï¼šä»»åŠ¡æäº¤åå¤šä¹…è¿˜æ˜¯ pending çŠ¶æ€ï¼Œè®¤ä¸ºè§¦å‘å¤±è´¥
 * åœºæ™¯ï¼šsubmit-task æˆåŠŸåˆ›å»ºä»»åŠ¡ï¼Œä½† process-task è§¦å‘å¤±è´¥
 * å¤„ç†ï¼šå‰ç«¯æ£€æµ‹åˆ°åè°ƒç”¨ retrigger-task é‡æ–°è§¦å‘
 * 
 * è®¡ç®—ä¾æ®ï¼š
 * - submit-task æ‰§è¡Œæ—¶é—´ï¼š< 1ç§’
 * - process-task å¯åŠ¨æ—¶é—´ï¼š< 2ç§’
 * - ç½‘ç»œæ³¢åŠ¨ä½™é‡ï¼š10ç§’
 * - æ€»è®¡ï¼š~15ç§’ï¼Œè®¾ç½® 30ç§’ç•™æœ‰ä½™é‡
 */
export const PENDING_TIMEOUT = 30000; // 30ç§’

/**
 * Processing çŠ¶æ€è¶…æ—¶ï¼ˆæ¯«ç§’ï¼‰
 * 
 * å«ä¹‰ï¼šä»»åŠ¡å¼€å§‹å¤„ç†åå¤šä¹…è¿˜æœªå®Œæˆï¼Œè®¤ä¸ºå¤„ç†å¡ä½
 * åœºæ™¯ï¼šprocess-task å¼€å§‹æ‰§è¡Œä½†å› å¼‚å¸¸é€€å‡ºã€ç½‘ç»œä¸­æ–­ç­‰æœªå®Œæˆ
 * å¤„ç†ï¼šå‰ç«¯æ£€æµ‹åˆ°åè°ƒç”¨ retrigger-task é‡æ–°è§¦å‘
 * 
 * è®¡ç®—ä¾æ®ï¼š
 * - Supabase Edge Function æœ€é•¿æ‰§è¡Œæ—¶é—´ï¼š150ç§’ï¼ˆProï¼‰
 * - è®¾ç½®æ¯”æ‰§è¡Œé™åˆ¶ç•¥çŸ­ï¼Œåœ¨è¶…æ—¶å‰è§¦å‘é‡è¯•
 * - å¦‚æœå¤–éƒ¨ API é¢„æœŸ 120ç§’å†…å®Œæˆï¼Œè®¾ç½® 120ç§’
 */
export const PROCESSING_TIMEOUT = 120000; // 120ç§’ï¼ˆ2åˆ†é’Ÿï¼‰

// ==================== é‡è¯•é…ç½® ====================

/**
 * æœ€å¤§é‡è¯•æ¬¡æ•°
 * 
 * å«ä¹‰ï¼šå•ä¸ªä»»åŠ¡æœ€å¤šé‡è¯•å¤šå°‘æ¬¡
 * è¶…è¿‡æ­¤æ¬¡æ•°åï¼Œä»»åŠ¡å°†è¢«æ ‡è®°ä¸º failed
 * 
 * è®¡ç®—ä¾æ®ï¼š
 * - ä¸´æ—¶ç½‘ç»œé—®é¢˜ï¼š1-2æ¬¡é‡è¯•å¯æ¢å¤
 * - API é™æµ/ç¹å¿™ï¼š2-3æ¬¡é‡è¯•å¯æ¢å¤
 * - çœŸæ­£çš„é”™è¯¯ï¼šä¸åº”æ— é™é‡è¯•
 * - æ€»é‡è¯•æ—¶é—´ï¼š5æ¬¡ Ã— 2åˆ†é’Ÿ = æœ€é•¿10åˆ†é’Ÿ
 */
export const MAX_RETRY_COUNT = 5;

// ==================== æ‰¹å¤„ç†é…ç½® ====================

/**
 * å¹¶å‘ä»»åŠ¡æ•°é‡
 * 
 * å«ä¹‰ï¼šåŒæ—¶æäº¤/å¤„ç†å¤šå°‘ä¸ªä»»åŠ¡
 * åœºæ™¯ï¼šæ‰¹é‡å¤„ç†å¤šä¸ªæ–‡ä»¶æ—¶ï¼Œæ§åˆ¶å¹¶å‘é˜²æ­¢è¿‡è½½
 */
export const CONCURRENCY_LIMIT = 5;

/**
 * æ‰¹æ¬¡é—´å»¶è¿Ÿï¼ˆæ¯«ç§’ï¼‰
 * 
 * å«ä¹‰ï¼šå¤„ç†å®Œä¸€æ‰¹åï¼Œç­‰å¾…å¤šä¹…å†å¤„ç†ä¸‹ä¸€æ‰¹
 * ç›®çš„ï¼šé˜²æ­¢ç¬é—´å‹åŠ›è¿‡å¤§ï¼Œç»™ç³»ç»Ÿå–˜æ¯æ—¶é—´
 */
export const BATCH_DELAY = 10000; // 10ç§’

// ==================== Edge Function å†…éƒ¨é…ç½® ====================

/**
 * å¤–éƒ¨ API è¶…æ—¶ï¼ˆæ¯«ç§’ï¼‰- ç”¨äº Edge Function å†…éƒ¨
 * 
 * å«ä¹‰ï¼šè°ƒç”¨å¤–éƒ¨ APIï¼ˆå¦‚ Difyã€OpenAIï¼‰çš„å•æ¬¡è¶…æ—¶æ—¶é—´
 * å¿…é¡»å°äº Edge Function çš„æ‰§è¡Œé™åˆ¶
 */
export const EXTERNAL_API_TIMEOUT = 120000; // 120ç§’

/**
 * Edge Function å†…éƒ¨é‡è¯•æ¬¡æ•°
 * 
 * å«ä¹‰ï¼šåœ¨å•æ¬¡ Edge Function æ‰§è¡Œä¸­ï¼Œè°ƒç”¨å¤–éƒ¨ API å¤±è´¥æ—¶çš„é‡è¯•æ¬¡æ•°
 * æ³¨æ„ï¼šè¿™ä¸å‰ç«¯çš„ MAX_RETRY_COUNT æ˜¯ä¸åŒå±‚çº§çš„é‡è¯•
 */
export const INTERNAL_RETRY_COUNT = 3;

/**
 * é‡è¯•åŸºç¡€å»¶è¿Ÿï¼ˆæ¯«ç§’ï¼‰- æŒ‡æ•°é€€é¿çš„åŸºç¡€å€¼
 */
export const RETRY_BASE_DELAY = 1000; // 1ç§’

/**
 * é‡è¯•æœ€å¤§å»¶è¿Ÿï¼ˆæ¯«ç§’ï¼‰- æŒ‡æ•°é€€é¿çš„ä¸Šé™
 */
export const RETRY_MAX_DELAY = 30000; // 30ç§’

/**
 * é€€é¿ä¹˜æ•°
 */
export const RETRY_BACKOFF_MULTIPLIER = 2;
```

### é…ç½®å…³ç³»å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                              æ—¶é—´çº¿ç¤ºæ„                                       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                             â”‚
â”‚  ä»»åŠ¡æäº¤                                                                    â”‚
â”‚     â”‚                                                                       â”‚
â”‚     â–¼                                                                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚                        PENDING é˜¶æ®µ                                   â”‚   â”‚
â”‚  â”‚  0s â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ 15s â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ 30s (PENDING_TIMEOUT)         â”‚   â”‚
â”‚  â”‚  â”‚                                      â”‚                            â”‚   â”‚
â”‚  â”‚  â”‚  æ­£å¸¸ï¼šprocess-task åº”åœ¨æ­¤æœŸé—´å¯åŠ¨     â”‚  è¶…æ—¶ï¼šè§¦å‘ retrigger      â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                             â”‚
â”‚  çŠ¶æ€å˜ä¸º processing                                                         â”‚
â”‚     â”‚                                                                       â”‚
â”‚     â–¼                                                                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚                      PROCESSING é˜¶æ®µ                                  â”‚   â”‚
â”‚  â”‚  0s â”€â”€â”€â”€â”€â”€â”€â”€ 60s â”€â”€â”€â”€â”€â”€â”€â”€ 120s (PROCESSING_TIMEOUT) â”€â”€â”€ 150s (é™åˆ¶)  â”‚   â”‚
â”‚  â”‚  â”‚                          â”‚                              â”‚         â”‚   â”‚
â”‚  â”‚  â”‚  å¤–éƒ¨ API å¤„ç†ä¸­           â”‚  è¶…æ—¶ï¼šè§¦å‘ retrigger         â”‚ EFè¶…æ—¶   â”‚   â”‚
â”‚  â”‚  â”‚                          â”‚  (åœ¨ EF è¶…æ—¶å‰é‡è¯•)           â”‚         â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                             â”‚
â”‚  è½®è¯¢æŒç»­è¿›è¡Œï¼Œç›´åˆ°ï¼š                                                         â”‚
â”‚  - æ‰€æœ‰ä»»åŠ¡çŠ¶æ€å˜ä¸º done æˆ– failed                                            â”‚
â”‚  - æˆ–è€…æ‰€æœ‰å¤±è´¥ä»»åŠ¡çš„ retry_count >= MAX_RETRY_COUNT                          â”‚
â”‚                                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 10.5 Edge Function å®ç°è§„èŒƒ

### 10.5.1 submit-taskï¼ˆä»»åŠ¡æäº¤ï¼‰

**èŒè´£**ï¼šæ¥æ”¶ä»»åŠ¡è¯·æ±‚ï¼Œåˆ›å»ºæ•°æ®åº“è®°å½•ï¼Œå¼‚æ­¥è§¦å‘å¤„ç†

```typescript
// supabase/functions/submit-task/index.ts

import { createClient } from "https://esm.sh/@supabase/supabase-js@2";

// ç”Ÿæˆ UUID
function generateUUID(): string {
  return crypto.randomUUID();
}

// CORS å“åº”å¤´
const corsHeaders = {
  "Access-Control-Allow-Origin": "*",
  "Access-Control-Allow-Headers": "authorization, x-client-info, apikey, content-type",
  "Access-Control-Allow-Methods": "POST, OPTIONS",
};

Deno.serve(async (req) => {
  // å¤„ç† CORS é¢„æ£€è¯·æ±‚
  if (req.method === "OPTIONS") {
    return new Response(null, { headers: corsHeaders });
  }

  try {
    // 1. åˆå§‹åŒ– Supabase å®¢æˆ·ç«¯
    const supabaseUrl = Deno.env.get("SUPABASE_URL")!;
    const supabaseKey = Deno.env.get("SUPABASE_SERVICE_ROLE_KEY")!;
    const supabase = createClient(supabaseUrl, supabaseKey);

    // 2. è§£æè¯·æ±‚å‚æ•°
    const body = await req.json();
    const { 
      taskType,      // ä»»åŠ¡ç±»å‹
      inputData,     // ä»»åŠ¡è¾“å…¥å‚æ•°
      userId,        // å¯é€‰ï¼šç”¨æˆ·ID
      materialId,    // å¯é€‰ï¼šå…³è”èµ„æºID
    } = body;

    // 3. å‚æ•°éªŒè¯
    if (!taskType) {
      return new Response(
        JSON.stringify({ error: "taskType is required" }),
        { status: 400, headers: { ...corsHeaders, "Content-Type": "application/json" } }
      );
    }

    // 4. ç”Ÿæˆä¹è§‚é” ID
    const triggerId = generateUUID();

    // 5. åˆ›å»ºä»»åŠ¡è®°å½•
    const { data: task, error: insertError } = await supabase
      .from("async_tasks")
      .insert({
        task_type: taskType,
        status: "pending",
        trigger_id: triggerId,
        input_data: inputData || {},
        user_id: userId,
        material_id: materialId,
        retry_count: 0,
        created_at: new Date().toISOString(),
        last_triggered_at: new Date().toISOString(),
      })
      .select("id, trigger_id, status")
      .single();

    if (insertError) {
      console.error("[submit-task] Insert error:", insertError);
      return new Response(
        JSON.stringify({ error: "Failed to create task", details: insertError.message }),
        { status: 500, headers: { ...corsHeaders, "Content-Type": "application/json" } }
      );
    }

    console.log(`[submit-task] Task created: ${task.id}, triggerId: ${triggerId}`);

    // 6. å¼‚æ­¥è§¦å‘ process-taskï¼ˆä¸é˜»å¡å“åº”ï¼‰
    const processTaskUrl = `${supabaseUrl}/functions/v1/process-task`;
    
    // ä½¿ç”¨ EdgeRuntime.waitUntil åœ¨åå°è§¦å‘ï¼Œä¸é˜»å¡å“åº”
    // @ts-ignore - EdgeRuntime æ˜¯ Supabase Edge Function ç‰¹æœ‰çš„å…¨å±€å¯¹è±¡
    EdgeRuntime.waitUntil(
      fetch(processTaskUrl, {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "Authorization": `Bearer ${supabaseKey}`,
        },
        body: JSON.stringify({
          taskId: task.id,
          triggerId: triggerId,
        }),
      }).catch((error) => {
        // è§¦å‘å¤±è´¥ä¸å½±å“ä»»åŠ¡åˆ›å»ºï¼Œå‰ç«¯ä¼šé€šè¿‡è½®è¯¢æ£€æµ‹åˆ° pending è¶…æ—¶å¹¶é‡è¯•
        console.error(`[submit-task] Failed to trigger process-task:`, error);
      })
    );

    // 7. ç«‹å³è¿”å›ä»»åŠ¡ä¿¡æ¯
    return new Response(
      JSON.stringify({
        success: true,
        taskId: task.id,
        triggerId: triggerId,
        status: "pending",
      }),
      { status: 200, headers: { ...corsHeaders, "Content-Type": "application/json" } }
    );

  } catch (error) {
    console.error("[submit-task] Unexpected error:", error);
    return new Response(
      JSON.stringify({ error: "Internal server error", details: error.message }),
      { status: 500, headers: { ...corsHeaders, "Content-Type": "application/json" } }
    );
  }
});
```

**å…³é”®ç‚¹**ï¼š
1. ä½¿ç”¨ `EdgeRuntime.waitUntil()` å¼‚æ­¥è§¦å‘ `process-task`ï¼Œä¸é˜»å¡å“åº”
2. å³ä½¿è§¦å‘å¤±è´¥ä¹Ÿè¿”å›æˆåŠŸï¼Œå‰ç«¯ä¼šé€šè¿‡è½®è¯¢æ£€æµ‹åˆ° pending è¶…æ—¶
3. `trigger_id` åœ¨åˆ›å»ºæ—¶ç”Ÿæˆï¼Œä¼ é€’ç»™ `process-task`

---

### 10.5.2 process-taskï¼ˆä»»åŠ¡å¤„ç†ï¼‰

**èŒè´£**ï¼šæ‰§è¡Œå®é™…çš„é•¿æ—¶é—´è¿è¡Œä»»åŠ¡

```typescript
// supabase/functions/process-task/index.ts

import { createClient } from "https://esm.sh/@supabase/supabase-js@2";

// é…ç½®å¸¸é‡
const EXTERNAL_API_TIMEOUT = 120000; // 120ç§’
const MAX_INTERNAL_RETRIES = 3;
const RETRY_BASE_DELAY = 1000;
const RETRY_MAX_DELAY = 30000;
const RETRY_BACKOFF_MULTIPLIER = 2;

// CORS å“åº”å¤´
const corsHeaders = {
  "Access-Control-Allow-Origin": "*",
  "Access-Control-Allow-Headers": "authorization, x-client-info, apikey, content-type",
  "Access-Control-Allow-Methods": "POST, OPTIONS",
};

// å¸¦è¶…æ—¶çš„ fetch
async function fetchWithTimeout(
  url: string,
  options: RequestInit,
  timeout: number
): Promise<Response> {
  const controller = new AbortController();
  const timeoutId = setTimeout(() => controller.abort(), timeout);

  try {
    const response = await fetch(url, {
      ...options,
      signal: controller.signal,
    });
    return response;
  } finally {
    clearTimeout(timeoutId);
  }
}

// å¸¦é‡è¯•çš„æ‰§è¡Œå™¨
async function withRetry<T>(
  fn: () => Promise<T>,
  taskId: string,
  options: {
    maxRetries?: number;
    baseDelay?: number;
    maxDelay?: number;
    backoffMultiplier?: number;
  } = {}
): Promise<T> {
  const {
    maxRetries = MAX_INTERNAL_RETRIES,
    baseDelay = RETRY_BASE_DELAY,
    maxDelay = RETRY_MAX_DELAY,
    backoffMultiplier = RETRY_BACKOFF_MULTIPLIER,
  } = options;

  let lastError: Error | null = null;

  for (let attempt = 0; attempt <= maxRetries; attempt++) {
    try {
      return await fn();
    } catch (error) {
      lastError = error as Error;
      
      if (attempt === maxRetries) {
        console.error(`[process-task][${taskId}] All ${maxRetries + 1} attempts failed`);
        throw lastError;
      }

      // è®¡ç®—å»¶è¿Ÿï¼ˆæŒ‡æ•°é€€é¿ + æŠ–åŠ¨ï¼‰
      const exponentialDelay = baseDelay * Math.pow(backoffMultiplier, attempt);
      const jitter = Math.random() * 1000;
      const delay = Math.min(exponentialDelay + jitter, maxDelay);

      console.log(`[process-task][${taskId}] Attempt ${attempt + 1} failed, retrying in ${delay}ms...`);
      await new Promise((resolve) => setTimeout(resolve, delay));
    }
  }

  throw lastError;
}

// è°ƒç”¨å¤–éƒ¨ API çš„ç¤ºä¾‹å‡½æ•°ï¼ˆæ ¹æ®å®é™…ä¸šåŠ¡æ›¿æ¢ï¼‰
async function callExternalAPI(inputData: Record<string, any>): Promise<any> {
  const apiUrl = Deno.env.get("EXTERNAL_API_URL")!;
  const apiKey = Deno.env.get("EXTERNAL_API_KEY")!;

  const response = await fetchWithTimeout(
    apiUrl,
    {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        "Authorization": `Bearer ${apiKey}`,
      },
      body: JSON.stringify(inputData),
    },
    EXTERNAL_API_TIMEOUT
  );

  if (!response.ok) {
    const errorText = await response.text();
    throw new Error(`API error: ${response.status} - ${errorText}`);
  }

  return await response.json();
}

Deno.serve(async (req) => {
  // å¤„ç† CORS é¢„æ£€è¯·æ±‚
  if (req.method === "OPTIONS") {
    return new Response(null, { headers: corsHeaders });
  }

  // åˆå§‹åŒ– Supabase å®¢æˆ·ç«¯
  const supabaseUrl = Deno.env.get("SUPABASE_URL")!;
  const supabaseKey = Deno.env.get("SUPABASE_SERVICE_ROLE_KEY")!;
  const supabase = createClient(supabaseUrl, supabaseKey);

  try {
    // 1. è§£æè¯·æ±‚å‚æ•°
    const body = await req.json();
    const { taskId, triggerId } = body;

    if (!taskId || !triggerId) {
      return new Response(
        JSON.stringify({ error: "taskId and triggerId are required" }),
        { status: 400, headers: { ...corsHeaders, "Content-Type": "application/json" } }
      );
    }

    console.log(`[process-task] Processing task: ${taskId}, triggerId: ${triggerId}`);

    // 2. è·å–ä»»åŠ¡å¹¶éªŒè¯ä¹è§‚é”
    const { data: task, error: fetchError } = await supabase
      .from("async_tasks")
      .select("*")
      .eq("id", taskId)
      .single();

    if (fetchError || !task) {
      console.error(`[process-task] Task not found: ${taskId}`);
      return new Response(
        JSON.stringify({ error: "Task not found" }),
        { status: 404, headers: { ...corsHeaders, "Content-Type": "application/json" } }
      );
    }

    // 3. ä¹è§‚é”éªŒè¯ï¼šæ£€æŸ¥ trigger_id æ˜¯å¦åŒ¹é…
    if (task.trigger_id !== triggerId) {
      console.log(`[process-task] Trigger ID mismatch for task ${taskId}. Expected: ${task.trigger_id}, Got: ${triggerId}. Skipping.`);
      return new Response(
        JSON.stringify({ 
          success: false, 
          reason: "trigger_id_mismatch",
          message: "Another instance is handling this task" 
        }),
        { status: 200, headers: { ...corsHeaders, "Content-Type": "application/json" } }
      );
    }

    // 4. æ£€æŸ¥ä»»åŠ¡çŠ¶æ€ï¼šåªå¤„ç† pending çŠ¶æ€çš„ä»»åŠ¡
    if (task.status !== "pending") {
      console.log(`[process-task] Task ${taskId} is not pending (status: ${task.status}). Skipping.`);
      return new Response(
        JSON.stringify({ 
          success: false, 
          reason: "invalid_status",
          message: `Task is ${task.status}, not pending` 
        }),
        { status: 200, headers: { ...corsHeaders, "Content-Type": "application/json" } }
      );
    }

    // 5. ä½¿ç”¨ä¹è§‚é”æ›´æ–°çŠ¶æ€ä¸º processing
    const { data: updateResult, error: updateError } = await supabase
      .from("async_tasks")
      .update({
        status: "processing",
        started_at: new Date().toISOString(),
      })
      .eq("id", taskId)
      .eq("trigger_id", triggerId) // ä¹è§‚é”æ¡ä»¶
      .eq("status", "pending")     // çŠ¶æ€æ¡ä»¶
      .select("id")
      .single();

    if (updateError || !updateResult) {
      console.log(`[process-task] Failed to acquire lock for task ${taskId}. Another instance may have taken over.`);
      return new Response(
        JSON.stringify({ 
          success: false, 
          reason: "lock_failed",
          message: "Failed to acquire processing lock" 
        }),
        { status: 200, headers: { ...corsHeaders, "Content-Type": "application/json" } }
      );
    }

    console.log(`[process-task] Acquired lock for task ${taskId}, starting processing...`);

    // 6. æ‰§è¡Œå®é™…çš„ä»»åŠ¡å¤„ç†ï¼ˆå¸¦é‡è¯•ï¼‰
    try {
      const result = await withRetry(
        () => callExternalAPI(task.input_data),
        taskId
      );

      // 7. æˆåŠŸï¼šæ›´æ–°ä»»åŠ¡çŠ¶æ€ä¸º done
      const { error: successUpdateError } = await supabase
        .from("async_tasks")
        .update({
          status: "done",
          result_data: result,
          finished_at: new Date().toISOString(),
        })
        .eq("id", taskId);

      if (successUpdateError) {
        console.error(`[process-task] Failed to update success status for task ${taskId}:`, successUpdateError);
      } else {
        console.log(`[process-task] Task ${taskId} completed successfully`);
      }

      return new Response(
        JSON.stringify({ success: true, taskId }),
        { status: 200, headers: { ...corsHeaders, "Content-Type": "application/json" } }
      );

    } catch (processingError) {
      // 8. å¤„ç†å¤±è´¥ï¼šè®°å½•é”™è¯¯ä½† **ä¸ç«‹å³æ ‡è®°ä¸º failed**
      // è®©å‰ç«¯é€šè¿‡è½®è¯¢æ£€æµ‹ processing è¶…æ—¶ï¼Œç„¶åè°ƒç”¨ retrigger-task
      console.error(`[process-task] Task ${taskId} processing error:`, processingError);

      // è®°å½•é”™è¯¯ä¿¡æ¯ï¼Œä½†ä¿æŒ processing çŠ¶æ€
      // è¿™æ ·å‰ç«¯å¯ä»¥æ£€æµ‹åˆ° processing è¶…æ—¶å¹¶è§¦å‘é‡è¯•
      await supabase
        .from("async_tasks")
        .update({
          error_message: processingError.message || "Unknown processing error",
        })
        .eq("id", taskId);

      // è¿”å›æˆåŠŸï¼ˆEdge Function æ­£å¸¸æ‰§è¡Œå®Œæ¯•ï¼‰
      // ä»»åŠ¡çš„å¤±è´¥ç”±å‰ç«¯çš„é‡è¯•æœºåˆ¶å¤„ç†
      return new Response(
        JSON.stringify({ 
          success: false, 
          reason: "processing_error",
          error: processingError.message 
        }),
        { status: 200, headers: { ...corsHeaders, "Content-Type": "application/json" } }
      );
    }

  } catch (error) {
    console.error("[process-task] Unexpected error:", error);
    return new Response(
      JSON.stringify({ error: "Internal server error", details: error.message }),
      { status: 500, headers: { ...corsHeaders, "Content-Type": "application/json" } }
    );
  }
});
```

**å…³é”®ç‚¹**ï¼š
1. **ä¹è§‚é”éªŒè¯**ï¼šæ£€æŸ¥ `trigger_id` æ˜¯å¦åŒ¹é…ï¼Œé˜²æ­¢é‡å¤å¤„ç†
2. **çŠ¶æ€æ£€æŸ¥**ï¼šåªå¤„ç† `pending` çŠ¶æ€çš„ä»»åŠ¡
3. **å†…éƒ¨é‡è¯•**ï¼šä½¿ç”¨æŒ‡æ•°é€€é¿é‡è¯•å¤–éƒ¨ API è°ƒç”¨
4. **å¤±è´¥å¤„ç†**ï¼šä¸ç«‹å³æ ‡è®° `failed`ï¼Œè®©å‰ç«¯é€šè¿‡è¶…æ—¶æ£€æµ‹è§¦å‘é‡è¯•

---

### 10.5.3 check-taskï¼ˆçŠ¶æ€æŸ¥è¯¢ï¼‰

**èŒè´£**ï¼šæŸ¥è¯¢ä»»åŠ¡çŠ¶æ€ï¼Œæ”¯æŒæ‰¹é‡æŸ¥è¯¢

```typescript
// supabase/functions/check-task/index.ts

import { createClient } from "https://esm.sh/@supabase/supabase-js@2";

// CORS å“åº”å¤´
const corsHeaders = {
  "Access-Control-Allow-Origin": "*",
  "Access-Control-Allow-Headers": "authorization, x-client-info, apikey, content-type",
  "Access-Control-Allow-Methods": "GET, POST, OPTIONS",
};

Deno.serve(async (req) => {
  // å¤„ç† CORS é¢„æ£€è¯·æ±‚
  if (req.method === "OPTIONS") {
    return new Response(null, { headers: corsHeaders });
  }

  try {
    // åˆå§‹åŒ– Supabase å®¢æˆ·ç«¯
    const supabaseUrl = Deno.env.get("SUPABASE_URL")!;
    const supabaseKey = Deno.env.get("SUPABASE_SERVICE_ROLE_KEY")!;
    const supabase = createClient(supabaseUrl, supabaseKey);

    let taskIds: string[] = [];

    // æ”¯æŒ GET å’Œ POST ä¸¤ç§æ–¹å¼
    if (req.method === "GET") {
      // GET: ä» URL å‚æ•°è·å–
      const url = new URL(req.url);
      const taskIdParam = url.searchParams.get("taskIds");
      const singleTaskId = url.searchParams.get("taskId");
      
      if (taskIdParam) {
        taskIds = taskIdParam.split(",").map(id => id.trim());
      } else if (singleTaskId) {
        taskIds = [singleTaskId];
      }
    } else if (req.method === "POST") {
      // POST: ä»è¯·æ±‚ä½“è·å–
      const body = await req.json();
      if (Array.isArray(body.taskIds)) {
        taskIds = body.taskIds;
      } else if (body.taskId) {
        taskIds = [body.taskId];
      }
    }

    if (taskIds.length === 0) {
      return new Response(
        JSON.stringify({ error: "No taskIds provided" }),
        { status: 400, headers: { ...corsHeaders, "Content-Type": "application/json" } }
      );
    }

    // é™åˆ¶å•æ¬¡æŸ¥è¯¢æ•°é‡
    if (taskIds.length > 100) {
      return new Response(
        JSON.stringify({ error: "Too many taskIds, maximum is 100" }),
        { status: 400, headers: { ...corsHeaders, "Content-Type": "application/json" } }
      );
    }

    // æŸ¥è¯¢ä»»åŠ¡çŠ¶æ€
    const { data: tasks, error: queryError } = await supabase
      .from("async_tasks")
      .select(`
        id,
        task_type,
        status,
        trigger_id,
        result_data,
        error_message,
        retry_count,
        created_at,
        last_triggered_at,
        started_at,
        finished_at
      `)
      .in("id", taskIds);

    if (queryError) {
      console.error("[check-task] Query error:", queryError);
      return new Response(
        JSON.stringify({ error: "Failed to query tasks", details: queryError.message }),
        { status: 500, headers: { ...corsHeaders, "Content-Type": "application/json" } }
      );
    }

    // æ„å»ºç»“æœï¼ˆåŒ…å«æœªæ‰¾åˆ°çš„ä»»åŠ¡ï¼‰
    const results = taskIds.map((taskId) => {
      const task = tasks?.find((t) => t.id === taskId);
      if (task) {
        return {
          taskId: task.id,
          taskType: task.task_type,
          status: task.status,
          triggerId: task.trigger_id,
          result: task.result_data,
          error: task.error_message,
          retryCount: task.retry_count,
          createdAt: task.created_at,
          lastTriggeredAt: task.last_triggered_at,
          startedAt: task.started_at,
          finishedAt: task.finished_at,
        };
      } else {
        return {
          taskId,
          status: "not_found",
          error: "Task not found",
        };
      }
    });

    return new Response(
      JSON.stringify({ tasks: results }),
      { status: 200, headers: { ...corsHeaders, "Content-Type": "application/json" } }
    );

  } catch (error) {
    console.error("[check-task] Unexpected error:", error);
    return new Response(
      JSON.stringify({ error: "Internal server error", details: error.message }),
      { status: 500, headers: { ...corsHeaders, "Content-Type": "application/json" } }
    );
  }
});
```

**å…³é”®ç‚¹**ï¼š
1. æ”¯æŒ GET å’Œ POST ä¸¤ç§æŸ¥è¯¢æ–¹å¼
2. æ”¯æŒæ‰¹é‡æŸ¥è¯¢ï¼ˆå•æ¬¡æœ€å¤š 100 ä¸ªï¼‰
3. è¿”å›å®Œæ•´çš„ä»»åŠ¡ä¿¡æ¯ï¼ŒåŒ…æ‹¬æ—¶é—´æˆ³ç”¨äºè¶…æ—¶æ£€æµ‹

---

### 10.5.4 retrigger-taskï¼ˆé‡æ–°è§¦å‘ï¼‰

**èŒè´£**ï¼šé‡æ–°è§¦å‘å¤±è´¥æˆ–è¶…æ—¶çš„ä»»åŠ¡

```typescript
// supabase/functions/retrigger-task/index.ts

import { createClient } from "https://esm.sh/@supabase/supabase-js@2";

// æœ€å¤§é‡è¯•æ¬¡æ•°
const MAX_RETRY_COUNT = 5;

// ç”Ÿæˆ UUID
function generateUUID(): string {
  return crypto.randomUUID();
}

// CORS å“åº”å¤´
const corsHeaders = {
  "Access-Control-Allow-Origin": "*",
  "Access-Control-Allow-Headers": "authorization, x-client-info, apikey, content-type",
  "Access-Control-Allow-Methods": "POST, OPTIONS",
};

Deno.serve(async (req) => {
  // å¤„ç† CORS é¢„æ£€è¯·æ±‚
  if (req.method === "OPTIONS") {
    return new Response(null, { headers: corsHeaders });
  }

  // åˆå§‹åŒ– Supabase å®¢æˆ·ç«¯
  const supabaseUrl = Deno.env.get("SUPABASE_URL")!;
  const supabaseKey = Deno.env.get("SUPABASE_SERVICE_ROLE_KEY")!;
  const supabase = createClient(supabaseUrl, supabaseKey);

  try {
    // 1. è§£æè¯·æ±‚å‚æ•°
    const body = await req.json();
    const { taskId, reason } = body;

    if (!taskId) {
      return new Response(
        JSON.stringify({ error: "taskId is required" }),
        { status: 400, headers: { ...corsHeaders, "Content-Type": "application/json" } }
      );
    }

    console.log(`[retrigger-task] Retriggering task: ${taskId}, reason: ${reason || 'not specified'}`);

    // 2. è·å–ä»»åŠ¡å½“å‰çŠ¶æ€
    const { data: task, error: fetchError } = await supabase
      .from("async_tasks")
      .select("*")
      .eq("id", taskId)
      .single();

    if (fetchError || !task) {
      console.error(`[retrigger-task] Task not found: ${taskId}`);
      return new Response(
        JSON.stringify({ error: "Task not found" }),
        { status: 404, headers: { ...corsHeaders, "Content-Type": "application/json" } }
      );
    }

    // 3. æ£€æŸ¥æ˜¯å¦å·²å®Œæˆæˆ–å·²å¤±è´¥
    if (task.status === "done") {
      console.log(`[retrigger-task] Task ${taskId} is already done, skipping retrigger`);
      return new Response(
        JSON.stringify({ 
          success: false, 
          reason: "already_done",
          message: "Task is already completed" 
        }),
        { status: 200, headers: { ...corsHeaders, "Content-Type": "application/json" } }
      );
    }

    if (task.status === "failed") {
      console.log(`[retrigger-task] Task ${taskId} is already failed, skipping retrigger`);
      return new Response(
        JSON.stringify({ 
          success: false, 
          reason: "already_failed",
          message: "Task has already failed" 
        }),
        { status: 200, headers: { ...corsHeaders, "Content-Type": "application/json" } }
      );
    }

    // 4. æ£€æŸ¥é‡è¯•æ¬¡æ•°
    const newRetryCount = (task.retry_count || 0) + 1;
    
    if (newRetryCount > MAX_RETRY_COUNT) {
      console.log(`[retrigger-task] Task ${taskId} exceeded max retry count (${MAX_RETRY_COUNT}), marking as failed`);
      
      // æ ‡è®°ä¸ºå¤±è´¥
      await supabase
        .from("async_tasks")
        .update({
          status: "failed",
          error_message: `Exceeded maximum retry count (${MAX_RETRY_COUNT})`,
          finished_at: new Date().toISOString(),
        })
        .eq("id", taskId);

      return new Response(
        JSON.stringify({ 
          success: false, 
          reason: "max_retries_exceeded",
          message: `Task exceeded maximum retry count (${MAX_RETRY_COUNT})`,
          retryCount: newRetryCount,
        }),
        { status: 200, headers: { ...corsHeaders, "Content-Type": "application/json" } }
      );
    }

    // 5. ç”Ÿæˆæ–°çš„ trigger_id
    const newTriggerId = generateUUID();

    // 6. æ›´æ–°ä»»åŠ¡çŠ¶æ€ï¼Œé‡ç½®ä¸º pending
    const { error: updateError } = await supabase
      .from("async_tasks")
      .update({
        status: "pending",
        trigger_id: newTriggerId,
        retry_count: newRetryCount,
        last_triggered_at: new Date().toISOString(),
        started_at: null, // æ¸…é™¤å¼€å§‹æ—¶é—´
        error_message: null, // æ¸…é™¤ä¹‹å‰çš„é”™è¯¯
      })
      .eq("id", taskId);

    if (updateError) {
      console.error(`[retrigger-task] Failed to update task ${taskId}:`, updateError);
      return new Response(
        JSON.stringify({ error: "Failed to update task", details: updateError.message }),
        { status: 500, headers: { ...corsHeaders, "Content-Type": "application/json" } }
      );
    }

    console.log(`[retrigger-task] Task ${taskId} reset to pending, new triggerId: ${newTriggerId}, retryCount: ${newRetryCount}`);

    // 7. å¼‚æ­¥è§¦å‘ process-task
    const processTaskUrl = `${supabaseUrl}/functions/v1/process-task`;

    // @ts-ignore - EdgeRuntime æ˜¯ Supabase Edge Function ç‰¹æœ‰çš„å…¨å±€å¯¹è±¡
    EdgeRuntime.waitUntil(
      fetch(processTaskUrl, {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "Authorization": `Bearer ${supabaseKey}`,
        },
        body: JSON.stringify({
          taskId: taskId,
          triggerId: newTriggerId,
        }),
      }).catch((error) => {
        console.error(`[retrigger-task] Failed to trigger process-task:`, error);
      })
    );

    // 8. è¿”å›æˆåŠŸ
    return new Response(
      JSON.stringify({
        success: true,
        taskId: taskId,
        triggerId: newTriggerId,
        retryCount: newRetryCount,
        message: "Task retriggered successfully",
      }),
      { status: 200, headers: { ...corsHeaders, "Content-Type": "application/json" } }
    );

  } catch (error) {
    console.error("[retrigger-task] Unexpected error:", error);
    return new Response(
      JSON.stringify({ error: "Internal server error", details: error.message }),
      { status: 500, headers: { ...corsHeaders, "Content-Type": "application/json" } }
    );
  }
});
```

**å…³é”®ç‚¹**ï¼š
1. æ£€æŸ¥ä»»åŠ¡æ˜¯å¦å·²å®Œæˆæˆ–å·²å¤±è´¥
2. æ£€æŸ¥é‡è¯•æ¬¡æ•°æ˜¯å¦è¶…é™ï¼Œè¶…é™åˆ™æ ‡è®°ä¸º `failed`
3. ç”Ÿæˆæ–°çš„ `trigger_id`ï¼Œä½¿æ—§çš„å¤„ç†å®ä¾‹å¤±æ•ˆ
4. é‡ç½®çŠ¶æ€ä¸º `pending`ï¼Œå¼‚æ­¥è§¦å‘æ–°çš„å¤„ç†

---

## 10.6 å‰ç«¯å·¥å…·å‡½æ•°è§„èŒƒ

### 10.6.1 é‡è¯•å·¥å…·å‡½æ•°

```typescript
// src/shared/lib/retry.ts

/**
 * é‡è¯•é…ç½®é€‰é¡¹
 */
export interface RetryOptions {
  /** æœ€å¤§é‡è¯•æ¬¡æ•°ï¼ˆä¸åŒ…æ‹¬é¦–æ¬¡å°è¯•ï¼‰ */
  maxRetries: number;
  /** åˆå§‹å»¶è¿Ÿæ—¶é—´ï¼ˆæ¯«ç§’ï¼‰ */
  baseDelay: number;
  /** æœ€å¤§å»¶è¿Ÿæ—¶é—´ï¼ˆæ¯«ç§’ï¼‰ */
  maxDelay: number;
  /** é€€é¿ä¹˜æ•° */
  backoffMultiplier: number;
  /** å¯é‡è¯•çš„é”™è¯¯ç±»å‹ï¼ˆæ­£åˆ™åŒ¹é…é”™è¯¯æ¶ˆæ¯ï¼‰ */
  retryableErrors?: RegExp[];
  /** é‡è¯•å‰çš„å›è°ƒ */
  onRetry?: (error: Error, attempt: number, delay: number) => void;
}

/**
 * é»˜è®¤é‡è¯•é…ç½®
 */
const DEFAULT_RETRY_OPTIONS: RetryOptions = {
  maxRetries: 3,
  baseDelay: 1000,
  maxDelay: 30000,
  backoffMultiplier: 2,
  retryableErrors: [
    /network/i,
    /timeout/i,
    /ECONNRESET/i,
    /ECONNREFUSED/i,
    /fetch failed/i,
    /502/,
    /503/,
    /504/,
  ],
};

/**
 * åˆ¤æ–­é”™è¯¯æ˜¯å¦å¯é‡è¯•
 */
function isRetryableError(error: Error, patterns?: RegExp[]): boolean {
  if (!patterns || patterns.length === 0) {
    return true; // é»˜è®¤æ‰€æœ‰é”™è¯¯éƒ½å¯é‡è¯•
  }
  const message = error.message || '';
  return patterns.some(pattern => pattern.test(message));
}

/**
 * è®¡ç®—é‡è¯•å»¶è¿Ÿï¼ˆæŒ‡æ•°é€€é¿ + æŠ–åŠ¨ï¼‰
 */
function calculateDelay(
  attempt: number,
  baseDelay: number,
  maxDelay: number,
  multiplier: number
): number {
  const exponentialDelay = baseDelay * Math.pow(multiplier, attempt);
  const jitter = Math.random() * baseDelay; // æ·»åŠ æŠ–åŠ¨é˜²æ­¢æƒŠç¾¤æ•ˆåº”
  return Math.min(exponentialDelay + jitter, maxDelay);
}

/**
 * å¸¦é‡è¯•çš„å¼‚æ­¥å‡½æ•°æ‰§è¡Œå™¨
 * 
 * @example
 * ```typescript
 * const result = await withRetry(
 *   () => fetch('/api/data'),
 *   { maxRetries: 3, baseDelay: 1000 }
 * );
 * ```
 */
export async function withRetry<T>(
  fn: () => Promise<T>,
  options: Partial<RetryOptions> = {}
): Promise<T> {
  const config = { ...DEFAULT_RETRY_OPTIONS, ...options };
  let lastError: Error | null = null;

  for (let attempt = 0; attempt <= config.maxRetries; attempt++) {
    try {
      return await fn();
    } catch (error) {
      lastError = error as Error;

      // æ£€æŸ¥æ˜¯å¦è¾¾åˆ°æœ€å¤§é‡è¯•æ¬¡æ•°
      if (attempt === config.maxRetries) {
        break;
      }

      // æ£€æŸ¥æ˜¯å¦æ˜¯å¯é‡è¯•çš„é”™è¯¯
      if (!isRetryableError(lastError, config.retryableErrors)) {
        break;
      }

      // è®¡ç®—å»¶è¿Ÿ
      const delay = calculateDelay(
        attempt,
        config.baseDelay,
        config.maxDelay,
        config.backoffMultiplier
      );

      // å›è°ƒé€šçŸ¥
      config.onRetry?.(lastError, attempt + 1, delay);

      // ç­‰å¾…
      await new Promise(resolve => setTimeout(resolve, delay));
    }
  }

  throw lastError;
}
```

---

### 10.6.2 å¹¶å‘æ§åˆ¶å·¥å…·å‡½æ•°

```typescript
// src/shared/lib/concurrency.ts

/**
 * å¹¶å‘æ§åˆ¶é€‰é¡¹
 */
export interface ConcurrencyOptions {
  /** æœ€å¤§å¹¶å‘æ•° */
  maxConcurrency: number;
  /** æ¯ä¸ªä»»åŠ¡å®Œæˆåçš„å›è°ƒ */
  onItemComplete?: (index: number, total: number) => void;
  /** ä»»åŠ¡å¤±è´¥æ—¶æ˜¯å¦ç»§ç»­æ‰§è¡Œå‰©ä½™ä»»åŠ¡ */
  continueOnError?: boolean;
}

/**
 * å¹¶å‘æ‰§è¡Œå¼‚æ­¥ä»»åŠ¡
 * 
 * @description æ§åˆ¶åŒæ—¶æ‰§è¡Œçš„ä»»åŠ¡æ•°é‡ï¼Œé˜²æ­¢èµ„æºè€—å°½
 * 
 * @example
 * ```typescript
 * const results = await executeWithConcurrency(
 *   [1, 2, 3, 4, 5],
 *   async (item) => {
 *     const response = await fetch(`/api/item/${item}`);
 *     return response.json();
 *   },
 *   { maxConcurrency: 2 }
 * );
 * ```
 */
export async function executeWithConcurrency<T, R>(
  items: T[],
  processor: (item: T, index: number) => Promise<R>,
  options: ConcurrencyOptions
): Promise<R[]> {
  const { maxConcurrency, onItemComplete, continueOnError = false } = options;
  const results: R[] = new Array(items.length);
  const errors: (Error | null)[] = new Array(items.length).fill(null);
  
  let currentIndex = 0;
  let completedCount = 0;

  async function processNext(): Promise<void> {
    while (currentIndex < items.length) {
      const index = currentIndex++;
      const item = items[index];

      try {
        results[index] = await processor(item, index);
      } catch (error) {
        errors[index] = error as Error;
        if (!continueOnError) {
          throw error;
        }
      } finally {
        completedCount++;
        onItemComplete?.(completedCount, items.length);
      }
    }
  }

  // åˆ›å»ºå¹¶å‘å·¥ä½œçº¿ç¨‹
  const workers = Array.from(
    { length: Math.min(maxConcurrency, items.length) },
    () => processNext()
  );

  await Promise.all(workers);

  // æ£€æŸ¥æ˜¯å¦æœ‰é”™è¯¯
  if (continueOnError) {
    const firstError = errors.find(e => e !== null);
    if (firstError) {
      console.warn(`Some tasks failed:`, errors.filter(e => e !== null));
    }
  }

  return results;
}

/**
 * æ‰¹æ¬¡å¤„ç†
 * 
 * @description å°†å¤§é‡ä»»åŠ¡åˆ†æ‰¹å¤„ç†ï¼Œæ¯æ‰¹ä¹‹é—´æœ‰å»¶è¿Ÿ
 */
export async function processBatches<T, R>(
  items: T[],
  batchSize: number,
  processor: (batch: T[], batchIndex: number) => Promise<R[]>,
  options: {
    delayBetweenBatches?: number;
    onBatchComplete?: (batchIndex: number, totalBatches: number) => void;
  } = {}
): Promise<R[]> {
  const { delayBetweenBatches = 0, onBatchComplete } = options;
  const results: R[] = [];
  const totalBatches = Math.ceil(items.length / batchSize);

  for (let i = 0; i < totalBatches; i++) {
    const start = i * batchSize;
    const batch = items.slice(start, start + batchSize);
    
    const batchResults = await processor(batch, i);
    results.push(...batchResults);
    
    onBatchComplete?.(i + 1, totalBatches);

    // æ‰¹æ¬¡é—´å»¶è¿Ÿï¼ˆæœ€åä¸€æ‰¹ä¸éœ€è¦ï¼‰
    if (delayBetweenBatches > 0 && i < totalBatches - 1) {
      await new Promise(resolve => setTimeout(resolve, delayBetweenBatches));
    }
  }

  return results;
}
```

---

## 10.7 å‰ç«¯è½®è¯¢é€»è¾‘è§„èŒƒ

### 10.7.1 æ ¸å¿ƒè½®è¯¢å®ç°

```typescript
// src/core/services/asyncTaskService.ts

import { withRetry } from '@/shared/lib/retry';
import { executeWithConcurrency } from '@/shared/lib/concurrency';

// ==================== é…ç½®å¸¸é‡ ====================

/** è½®è¯¢é—´éš” */
const POLL_INTERVAL = 3000;

/** Pending çŠ¶æ€è¶…æ—¶ */
const PENDING_TIMEOUT = 30000;

/** Processing çŠ¶æ€è¶…æ—¶ */
const PROCESSING_TIMEOUT = 120000;

/** æœ€å¤§é‡è¯•æ¬¡æ•° */
const MAX_RETRY_COUNT = 5;

/** å¹¶å‘æäº¤æ•°é‡ */
const CONCURRENCY_LIMIT = 5;

/** æ‰¹æ¬¡é—´å»¶è¿Ÿ */
const BATCH_DELAY = 10000;

// ==================== ç±»å‹å®šä¹‰ ====================

/** ä»»åŠ¡ä¿¡æ¯ */
export interface TaskInfo {
  taskId: string;
  triggerId: string;
  inputData: Record<string, any>;
}

/** ä»»åŠ¡çŠ¶æ€ */
export interface TaskStatus {
  taskId: string;
  status: 'pending' | 'processing' | 'done' | 'failed' | 'not_found';
  triggerId?: string;
  result?: any;
  error?: string;
  retryCount?: number;
  createdAt?: string;
  lastTriggeredAt?: string;
  startedAt?: string;
  finishedAt?: string;
}

/** è½®è¯¢é€‰é¡¹ */
export interface PollOptions {
  /** è½®è¯¢é—´éš”ï¼ˆæ¯«ç§’ï¼‰ */
  pollInterval?: number;
  /** Pending è¶…æ—¶ï¼ˆæ¯«ç§’ï¼‰ */
  pendingTimeout?: number;
  /** Processing è¶…æ—¶ï¼ˆæ¯«ç§’ï¼‰ */
  processingTimeout?: number;
  /** æœ€å¤§é‡è¯•æ¬¡æ•° */
  maxRetryCount?: number;
  /** è¿›åº¦å›è°ƒ */
  onProgress?: (completed: number, total: number, statuses: TaskStatus[]) => void;
  /** å•ä¸ªä»»åŠ¡å®Œæˆå›è°ƒ */
  onTaskComplete?: (status: TaskStatus) => void;
  /** å•ä¸ªä»»åŠ¡å¤±è´¥å›è°ƒ */
  onTaskFailed?: (status: TaskStatus) => void;
  /** å–æ¶ˆä¿¡å· */
  abortSignal?: AbortSignal;
}

// ==================== API å‡½æ•° ====================

/**
 * æäº¤ä»»åŠ¡
 */
async function submitTask(
  baseUrl: string,
  headers: Record<string, string>,
  taskType: string,
  inputData: Record<string, any>
): Promise<TaskInfo> {
  const response = await withRetry(
    () => fetch(`${baseUrl}/functions/v1/submit-task`, {
      method: 'POST',
      headers: { ...headers, 'Content-Type': 'application/json' },
      body: JSON.stringify({ taskType, inputData }),
    }),
    { maxRetries: 3 }
  );

  if (!response.ok) {
    throw new Error(`Submit task failed: ${response.status}`);
  }

  const data = await response.json();
  return {
    taskId: data.taskId,
    triggerId: data.triggerId,
    inputData,
  };
}

/**
 * æ£€æŸ¥ä»»åŠ¡çŠ¶æ€ï¼ˆæ‰¹é‡ï¼‰
 */
async function checkTasks(
  baseUrl: string,
  headers: Record<string, string>,
  taskIds: string[]
): Promise<TaskStatus[]> {
  const response = await withRetry(
    () => fetch(`${baseUrl}/functions/v1/check-task`, {
      method: 'POST',
      headers: { ...headers, 'Content-Type': 'application/json' },
      body: JSON.stringify({ taskIds }),
    }),
    { maxRetries: 3 }
  );

  if (!response.ok) {
    throw new Error(`Check tasks failed: ${response.status}`);
  }

  const data = await response.json();
  return data.tasks;
}

/**
 * é‡æ–°è§¦å‘ä»»åŠ¡
 */
async function retriggerTask(
  baseUrl: string,
  headers: Record<string, string>,
  taskId: string,
  reason: string
): Promise<{ success: boolean; triggerId?: string; retryCount?: number }> {
  try {
    const response = await withRetry(
      () => fetch(`${baseUrl}/functions/v1/retrigger-task`, {
        method: 'POST',
        headers: { ...headers, 'Content-Type': 'application/json' },
        body: JSON.stringify({ taskId, reason }),
      }),
      { maxRetries: 2 }
    );

    if (!response.ok) {
      throw new Error(`Retrigger task failed: ${response.status}`);
    }

    return await response.json();
  } catch (error) {
    console.error(`[retriggerTask] Failed to retrigger task ${taskId}:`, error);
    return { success: false };
  }
}

// ==================== æ ¸å¿ƒè½®è¯¢é€»è¾‘ ====================

/**
 * æ£€æµ‹ä»»åŠ¡æ˜¯å¦è¶…æ—¶
 */
function checkTaskTimeout(
  status: TaskStatus,
  pendingTimeout: number,
  processingTimeout: number
): { isTimeout: boolean; reason: 'pending_timeout' | 'processing_timeout' | null } {
  const now = Date.now();

  if (status.status === 'pending') {
    // æ£€æŸ¥ pending è¶…æ—¶ï¼šä» lastTriggeredAt å¼€å§‹è®¡ç®—
    const triggeredAt = status.lastTriggeredAt 
      ? new Date(status.lastTriggeredAt).getTime() 
      : new Date(status.createdAt!).getTime();
    
    if (now - triggeredAt > pendingTimeout) {
      return { isTimeout: true, reason: 'pending_timeout' };
    }
  }

  if (status.status === 'processing') {
    // æ£€æŸ¥ processing è¶…æ—¶ï¼šä» startedAt å¼€å§‹è®¡ç®—
    const startedAt = status.startedAt 
      ? new Date(status.startedAt).getTime() 
      : new Date(status.lastTriggeredAt!).getTime();
    
    if (now - startedAt > processingTimeout) {
      return { isTimeout: true, reason: 'processing_timeout' };
    }
  }

  return { isTimeout: false, reason: null };
}

/**
 * æ™ºèƒ½è½®è¯¢ä»»åŠ¡çŠ¶æ€ï¼ˆæ ¸å¿ƒå‡½æ•°ï¼‰
 * 
 * @description
 * - æŒç»­è½®è¯¢ç›´åˆ°æ‰€æœ‰ä»»åŠ¡å®Œæˆï¼ˆdone/failedï¼‰
 * - è‡ªåŠ¨æ£€æµ‹è¶…æ—¶å¹¶è§¦å‘é‡è¯•
 * - é‡è¯•æ¬¡æ•°è¾¾åˆ°ä¸Šé™çš„ä»»åŠ¡æ ‡è®°ä¸ºå¤±è´¥
 * - è½®è¯¢æ—¶é—´ä¸è®¾é™ï¼Œä»¥ä»»åŠ¡å®Œæˆä¸ºå‡†
 * 
 * @example
 * ```typescript
 * const results = await pollTasksUntilComplete(
 *   tasks,
 *   'https://xxx.supabase.co',
 *   headers,
 *   {
 *     onProgress: (completed, total) => {
 *       console.log(`Progress: ${completed}/${total}`);
 *     },
 *     onTaskComplete: (status) => {
 *       console.log(`Task ${status.taskId} completed:`, status.result);
 *     },
 *   }
 * );
 * ```
 */
export async function pollTasksUntilComplete(
  tasks: TaskInfo[],
  baseUrl: string,
  headers: Record<string, string>,
  options: PollOptions = {}
): Promise<TaskStatus[]> {
  const {
    pollInterval = POLL_INTERVAL,
    pendingTimeout = PENDING_TIMEOUT,
    processingTimeout = PROCESSING_TIMEOUT,
    maxRetryCount = MAX_RETRY_COUNT,
    onProgress,
    onTaskComplete,
    onTaskFailed,
    abortSignal,
  } = options;

  // è¿½è¸ªæ¯ä¸ªä»»åŠ¡çš„çŠ¶æ€
  const taskMap = new Map<string, TaskStatus>();
  const completedTasks = new Set<string>();
  const failedTasks = new Set<string>();
  const retryingTasks = new Set<string>();

  // åˆå§‹åŒ–ä»»åŠ¡çŠ¶æ€
  tasks.forEach(task => {
    taskMap.set(task.taskId, {
      taskId: task.taskId,
      status: 'pending',
      triggerId: task.triggerId,
    });
  });

  console.log(`[pollTasks] Starting poll for ${tasks.length} tasks`);

  // è½®è¯¢å¾ªç¯ - æŒç»­ç›´åˆ°æ‰€æœ‰ä»»åŠ¡å®Œæˆ
  while (completedTasks.size + failedTasks.size < tasks.length) {
    // æ£€æŸ¥æ˜¯å¦è¢«å–æ¶ˆ
    if (abortSignal?.aborted) {
      console.log('[pollTasks] Polling aborted');
      break;
    }

    // è·å–æœªå®Œæˆçš„ä»»åŠ¡ ID
    const pendingTaskIds = tasks
      .filter(t => !completedTasks.has(t.taskId) && !failedTasks.has(t.taskId))
      .map(t => t.taskId);

    if (pendingTaskIds.length === 0) {
      break;
    }

    try {
      // æ‰¹é‡æŸ¥è¯¢ä»»åŠ¡çŠ¶æ€
      const statuses = await checkTasks(baseUrl, headers, pendingTaskIds);

      // å¤„ç†æ¯ä¸ªä»»åŠ¡çŠ¶æ€
      for (const status of statuses) {
        const previousStatus = taskMap.get(status.taskId);
        taskMap.set(status.taskId, status);

        // å¤„ç†å®Œæˆçš„ä»»åŠ¡
        if (status.status === 'done') {
          if (!completedTasks.has(status.taskId)) {
            completedTasks.add(status.taskId);
            retryingTasks.delete(status.taskId);
            console.log(`[pollTasks] Task ${status.taskId} completed`);
            onTaskComplete?.(status);
          }
          continue;
        }

        // å¤„ç†å¤±è´¥çš„ä»»åŠ¡
        if (status.status === 'failed') {
          if (!failedTasks.has(status.taskId)) {
            failedTasks.add(status.taskId);
            retryingTasks.delete(status.taskId);
            console.error(`[pollTasks] Task ${status.taskId} failed:`, status.error);
            onTaskFailed?.(status);
          }
          continue;
        }

        // æ£€æŸ¥è¶…æ—¶
        const { isTimeout, reason } = checkTaskTimeout(
          status,
          pendingTimeout,
          processingTimeout
        );

        if (isTimeout && reason && !retryingTasks.has(status.taskId)) {
          // æ£€æŸ¥æ˜¯å¦å·²è¶…è¿‡æœ€å¤§é‡è¯•æ¬¡æ•°
          const currentRetryCount = status.retryCount || 0;
          if (currentRetryCount >= maxRetryCount) {
            // æ ‡è®°ä¸ºå¤±è´¥
            failedTasks.add(status.taskId);
            const failedStatus: TaskStatus = {
              ...status,
              status: 'failed',
              error: `Exceeded maximum retry count (${maxRetryCount})`,
            };
            taskMap.set(status.taskId, failedStatus);
            console.error(`[pollTasks] Task ${status.taskId} exceeded max retries`);
            onTaskFailed?.(failedStatus);
            continue;
          }

          // è§¦å‘é‡è¯•
          console.log(`[pollTasks] Task ${status.taskId} timeout (${reason}), retriggering...`);
          retryingTasks.add(status.taskId);

          const retriggerResult = await retriggerTask(
            baseUrl,
            headers,
            status.taskId,
            reason
          );

          if (retriggerResult.success) {
            console.log(`[pollTasks] Task ${status.taskId} retriggered, retry #${retriggerResult.retryCount}`);
          } else {
            console.error(`[pollTasks] Failed to retrigger task ${status.taskId}`);
          }

          retryingTasks.delete(status.taskId);
        }
      }

      // è¿›åº¦å›è°ƒ
      const allStatuses = Array.from(taskMap.values());
      onProgress?.(
        completedTasks.size + failedTasks.size,
        tasks.length,
        allStatuses
      );

    } catch (error) {
      console.error('[pollTasks] Poll error:', error);
      // ç»§ç»­è½®è¯¢ï¼Œä¸ä¸­æ–­
    }

    // ç­‰å¾…ä¸‹ä¸€æ¬¡è½®è¯¢
    if (completedTasks.size + failedTasks.size < tasks.length) {
      await new Promise(resolve => setTimeout(resolve, pollInterval));
    }
  }

  // è¿”å›æœ€ç»ˆç»“æœ
  const finalResults = Array.from(taskMap.values());
  console.log(`[pollTasks] Polling complete. Done: ${completedTasks.size}, Failed: ${failedTasks.size}`);
  
  return finalResults;
}

// ==================== é«˜å±‚ API ====================

/**
 * æ‰¹é‡æäº¤å¹¶ç­‰å¾…ä»»åŠ¡å®Œæˆ
 * 
 * @description å®Œæ•´çš„ä»»åŠ¡å¤„ç†æµç¨‹ï¼šæ‰¹é‡æäº¤ â†’ è½®è¯¢ç­‰å¾… â†’ è¿”å›ç»“æœ
 * 
 * @example
 * ```typescript
 * const results = await submitAndWaitForTasks(
 *   'analyze',
 *   items.map(item => ({ materialId: item.id, imageUrl: item.url })),
 *   'https://xxx.supabase.co',
 *   headers,
 *   {
 *     onProgress: (completed, total) => {
 *       setProgress(Math.round(completed / total * 100));
 *     },
 *   }
 * );
 * ```
 */
export async function submitAndWaitForTasks(
  taskType: string,
  inputDataList: Record<string, any>[],
  baseUrl: string,
  headers: Record<string, string>,
  options: PollOptions & {
    concurrency?: number;
    batchDelay?: number;
  } = {}
): Promise<TaskStatus[]> {
  const { concurrency = CONCURRENCY_LIMIT, batchDelay = BATCH_DELAY, ...pollOptions } = options;

  console.log(`[submitAndWait] Submitting ${inputDataList.length} tasks of type "${taskType}"`);

  // 1. æ‰¹é‡æäº¤ä»»åŠ¡
  const tasks = await executeWithConcurrency(
    inputDataList,
    async (inputData) => {
      return submitTask(baseUrl, headers, taskType, inputData);
    },
    {
      maxConcurrency: concurrency,
      onItemComplete: (completed, total) => {
        console.log(`[submitAndWait] Submitted ${completed}/${total} tasks`);
      },
    }
  );

  console.log(`[submitAndWait] All ${tasks.length} tasks submitted, starting poll...`);

  // 2. è½®è¯¢ç­‰å¾…å®Œæˆ
  const results = await pollTasksUntilComplete(tasks, baseUrl, headers, pollOptions);

  // 3. è¿”å›ç»“æœ
  const successCount = results.filter(r => r.status === 'done').length;
  const failCount = results.filter(r => r.status === 'failed').length;
  console.log(`[submitAndWait] Complete. Success: ${successCount}, Failed: ${failCount}`);

  return results;
}
```

---

## 10.8 React Hook é›†æˆ

### 10.8.1 useAsyncTasks Hook

```typescript
// src/hooks/useAsyncTasks.ts

import { useState, useCallback, useRef } from 'react';
import { 
  TaskStatus, 
  PollOptions,
  submitAndWaitForTasks,
  pollTasksUntilComplete,
} from '@/core/services/asyncTaskService';
import { useSupabaseClient } from '@/hooks/useSupabaseClient';

export interface UseAsyncTasksOptions {
  /** ä»»åŠ¡ç±»å‹ */
  taskType: string;
  /** å®Œæˆåçš„å›è°ƒ */
  onComplete?: (results: TaskStatus[]) => void;
  /** å‡ºé”™æ—¶çš„å›è°ƒ */
  onError?: (error: Error) => void;
}

export interface UseAsyncTasksReturn {
  /** æ˜¯å¦æ­£åœ¨å¤„ç† */
  isProcessing: boolean;
  /** è¿›åº¦ï¼ˆ0-100ï¼‰ */
  progress: number;
  /** å·²å®Œæˆæ•°é‡ */
  completedCount: number;
  /** æ€»ä»»åŠ¡æ•°é‡ */
  totalCount: number;
  /** å½“å‰ä»»åŠ¡çŠ¶æ€åˆ—è¡¨ */
  taskStatuses: TaskStatus[];
  /** é”™è¯¯ä¿¡æ¯ */
  error: Error | null;
  /** æäº¤å¹¶ç­‰å¾…ä»»åŠ¡ */
  submitTasks: (inputDataList: Record<string, any>[]) => Promise<TaskStatus[]>;
  /** å–æ¶ˆä»»åŠ¡ */
  cancel: () => void;
}

export function useAsyncTasks(options: UseAsyncTasksOptions): UseAsyncTasksReturn {
  const { taskType, onComplete, onError } = options;
  const supabase = useSupabaseClient();
  
  const [isProcessing, setIsProcessing] = useState(false);
  const [progress, setProgress] = useState(0);
  const [completedCount, setCompletedCount] = useState(0);
  const [totalCount, setTotalCount] = useState(0);
  const [taskStatuses, setTaskStatuses] = useState<TaskStatus[]>([]);
  const [error, setError] = useState<Error | null>(null);
  
  const abortControllerRef = useRef<AbortController | null>(null);

  const submitTasks = useCallback(async (inputDataList: Record<string, any>[]): Promise<TaskStatus[]> => {
    // é‡ç½®çŠ¶æ€
    setIsProcessing(true);
    setProgress(0);
    setCompletedCount(0);
    setTotalCount(inputDataList.length);
    setTaskStatuses([]);
    setError(null);

    // åˆ›å»ºå–æ¶ˆæ§åˆ¶å™¨
    abortControllerRef.current = new AbortController();

    try {
      // è·å– Supabase é…ç½®
      const baseUrl = supabase.supabaseUrl;
      const { data: { session } } = await supabase.auth.getSession();
      const headers = {
        'Authorization': `Bearer ${session?.access_token || ''}`,
        'apikey': supabase.supabaseKey,
      };

      // æäº¤å¹¶ç­‰å¾…
      const results = await submitAndWaitForTasks(
        taskType,
        inputDataList,
        baseUrl,
        headers,
        {
          abortSignal: abortControllerRef.current.signal,
          onProgress: (completed, total, statuses) => {
            setCompletedCount(completed);
            setTotalCount(total);
            setProgress(Math.round((completed / total) * 100));
            setTaskStatuses(statuses);
          },
        }
      );

      onComplete?.(results);
      return results;

    } catch (err) {
      const error = err as Error;
      setError(error);
      onError?.(error);
      throw error;

    } finally {
      setIsProcessing(false);
      abortControllerRef.current = null;
    }
  }, [taskType, supabase, onComplete, onError]);

  const cancel = useCallback(() => {
    abortControllerRef.current?.abort();
  }, []);

  return {
    isProcessing,
    progress,
    completedCount,
    totalCount,
    taskStatuses,
    error,
    submitTasks,
    cancel,
  };
}
```

### 10.8.2 ä½¿ç”¨ç¤ºä¾‹

```tsx
// src/pages/AnalyzePage.tsx

import { useAsyncTasks } from '@/hooks/useAsyncTasks';
import { Button } from '@/components/ui/button';
import { Progress } from '@/components/ui/progress';

function AnalyzePage() {
  const {
    isProcessing,
    progress,
    completedCount,
    totalCount,
    taskStatuses,
    error,
    submitTasks,
    cancel,
  } = useAsyncTasks({
    taskType: 'analyze',
    onComplete: (results) => {
      const successResults = results.filter(r => r.status === 'done');
      console.log(`åˆ†æå®Œæˆï¼ŒæˆåŠŸ ${successResults.length} ä¸ª`);
    },
  });

  const handleAnalyze = async () => {
    const items = [
      { materialId: '1', imageUrl: 'https://...' },
      { materialId: '2', imageUrl: 'https://...' },
      // ...æ›´å¤šé¡¹ç›®
    ];

    await submitTasks(items);
  };

  return (
    <div className="p-4 space-y-4">
      <div className="flex gap-2">
        <Button 
          onClick={handleAnalyze} 
          disabled={isProcessing}
        >
          å¼€å§‹åˆ†æ
        </Button>
        
        {isProcessing && (
          <Button 
            variant="outline" 
            onClick={cancel}
          >
            å–æ¶ˆ
          </Button>
        )}
      </div>

      {isProcessing && (
        <div className="space-y-2">
          <Progress value={progress} />
          <p className="text-sm text-muted-foreground">
            è¿›åº¦ï¼š{completedCount}/{totalCount} ({progress}%)
          </p>
        </div>
      )}

      {error && (
        <div className="text-destructive">
          é”™è¯¯ï¼š{error.message}
        </div>
      )}

      {/* ä»»åŠ¡çŠ¶æ€åˆ—è¡¨ */}
      <div className="space-y-1">
        {taskStatuses.map(status => (
          <div 
            key={status.taskId}
            className={`text-sm ${
              status.status === 'done' ? 'text-green-600' :
              status.status === 'failed' ? 'text-red-600' :
              'text-muted-foreground'
            }`}
          >
            {status.taskId}: {status.status}
            {status.retryCount ? ` (é‡è¯• ${status.retryCount} æ¬¡)` : ''}
          </div>
        ))}
      </div>
    </div>
  );
}
```

---

## 10.9 æœ€ä½³å®è·µæ€»ç»“

### æ¶æ„åŸåˆ™

| åŸåˆ™ | è¯´æ˜ |
|------|------|
| **å¼‚æ­¥è§£è€¦** | ä»»åŠ¡æäº¤ä¸å¤„ç†åˆ†ç¦»ï¼Œå‰ç«¯ä¸é˜»å¡ç­‰å¾… |
| **çŠ¶æ€æŒä¹…åŒ–** | æ‰€æœ‰çŠ¶æ€å­˜å‚¨åœ¨æ•°æ®åº“ï¼Œå¯è¿½æº¯ã€å¯æ¢å¤ |
| **ä¹è§‚é”ä¿æŠ¤** | ä½¿ç”¨ `trigger_id` é˜²æ­¢é‡å¤å¤„ç† |
| **æ— é™è½®è¯¢** | è½®è¯¢ä¸è®¾æ—¶é—´ä¸Šé™ï¼Œä»¥ä»»åŠ¡å®Œæˆä¸ºå‡† |
| **è‡ªåŠ¨æ¢å¤** | è¶…æ—¶è‡ªåŠ¨é‡è¯•ï¼Œæ— éœ€ç”¨æˆ·å¹²é¢„ |
| **ä¼˜é›…é™çº§** | é‡è¯•æ¬¡æ•°è¾¾ä¸Šé™æ‰æ ‡è®°å¤±è´¥ |

### è¶…æ—¶è®¾ç½®åŸåˆ™

| è¶…æ—¶ç±»å‹ | è®¾ç½®ä¾æ® | å»ºè®®å€¼ |
|----------|----------|--------|
| `PENDING_TIMEOUT` | ä»»åŠ¡è§¦å‘åˆ°å¼€å§‹å¤„ç†çš„æ—¶é—´ | 30ç§’ |
| `PROCESSING_TIMEOUT` | ä»»åŠ¡å¤„ç†çš„æœ€é•¿æ—¶é—´ï¼ˆç•¥å°äº Edge Function é™åˆ¶ï¼‰ | 120ç§’ |
| `EXTERNAL_API_TIMEOUT` | å¤–éƒ¨ API è°ƒç”¨è¶…æ—¶ï¼ˆå°äº `PROCESSING_TIMEOUT`ï¼‰ | 120ç§’ |
| `POLL_INTERVAL` | è½®è¯¢é¢‘ç‡ï¼Œå¹³è¡¡å®æ—¶æ€§å’Œèµ„æºæ¶ˆè€— | 3ç§’ |

### é‡è¯•ç­–ç•¥

| ç­–ç•¥ | è¯´æ˜ |
|------|------|
| **æŒ‡æ•°é€€é¿** | æ¯æ¬¡é‡è¯•å»¶è¿Ÿç¿»å€ï¼Œé¿å…é¢‘ç¹è¯·æ±‚ |
| **éšæœºæŠ–åŠ¨** | æ·»åŠ éšæœºå»¶è¿Ÿï¼Œé˜²æ­¢æƒŠç¾¤æ•ˆåº” |
| **åˆ†å±‚é‡è¯•** | Edge Function å†…éƒ¨é‡è¯• + å‰ç«¯è½®è¯¢é‡è¯• |
| **é‡è¯•ä¸Šé™** | è®¾ç½®æœ€å¤§é‡è¯•æ¬¡æ•°ï¼Œé¿å…æ— é™å¾ªç¯ |

### é”™è¯¯å¤„ç†

| åœºæ™¯ | å¤„ç†æ–¹å¼ |
|------|----------|
| æäº¤å¤±è´¥ | å‰ç«¯ `withRetry` é‡è¯• 3 æ¬¡ |
| è§¦å‘å¤±è´¥ | ä¿æŒ `pending` çŠ¶æ€ï¼Œå‰ç«¯æ£€æµ‹è¶…æ—¶åé‡è¯• |
| å¤„ç†å¤±è´¥ | ä¸ç«‹å³æ ‡è®° `failed`ï¼Œç­‰å¾…å‰ç«¯é‡è¯• |
| é‡è¯•è¶…é™ | æ ‡è®° `failed`ï¼Œè®°å½•é”™è¯¯ä¿¡æ¯ |

---

## 10.10 å®Œæ•´æ£€æŸ¥æ¸…å•

### æ•°æ®åº“

- [ ] åˆ›å»º `async_tasks` è¡¨ï¼ŒåŒ…å«æ‰€æœ‰å¿…è¦å­—æ®µ
- [ ] æ·»åŠ å¿…è¦çš„ç´¢å¼•ï¼ˆstatus, trigger_id, created_atï¼‰
- [ ] è®¾ç½®é€‚å½“çš„ RLS ç­–ç•¥

### Edge Functions

- [ ] `submit-task`: åˆ›å»ºä»»åŠ¡è®°å½•ï¼Œå¼‚æ­¥è§¦å‘å¤„ç†
- [ ] `process-task`: ä¹è§‚é”éªŒè¯ï¼Œæ‰§è¡Œä»»åŠ¡ï¼Œæ›´æ–°ç»“æœ
- [ ] `check-task`: æ”¯æŒæ‰¹é‡æŸ¥è¯¢ï¼Œè¿”å›å®Œæ•´ä¿¡æ¯
- [ ] `retrigger-task`: éªŒè¯çŠ¶æ€ï¼Œæ›´æ–° trigger_idï¼Œé‡æ–°è§¦å‘

### å‰ç«¯

- [ ] `withRetry` å·¥å…·å‡½æ•°ï¼šæŒ‡æ•°é€€é¿ + æŠ–åŠ¨
- [ ] `executeWithConcurrency` å·¥å…·å‡½æ•°ï¼šå¹¶å‘æ§åˆ¶
- [ ] `pollTasksUntilComplete` æ ¸å¿ƒå‡½æ•°ï¼šæ™ºèƒ½è½®è¯¢
- [ ] `useAsyncTasks` Hookï¼šReact é›†æˆ

### é…ç½®

- [ ] `POLL_INTERVAL`: 3ç§’
- [ ] `PENDING_TIMEOUT`: 30ç§’
- [ ] `PROCESSING_TIMEOUT`: 120ç§’ï¼ˆ< Edge Function é™åˆ¶ï¼‰
- [ ] `MAX_RETRY_COUNT`: 5æ¬¡
- [ ] `MAX_POLL_TIME`: æ— é™åˆ¶ï¼ˆInfinityï¼‰

### æµ‹è¯•

- [ ] æµ‹è¯•æ­£å¸¸å®Œæˆæµç¨‹
- [ ] æµ‹è¯• pending è¶…æ—¶é‡è¯•
- [ ] æµ‹è¯• processing è¶…æ—¶é‡è¯•
- [ ] æµ‹è¯•è¾¾åˆ°æœ€å¤§é‡è¯•æ¬¡æ•°
- [ ] æµ‹è¯•å¹¶å‘æäº¤
- [ ] æµ‹è¯•å–æ¶ˆæ“ä½œ

---

## 10.11 å¸¸è§åæ¨¡å¼

### âŒ åæ¨¡å¼ 1ï¼šåŒæ­¥ç­‰å¾… Edge Function å“åº”

```typescript
// âŒ ä¸æ¨èï¼šå‰ç«¯åŒæ­¥ç­‰å¾…é•¿æ—¶é—´æ“ä½œ
const result = await fetch('/functions/v1/process', {
  body: JSON.stringify({ data }),
});
// å¦‚æœå¤„ç†è¶…è¿‡ 30 ç§’ï¼Œè¯·æ±‚ä¼šè¶…æ—¶

// âœ… æ¨èï¼šä½¿ç”¨å¼‚æ­¥ä»»åŠ¡æ¨¡å¼
const { taskId } = await submitTask(data);
const result = await pollUntilComplete(taskId);
```

### âŒ åæ¨¡å¼ 2ï¼šä¸ä½¿ç”¨ä¹è§‚é”

```typescript
// âŒ ä¸æ¨èï¼šå¯èƒ½å¯¼è‡´é‡å¤å¤„ç†
const { data: task } = await supabase
  .from('tasks')
  .update({ status: 'processing' })
  .eq('id', taskId);

// âœ… æ¨èï¼šä½¿ç”¨ trigger_id ä½œä¸ºä¹è§‚é”
const { data: task } = await supabase
  .from('tasks')
  .update({ status: 'processing' })
  .eq('id', taskId)
  .eq('trigger_id', triggerId) // ä¹è§‚é”æ¡ä»¶
  .eq('status', 'pending');    // çŠ¶æ€æ¡ä»¶
```

### âŒ åæ¨¡å¼ 3ï¼šè½®è¯¢è®¾ç½®å›ºå®šä¸Šé™

```typescript
// âŒ ä¸æ¨èï¼šå¯èƒ½åœ¨ä»»åŠ¡å®Œæˆå‰å°±åœæ­¢è½®è¯¢
const MAX_POLL_TIME = 5 * 60 * 1000; // 5åˆ†é’Ÿ
while (Date.now() - startTime < MAX_POLL_TIME) {
  // 5åˆ†é’Ÿååœæ­¢ï¼Œå³ä½¿ä»»åŠ¡è¿˜åœ¨å¤„ç†
}

// âœ… æ¨èï¼šä»¥ä»»åŠ¡å®Œæˆä¸ºå‡†
while (pendingTasks.size > 0 && !abortSignal?.aborted) {
  // æŒç»­è½®è¯¢ç›´åˆ°æ‰€æœ‰ä»»åŠ¡å®Œæˆæˆ–å–æ¶ˆ
}
```

### âŒ åæ¨¡å¼ 4ï¼šå¤„ç†å¤±è´¥ç«‹å³æ ‡è®° failed

```typescript
// âŒ ä¸æ¨èï¼šå¤±å»é‡è¯•æœºä¼š
catch (error) {
  await supabase
    .from('tasks')
    .update({ status: 'failed' })
    .eq('id', taskId);
}

// âœ… æ¨èï¼šåªè®°å½•é”™è¯¯ï¼Œè®©å‰ç«¯å†³å®šæ˜¯å¦é‡è¯•
catch (error) {
  await supabase
    .from('tasks')
    .update({ error_message: error.message })
    .eq('id', taskId);
  // ä¿æŒ processing çŠ¶æ€ï¼Œå‰ç«¯ä¼šæ£€æµ‹è¶…æ—¶å¹¶é‡è¯•
}
```

### âŒ åæ¨¡å¼ 5ï¼šå¿½ç•¥é‡è¯•æ¬¡æ•°é™åˆ¶

```typescript
// âŒ ä¸æ¨èï¼šå¯èƒ½å¯¼è‡´æ— é™é‡è¯•
async function retrigger(taskId: string) {
  await supabase
    .from('tasks')
    .update({ status: 'pending' })
    .eq('id', taskId);
}

// âœ… æ¨èï¼šæ£€æŸ¥é‡è¯•æ¬¡æ•°
async function retrigger(taskId: string) {
  const { data: task } = await supabase
    .from('tasks')
    .select('retry_count')
    .eq('id', taskId)
    .single();

  if (task.retry_count >= MAX_RETRY_COUNT) {
    await supabase
      .from('tasks')
      .update({ status: 'failed' })
      .eq('id', taskId);
    return { success: false, reason: 'max_retries_exceeded' };
  }
  
  // ç»§ç»­é‡è¯•...
}
```
